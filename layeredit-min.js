(()=>{var pol;pol=window.pol,window.pol.layers=window.pol.layers||{},pol.layers.Edit=class{constructor(e){const t=this;function r(){return t.origName!=t.lName()&&t.lName().length>0}function s(){t.filt.ext=null==t.filt.ext?CONFIG.mb.getExtent().map(function(e){return Math.round(1e3*e)/1e3}):null,console.log("Set extent filter: "+t.filt.ext)}function l(){t.filt.zoom=null==t.filt.zoom?CONFIG.mb.getResolution():null,console.log("Set zoom filter: "+t.filt.zoom)}function a(){t.filt.proj=null==t.filt.proj?CONFIG.mb.view.getProjection():null,console.log("Set projection filter: "+(null==t.filt.proj?"null":t.filt.proj.getCode()))}function i(){const e=o(t.lName());if(-1==e)return void alert("ERROR: Unknown layer: "+t.lName());const r=t.createLayer(t.lName(),t.list.myLayers[e]);if(null==r)return!1;r.predicate=t.createFilter(t.filt),r.filt={ext:t.filt.ext,zoom:t.filt.zoom,proj:t.filt.proj};const s=CONFIG.server;if(s&&null!=s&&s.isAuth()){const e={type:t.typeid,name:t.lName(),data:t.layer2obj(r)};s.updateObj("layer",t.index,e,e=>{r.server=!0,m.redraw()})}return!1}function n(){if(-1!=o(t.lName()))return void alert("ERROR: Layer name already used: "+t.lName());const e=t.createLayer(t.lName());if(null==e)return!1;e.predicate=t.createFilter(t.filt),e.filt={ext:t.filt.ext,zoom:t.filt.zoom,proj:t.filt.proj};const r=CONFIG.server;if(r&&null!=r&&r.isAuth()){const s={type:t.typeid,name:t.lName(),data:t.layer2obj(e)};r.putObj("layer",s,t=>{e.index=GETJSON(t),e.server=!0}),CONFIG.mb.addConfiguredLayer(e,t.lName(),!0),t.list.myLayerNames.push({name:t.lName(),type:t.typeid,server:e.server,index:e.index}),t.list.myLayers.push(e),m.redraw()}return t.origName=t.lName(),!1}function o(e){return t._getLayerIdx(e)}t.list=e,t.filt={ext:null,zoom:null,proj:null},t.lName=m.stream(""),t.readonly=!1,this.widget={view:function(){return m("form",[m("div.field",m("span.sleftlab","Name: "),m(pol.ui.textInput,{id:"editLayer",size:16,maxLength:25,value:t.lName,regex:/^[^\<\>\'\"]+$/i})),m("div.field",m("span.sleftlab","Visibility: "),m(pol.ui.checkBox,{id:"vis.extent",onclick:s,checked:null!=t.filt.ext,title:"Check to make layer visible only if it overlaps this extent"},"Map extent",pol.ui.nbsp,pol.ui.nbsp),m(pol.ui.checkBox,{id:"vis.zoom",onclick:l,checked:null!=t.filt.zoom,title:"Check to make layer visible only from this zoom level"},"Zoom level+",pol.ui.nbsp,pol.ui.nbsp),m(pol.ui.checkBox,{id:"vis.proj",onclick:a,checked:null!=t.filt.proj,title:"Check to make layer visible only with this base map projection"},"Base proj.")),m(t.fields),m("div.buttons",[m("button#addButton",{disabled:!t.enabled()||!r(),type:"button",onclick:n,title:"Add layer to list"},"Add"),m("button#updateButton",{disabled:!t.enabled()||r()||t.readonly,type:"button",onclick:i,title:"Update layer"},"Update"),m("button",{type:"reset",onclick:()=>t.reset(),title:"Clear input fields"},"Clear")])])}},this.fields={view:function(){return null}}}_getLayerIdx(e){for(const t in this.list.myLayerNames)if(e===this.list.myLayerNames[t].name)return t;return-1}onclose(){}allowed(){return!0}enabled(){return!1}reset(){this.lName("")}createFilter(e){const t=e;return t?function(){return(null==t.ext||ol.extent.intersects(t.ext,CONFIG.mb.getExtent()))&&(null==t.zoom||t.zoom>=CONFIG.mb.getResolution())&&(null==t.proj||t.proj===CONFIG.mb.view.getProjection())}:null}edit(e){this.lName(e.get("name")),this.filt=e.filt,null==this.filt&&(this.filt={ext:null,zoom:null,proj:null}),$("#vis.extent").prop("checked",null!=this.filt.ext).trigger("change"),$("#vis.zoom").prop("checked",null!=this.filt.zoom).trigger("change"),$("#vis.proj").prop("checked",null!=this.filt.proj).trigger("change")}createLayer(e){return null}removeLayer(e,t){}layer2obj(e){return null}layer2json(e){return JSON.stringify(this.layer2obj(e))}obj2layer(e){return null}json2layer(e){return this.obj2layer(GETJSON(e))}},pol.layers.Dummy=class extends pol.layers.Edit{constructor(e){super(e)}},(()=>{var pol=window.pol;pol.layers.List=class extends pol.core.Widget{constructor(){super(),this.classname="layers.List",this.myLayers=[],this.myLayerNames=[],this.typeList={},this.suspendGet=!1;const e=this;function t(t){return!e.myLayerNames[t].readonly}function r(t){return!e.myLayerNames[t].noremove}function s(t){const r=e.myLayerNames[t];pol.getShareWidget().setIdent(r.index,r.name,"layer",r.type)}function l(t){const r=$("#lType").val(),s=e.layer.lName();e.layer=e.typeList[r].obj,e.layer.lName(s),setTimeout(()=>m.redraw(),100)}function a(t){console.assert(t>=0&&t<e.myLayers.length,"idx="+t);const r=e.myLayerNames[t].name,s=e.myLayerNames[t].type;e.layer=e.typeList[s].obj,e.layer.index=e.myLayerNames[t].index,e.layer.readonly=e.myLayerNames[t].readonly,e.layer.origName=r,e.layer.edit(e.myLayers[t]),$("#lType").val(s).trigger("change"),e.layer.lName(r),m.redraw()}e.addType("_any_","Select layer type..",new pol.layers.Dummy(this)),setTimeout(()=>{null!=CONFIG.server&&CONFIG.server.hasDb&&(e.addType("drawing","Drawing layer",new pol.layers.Drawing(this)),e.addType("gpx","GPX/GeoJSON files upload",new pol.layers.Gpx(this)))},1e3),e.addType("wms","Standard WMS layer",new pol.layers.Wms(this)),e.addType("wfs","Standard WFS layer",new pol.layers.Wfs(this)),e.addType("_any_","Select layer type..",new pol.layers.Dummy(this)),this.layer=e.typeList._any_.obj,this.widget={view:function(){return m("div#layerEdit",[m("h1","My map layers"),m("table.mapLayers",m("tbody",e.myLayerNames.filter(e=>{const t=$("#lType").val();return!t||"_any_"==t||e.type==t}).map(l=>{const i=(n=l.name,e._indexOf(n));var n;return m("tr",[m("td",r(i)?m(pol.ui.removeEdit,{remove:pol.ui.apply(t=>e.removeLayer(t),i),edit:pol.ui.apply(a,i)}):"",t(i)?m("img",{src:"images/16px/user.png",title:"Sharing",onclick:pol.ui.apply(s,i)}):""),m("td",{class:l.server?"onserver":null},l.name)])}))),m("div",[m("div.field",m("span.sleftlab","Type: "),m(pol.ui.select,{id:"lType",onchange:l,list:Object.keys(e.typeList).filter(t=>e.typeList[t].obj.allowed()).map(t=>({label:e.typeList[t].label,val:t,obj:e.typeList[t].obj}))})),m(e.layer.widget)])])}},setTimeout(()=>this.getMyLayers(),1e3),e.authCb=CONFIG.server.addAuthCb(()=>{e.getMyLayers(),CONFIG.server.isAuth()||e.closePopup()})}_indexOf(e){for(const t in this.myLayerNames)if(e===this.myLayerNames[t].name)return t;return-1}onActivate(){this.getMyLayers()}selectType(e){$("#lType").val(e).trigger("change"),this.layer=this.typeList[e].obj,this.layer.lName(""),m.redraw()}suspend(){const e=this;e.suspendGet=!0,setTimeout(()=>{e.suspendGet=!1},2e3)}addType(e,t,r){r.typeid=e,this.typeList[e]={label:t,obj:r}}getLayer(e){let t;for(t of this.myLayers)if(t.get("name")==e)return t;return null}getLayers(){return this.myLayers}isEmpty(){return 0==this.myLayers.length}_clearMyLayers(){for(const e of this.myLayers)CONFIG.mb.removeConfiguredLayer(e);this.myLayers=[],this.myLayerNames=[]}getMyLayers(){const e=this;if(e.suspendGet)return;let t=[];e._clearMyLayers();const r=CONFIG.server;return null!=r&&r.hasDb&&r.getObj("layer",r=>{for(const s of r)if(null!=s){const r=s.data;if(r.data.name=r.name,null==this.typeList[r.type])continue;const l=this.typeList[r.type].obj.obj2layer(r.data);t.push({name:r.name,type:r.type,server:!0,readonly:s.readOnly,noremove:s.noRemove,index:s.id}),e.myLayers.push(l),CONFIG.mb.addConfiguredLayer(l,r.name,!1),this.myLayerNames=t}m.redraw()}),this.myLayerNames=t}removeLayer(e,t){if(!t&&1!=t&&0==confirm("Remove - are you sure?"))return;console.assert(e>=0&&e<this.myLayers.length,"id="+e+", length="+this.myLayers.length);const r=CONFIG.server,s=this.myLayers[e],l=this.typeList[this.myLayerNames[e].type].obj;this.suspend(),r&&null!=r&&r.isAuth()&&r.hasDb&&""!=this.myLayerNames[e].index&&r.removeObj("layer",this.myLayerNames[e].index,t=>{this._removeLayer(e,s,!1),l.removeLayer(s,t>0)})}_removeLayer(e,t,r){null==t&&(t=this.myLayers[e]),this.myLayers.splice(e,1),this.myLayerNames.splice(e,1),null!=t&&CONFIG.mb.removeConfiguredLayer(t)}},pol.widget.setFactory("layers.List",{create:()=>new pol.layers.List})})(),(()=>{var pol=window.pol;pol.layers.Wms=class extends pol.layers.Edit{constructor(e){super(e);const t=this;function r(e){null!=e.checked?e.checked=!e.checked:e.checked=!0}function s(){t.getCapabilities(m.redraw)}function l(){t.selected=$("#sel_srs").val(),null!=t.cap&&t.filterLayers(t.selected)}t.cap=null,t.layers=[],t.sLayers=[],t.srs="",t.selected=this.srs[0],t.url=m.stream(""),t.token=m.stream(""),t.fields={view:function(){return m("div.spec",[m("div.field",m("span.sleftlab","Server: "),m(pol.ui.textInput,{id:"wmsUrl",size:40,maxLength:160,value:t.url,regex:/^.+$/i}),m("button",{type:"button",onclick:s},"Get")),m("div.field",m("span.sleftlab","Token: "),m(pol.ui.textInput,{id:"wmsParams",size:32,maxLength:64,value:t.token,regex:/^.+$/i})),m("div.field",m("span.sleftlab","Projection:"),m(pol.ui.select,{id:"sel_srs",onchange:l,list:t.srs.map(e=>({label:e,val:e,obj:null}))})),null==t.cap?null:m(t.wfields)])}},t.wlayers={view:function(){return m("div#wlayers",t.sLayers.map(e=>m(pol.ui.checkBox,{title:""==e.Abstract?e.Title:e.Abstract,checked:e.checked,id:"layer_"+e.Name,onchange:pol.ui.apply(r,e)},function(e,t){return e.substring(0,t-1)+(e.length>t?"..":"")}(e.Title,32))))}},t.wfields={view:function(){return m("div.wserver",[m("div.field",m("span.sleftlab","Title: "),m("span",{title:t.cap.Service.Abstract},t.cap.Service.Title)),m("div.field",m("span.sleftlab","Layers:"),m(t.wlayers))])}},async function(){t.srs=await CONFIG.get("core.supported_proj"),null==t.srs&&(t.srs=await CONFIG.get("core.projection"))}()}reset(){super.reset(),this.url("")}getCapabilities(e){const t=this;t.layers=[],t.sLayers=[];const r=new ol.format.WMSCapabilities;fetch(this.url()+"?service=wms&request=GetCapabilities").then(e=>e.text()).then(s=>{if(t.cap=r.read(s),t.cap.Capability.Layer.Layer)for(let e in t.cap.Capability.Layer.Layer){const r=t.cap.Capability.Layer.Layer[e];t.layers.push(r)}else t.cap.Capability.Layer&&(t.layers[0]=t.cap.Capability.Layer);null==t.selected&&(t.selected=$("#sel_srs").val()),t.filterLayers(t.selected),e&&e()})}filterLayers(e){const t=this;t.sLayers=[];for(const r in t.layers)for(const s in t.layers[r].CRS)if(t.layers[r].CRS[s]==e){t.sLayers.push(t.layers[r]);break}}enabled(){return this.url().length>1}getReqLayers(){let e="",t=!0;for(let e in this.sLayers)if(this.sLayers[e].checked){let t=this.sLayers[e].Name;if(null!=t)r(t);else for(const t of this.sLayers[e].Layer)r(t.Name)}return e;function r(r){null!=r&&(e+=(t?"":",")+r,t=!1)}}createLayer(e){const t=this.getReqLayers();console.log("Create WMS layer: URL="+this.url()+", layers="+t);var r=new ol.layer.Image({name:e,source:new ol.source.ImageWMS({ratio:1,url:this.url(),params:{LAYERS:t,VERSION:"1.1.1",token:""==this.token()?null:this.token()}})});r.selSrs=this.selected,r.checkList=[];for(let e in this.sLayers)r.checkList[e]={name:this.sLayers[e].Name,checked:this.sLayers[e].checked};return r}edit(e){super.edit(e),console.log("PARAMS",e.getSource().getParams()),this.url(e.getSource().getUrl()),this.token(e.getSource().getParams().token),$("#sel_srs").val(e.selSrs).trigger("change"),this.getCapabilities(()=>{for(let t in this.sLayers)null!=this.sLayers[t]&&this.sLayers[t].Name==e.checkList[t].name&&(this.sLayers[t].checked=e.checkList[t].checked);console.log("EDIT: layers",this.sLayers),m.redraw()})}layer2obj(e){return{filter:e.filt,url:e.getSource().getUrl(),params:e.getSource().getParams(),checked:e.checkList,srs:e.selSrs}}obj2layer(e){if(null==e)return console.warn("WmsLayer.obj2layer: Resulting Layer is null"),null;const t=new ol.layer.Image({source:new ol.source.ImageWMS({ratio:1,url:e.url,params:e.params})});return t.predicate=this.createFilter(e.filter),t.filt=e.filter,t.selSrs=e.srs,t.checkList=e.checked,t}}})(),(()=>{var pol=window.pol;pol.layers.Wfs=class extends pol.layers.Edit{constructor(e){super(e);const t=this;function r(){t.version=!t.version,console.log("t.version=",t.version)}function s(){""!=t.wurl()&&t.getFeatureTypes()}t.wurl=m.stream(""),t.wlabel=m.stream(""),t.version=!1,t.ftypes=[],t.ftype=null,t.fields={view:function(){return m("div.spec",[m("div.field",m("span.sleftlab","WFS URL: "),m(pol.ui.textInput,{id:"wfsUrl",size:40,maxLength:160,value:t.wurl,regex:/^.+$/i})),m("div.field",m("span.sleftlab","Feat. type: "),m(pol.ui.select,{id:"wfsFtype",list:t.ftypes.map(e=>({label:e,val:e,obj:e}))}),m("button#addButton",{type:"button",onclick:s,title:"Get feature-types from server"},"Get")),m("div.field",m("span.sleftlab",{title:"Label text. Use $(attr) to include feature attributes"},"Label: "),m(pol.ui.textInput,{id:"wfsLabel",size:20,maxLength:200,value:t.wlabel,regex:/^.+$/i})),m("div.field",m("span.sleftlab","Style: "),m(pol.ui.select,{id:"wfsStyle",list:Object.keys(CONFIG.getStyles("wfs")).map(e=>({label:e,val:e,obj:CONFIG.styles[e]}))})),m("div.field",m("span.sleftlab","Std version: "),m(pol.ui.checkBox,{id:"stdver",onclick:r,checked:t.version,title:"Check to use old standards version (wfs 1.1.0 / gml 3.1.1)"},"Use old version"))])}}}getFeatureTypes(){fetch(this.wurl()+"?service=WFS&request=GetCapabilities").then(e=>e.text()).then(e=>{this.ftypes=[];const t=$.parseXML(e);$(t).find("FeatureType").each((e,t)=>{this.ftypes.push($(t).find("Name").text())}),null!=this.ftype?setTimeout(()=>$("#wfsFtype").val(this.ftype).trigger("change"),100):this.ftype=this.ftypes[0],m.redraw()})}enabled(){return null==this.ftype&&(this.ftype=$("#wfsFtype").val()),this.wurl()&&null!=this.ftype}createLayer(e){const t=$("#wfsStyle").val();this.ftype=$("#wfsFtype").val(),console.log("Create WFS layer: URL="+this.wurl()+", ftype="+this.ftype+", style="+t+", label="+this.wlabel());const r=createLayer_WFS({name:e,url:this.wurl(),ftype:this.ftype,style:""!=this.wlabel()?SETLABEL(t,this.wlabel()):GETSTYLE(t),newVersion:!this.version});return r.styleId=t,r.label=this.wlabel(),r.version=this.version,r}edit(e){super.edit(e),this.wurl(e.getSource().baseurl),this.ftype=e.getSource().ftype,this.wlabel(e.label),this.version=e.version,setTimeout(()=>$("#wfsStyle").val(e.styleId).trigger("change"),100),this.getFeatureTypes()}reset(){super.reset(),this.wurl(""),this.ftype=null,this.wlabel(""),this.ftypes=[],this.version=!1}layer2obj(e){return{filter:e.filt,url:e.getSource().baseurl,ftype:e.getSource().ftype,oformat:e.getSource().oformat,styleId:e.styleId,label:e.label,verison:e.version}}obj2layer(e){if(null==e)return console.warn("WfsLayer.obj2layer: Layer to be restored is null"),null;const t=createLayer_WFS({url:e.url,ftype:e.ftype,style:e.label&&null!=e.label?SETLABEL(e.styleId,e.label):GETSTYLE(e.styleId),outputFormat:e.oformat,newVersion:!e.version});return t.predicate=this.createFilter(e.filter),t.filt=e.filter,t.styleId=e.styleId,t.label=e.label,t.version=e.version,t}}})(),(()=>{var pol=window.pol;pol.layers.Gpx=class extends pol.layers.Edit{constructor(e){super(e),this.files=[];const t=this;function r(e){let r=[];if(""!=t.lName())for(const s of e.files){let e=!1,l=s.type;if(""==l&&"gpx"==s.name.substr(s.name.lastIndexOf(".")+1)&&(l="application/gpx+xml"),"application/gpx+xml"==l||"application/x-gpx+xml"==l)r.push(s.name);else{if("application/json"!=l){alert("ERROR: Unsupported format: '"+l+"'");continue}e=!0,r.push(s.name)}let a=new FileReader;a.readAsText(s),a.onload=r=>{CONFIG.server.POST("/objects/"+t.subTag(t.lName(),e),r.target.result,r=>{t.files.push({id:r,name:s.name,gjson:e,used:!1}),console.log("File '"+s.name+"' uploaded ok: "+r),m.redraw()},e=>alert("File upload error"))}}else alert("Cannot drop file. Need to enter name of layer first")}t.gpxLab=m.stream(""),this.fields={view:()=>m("div.spec",[m("span.sleftlab","Files: "),m("span.dragdrop",[t.files.map(e=>m("img",{src:"images/32px/file.png",title:e.name})),t.files.length>1?"":"Drop files here..."]),pol.ui.br,m("span.sleftlab","Style: "),m(pol.ui.select,{id:"gpxStyle",list:Object.keys(CONFIG.getStyles("gpx")).map(e=>({label:e,val:e,obj:CONFIG.styles[e]}))}),pol.ui.br,m("span.sleftlab","Label attr: "),m(pol.ui.textInput,{id:"gpxLabel",size:20,maxLength:60,value:t.gpxLab,regex:/^.+$/i}),br]),oncreate:()=>setTimeout(()=>{pol.ui.dragdrop($(".dragdrop").get(0),r)},1e3),onremove:()=>t.cleanup()}}cleanup(){for(const e of this.files)e.used||CONFIG.server.DELETE("/objects/"+this.subTag()+"/"+e.id,null,null);this.files=[]}reset(){super.reset(),this.cleanup()}subTag(e){return encodeURIComponent("gpx."+(void 0===e?this.lName().trim():e))}allowed(){return CONFIG.server.isAuth()}enabled(){return(null==$("#editLayer").attr("ok")||$("#editLayer").attr("ok"))&&this.lName().length>0&&this.files.length>0}createLayer(e,t){const r=$("#gpxStyle").val();console.log("Create GPX/GeoJSON layer: style="+r+", label="+this.gpxLab());return this._createLayer(e,null,r,this.gpxLab(),this.files)}_createLayer(e,t,r,s,l){const a=CONFIG.server.isAuth();let i=[];for(const t of l){const l=createLayer_GPX({url:(a?"":"/open")+"/objects/"+this.subTag(e)+"/"+t.id,style:s&&null!=s?SETLABEL(r,s):GETSTYLE(r),gjson:t.gjson});i.push(l),t.used=!0}let n=new ol.layer.Group({name:e,layers:i});return n.styleId=r,n.label=s,n.files=l.slice(0),n.filt=t,n.predicate=this.createFilter(t),n}removeLayer(e,t){const r=this;for(const r of e.files){const e=s(r);null==e&&t?CONFIG.server.DELETE("/objects/"+this.subTag(this.lName())+"/"+r.id,null,null):null!=e&&(e.used=!1)}function s(e){for(const t of r.files)if(e.id==t.id)return t;return null}}edit(e){super.edit(e),$("#gpxStyle").val(e.styleId).trigger("change"),this.gpxLab(e.label),this.files=e.files.slice(0).splice(0);for(let e of this.files)e.used=!0;m.redraw()}layer2obj(e){return{name:e.name,filt:e.filt,styleId:e.styleId,label:e.label,files:e.files}}obj2layer(e){return null==e?(console.warn("WfsLayer.json2layer: Resulting Layer is null"),null):(e.files||(e.files=[]),this._createLayer(e.name,e.filt,e.styleId,e.label,e.files))}}})(),(()=>{var pol=window.pol;pol.layers.Drawing=class extends pol.layers.Edit{constructor(e){super(e);this.fields={view:function(){return m("span")}}}enabled(){return!0}_createLayer(e,t,r){let s=new ol.source.Vector;null!=r&&(s=r.getSource());const l=new ol.layer.Vector({name:e,source:s});return l.set("drawing",!0,!0),CONFIG.mb.map.on("change:view",()=>{getWIDGET("features.Edit").restoreFeatures(e)}),l.displayInfo=function(e){return[{val:e.label}]},l.filt=t,l.predicate=this.createFilter(t),l}createLayer(e,t){return this._createLayer(e,null,t)}removeLayer(e,t){getWIDGET("features.Edit").removeFeatures(e.get("name"));for(const t of e.getSource().getFeatures())console.log("Remove feature: ",t.index),CONFIG.server.removeObj("layer",t.index,null)}layer2obj(e){return{name:e.get("name"),filt:e.filt}}obj2layer(e){if(null==e)return console.warn("DrawingLayer.obj2layer: Resulting Layer is null"),null;const t=this._createLayer(e.name,e.filt);return getWIDGET("features.Edit").restoreFeatures(e.name),t}}})()})();