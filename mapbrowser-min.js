(()=>{(()=>{window.pol=window.pol||{},window.pol.core=window.pol.core||{},window.pol.widget=window.pol.widget||{},window.pol.ui=window.pol.ui||{},window.pol.mapref=window.pol.mapref||{};var pol=window.pol;console.assert=console.assert||function(){},pol.sleep=t=>new Promise(e=>setTimeout(e,t)),pol.core.Config=class extends ol.Object{constructor(t){super(),this.uid=t||"0",this.mb=null,this.server=null,this.xstorage=null,this.storage=window.localStorage,this.sstorage=window.sessionStorage,this.baseLayers=[],this.oLayers=[],this.oLayersCount=0,this.aMaps=new Array,this.styles={},this.server=null,this.widgets=[],this.props={projection:"EPSG:3857",center:[0,0]}}getStyles(t){let e={};for(const n in this.styles)void 0!==this.styles[n].tag&&this.styles[n].tag.test(t)&&(e[n]=this.styles[n]);return e}getBaseLayers(){return this.baseLayers}getOLayers(){return this.oLayers}addLayer(t,e){return console.assert(null!=t,"layer=null"),e&&null!=e&&t.set("name",e),t.wasOn=!1,t.predicate||(t.predicate=function(){return!0}),this.oLayers.push(t)-1}removeLayer(t){if(console.assert(null!=t,"layer=null"),null!=t)for(const e in this.oLayers)if(this.oLayers[e]===t)return void this.oLayers.splice(e,1)}setUid(t){this.uid=t}setXStorage(t){this.xstorage=t}async get(t){console.assert(null!=t,"id=null");let e=this.sstorage["polaric."+t];if(null==e){const n="polaric."+t+":"+this.uid;e=null!=this.xstorage?await this.xstorage.get(n):this.storage[n]}const n=e?JSON.parse(e):null;return null==n&&null!=this.props[t]?this.props[t]:n}getDefault(t){return console.assert(null!=t,"id=null"),this.props[t]}store(t,e){console.assert(null!=t&&null!=e,"id="+t+", value="+e);const n=JSON.stringify(e),o="polaric."+t+":"+this.uid;null!=this.xstorage?this.xstorage.put(o,n):this.storage[o]=n}storeSes(t,e){console.assert(null!=t&&null!=e,"id="+t+", value="+e);const n=JSON.stringify(e);this.sstorage["polaric."+t]=n}remove(t){console.assert(null!=t,"id=null"),this.sstorage.removeItem("polaric."+t);const e="polaric."+t+":"+this.uid;null!=this.xstorage?this.xstorage.remove(e):this.storage.removeItem(e)}set(t,e){console.assert(null!=t&&null!=e,"id="+t+", value="+e),this.props[t]=e}clear(){this.sstorage.clear(),this.storage.clear()}},window.CONFIG=new pol.core.Config(pol.uid)})(),(()=>{var pol=window.pol;window.pol.security=window.pol.security||{},pol.security.bin2base64=function(t){const e=t=>t.toString(2).padStart(8,0),n=t.length;let o="";for(let s=0;s<=(n-1)/3;s++){let i=3*s+1>=n,a=3*s+2>=n;o+=(e(t[3*s])+e(i?0:t[3*s+1])+e(a?0:t[3*s+2])).match(/.{1,6}/g).map((t,e)=>3==e&&a||2==e&&i?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[+("0b"+t)]).join("")}return o},pol.security.hmac_getKey=async function(t){const e=new TextEncoder("utf-8");return await crypto.subtle.importKey("raw",e.encode(t),{name:"HMAC",hash:"SHA-256"},!1,["sign","verify"])},pol.security.hmac_Sha256_B64=async function(t,e){const n=new TextEncoder("utf-8"),o=await crypto.subtle.sign("HMAC",t,n.encode(e)),s=Array.from(new Uint8Array(o));return pol.security.bin2base64(s)},pol.security.Sha256_B64=async function(t){const e=new TextEncoder("utf-8"),n=await crypto.subtle.digest("SHA-256",e.encode(t)),o=Array.from(new Uint8Array(n));return await pol.security.bin2base64(o)},pol.security.getRandom=function(t){const e=new Uint8Array(t);return crypto.getRandomValues(e),pol.security.bin2base64(e)}})(),(()=>{var pol=window.pol;pol.core.ajax=(t,e,n,o,s)=>$.ajax(e,{type:t,data:n,success:o,error:s,contentType:!1,processData:"POST"!=t,crossDomain:!0,xhrFields:{withCredentials:!1}}),pol.core.Server=class{constructor(){this.origin=window.location.href,this.host=null}async _init(t){let e=await CONFIG.get("server"),n=await CONFIG.get("port"),o=await CONFIG.get("secure");if(1==t){const t=await CONFIG.get("alt_server"),s=await CONFIG.get("alt_port"),i=await CONFIG.get("alt_secure");console.log("ALT SERVER: ",t),null!=t&&(e=t),null!=s&&(n=s),null!=i&&(o=i)}if(null==e){let t=window.location.host,s=window.location.protocol;"http:"==s&&o&&(s="https:"),e="",s&&(e+=s+"//"),e+=t||"localhost",null!=n&&""!=n&&80!=n&&(e+=":"+n)}/.+\:\/\//.test(e)||(e=(o?"https":"http")+"://"+e),"/"!=e.charAt(e.length)&&(e+="/");let s=await CONFIG.get("ajaxprefix");null==s&&(s=""),s.length>0&&"/"!=s.charAt(s.length-1)&&(s+="/"),this.url=e+s,s=await CONFIG.get("wsprefix"),null==s&&(s=""),s.length>0&&"/"!=s.charAt(s.length-1)&&(s+="/");const i=e.split(/:\/\//);this.wsurl="https"===i[0]?"wss":"ws",this.wsurl=this.wsurl+"://"+i[1]+s,this.host=e}popup(name,url,width,height){const u=this.url+url,ctrl="left=50,top=100,width="+width+",height="+height+"resizable=1,scrollbars=1";eval("this."+name+"=window.open('"+u+"','"+name+"','"+ctrl+"');")}getObj(t,e){}putObj(t,e,n){}removeObj(t,e){}updateObj(t,e,n,o){}ajax(t,e,n,o,s,i,a){e&&"/"===e.charAt(0)&&(e=e.substring(1)),this.genHeaders(n).then(r=>$.ajax(this.url+e,{type:t,data:n,success:o,error:s,contentType:null!=i&&i,processData:"POST"!=t,crossDomain:!0,xhrFields:{withCredentials:!0},headers:this.mergeHdrs(r,a)})).catch(t=>{})}mergeHdrs(t,e){let n={};if(null!=t)for(const e in t)n[e]=t[e];if(null!=e)for(const t in e)n[t]=e[t];return n}async genHeaders(t){return null}GET(t,e,n,o,s,i){return this.ajax("GET",t,e,n,o,s,i)}POST(t,e,n,o,s,i){return this.ajax("POST",t,e,n,o,s,i)}POSTFORM(t,e,n,o,s,i){return this.ajax("POST",t,e,n,o,"application/x-www-form-urlencoded",i)}PUT(t,e,n,o,s,i){return this.ajax("PUT",t,e,n,o,s,i)}DELETE(t,e,n,o,s){return this.ajax("DELETE",t,null,e,n,o,s)}}})(),(()=>{function t(t,n){this.lat=t,this.lng=n,this.distance=g,this.toOSRef=y,this.toUTMRef=M,this.WGS84ToOSGB36=w,this.OSGB36ToWGS84=f,this.toString=e}function e(){return"("+Math.round(100*this.lat)/100+", "+Math.round(100*this.lng)/100+")"}function n(t,e){this.easting=t,this.northing=e,this.toLatLng=v,this.toString=o,this.toSixFigureString=s}function o(){return"("+this.easting+", "+this.northing+")"}function s(){var t=Math.floor(this.easting/1e5),e=Math.floor(this.northing/1e5),n="";n=e<5?t<5?"S":"T":e<10?t<5?"N":"O":"H";var o,s=65+5*(4-e%5)+t%5;s>=73&&s++,o=p(s);var i=Math.floor((this.easting-1e5*t)/100),a=Math.floor((this.northing-1e5*e)/100),r=i;i<100&&(r="0"+r),i<10&&(r="0"+r);var l=a;return a<100&&(l="0"+l),a<10&&(l="0"+l),n+o+r+l}function i(t,e,n,o){this.easting=t,this.northing=e,this.latZone=n,this.lngZone=o,this.toLatLng=b,this.toString=a}function a(){return this.lngZone+this.latZone+" "+Math.round(this.easting)+" "+Math.round(this.northing)}function r(t,e){this.maj=t,this.min=e,this.ecc=(t*t-e*e)/(t*t)}function l(t){return Math.sin(t)*Math.sin(t)}function c(t){return Math.tan(t)*Math.tan(t)}function u(t){return 1/Math.cos(t)}function h(t){return t*(Math.PI/180)}function d(t){return t*(180/Math.PI)}function p(t){var e=t.toString(16);return 1==e.length&&(e="0"+e),e="%"+e,unescape(e)}function m(t){var e,n=t.charAt(0);for(e=0;e<256;++e){var o=e.toString(16);if(1==o.length&&(o="0"+o),o="%"+o,(o=unescape(o))==n)break}return e}function g(t){var e=6366.707,n=h(this.lat),o=h(t.lat),s=h(this.lng),i=h(t.lng),a=e*Math.cos(s)*Math.sin(n),r=e*Math.sin(s)*Math.sin(n),l=e*Math.cos(n),c=e*Math.cos(i)*Math.sin(o),u=e*Math.sin(i)*Math.sin(o),d=e*Math.cos(o);return Math.sqrt((a-c)*(a-c)+(r-u)*(r-u)+(l-d)*(l-d))}function f(){var t=new r(6377563.396,6356256.909),e=t.maj,n=(t.min,t.ecc),o=h(this.lat),s=h(this.lng),i=e/Math.sqrt(1-n*l(o)),a=(i+0)*Math.cos(o)*Math.cos(s),c=(i+0)*Math.cos(o)*Math.sin(s),u=((1-n)*i+0)*Math.sin(o),p=-204894e-10,m=h(4172222e-11),g=h(6861111e-11),f=446.448+a*(1+p)+-m*c+g*u,w=h(.00023391666)*a-124.157+c*(1+p)+-m*u,v=542.06+-g*a+m*c+u*(1+p),y=new r(6378137,6356752.3141);e=y.maj,y.min,n=y.ecc;for(var b=d(Math.atan(w/f)),M=Math.sqrt(f*f+w*w),L=Math.atan(v/(M*(1-n))),x=1;x<10;x++)i=e/Math.sqrt(1-n*l(L)),phiN1=Math.atan((v+n*i*Math.sin(L))/M),L=phiN1;var I=d(L);this.lat=I,this.lng=b}function w(){var t=new r(6378137,6356752.3141),e=t.maj,n=(t.min,t.ecc),o=h(this.lat),s=h(this.lng),i=e/Math.sqrt(1-n*l(o)),a=(i+0)*Math.cos(o)*Math.cos(s),c=(i+0)*Math.cos(o)*Math.sin(s),u=((1-n)*i+0)*Math.sin(o),p=204894e-10,m=h(-4172222e-11),g=h(-6861111e-11),f=a*(1+p)-446.448+-m*c+g*u,w=124.157+h(-.00023391666)*a+c*(1+p)+-m*u,v=-g*a-542.06+m*c+u*(1+p),y=new r(6377563.396,6356256.909);e=y.maj,y.min,n=y.ecc;for(var b=d(Math.atan(w/f)),M=Math.sqrt(f*f+w*w),L=Math.atan(v/(M*(1-n))),x=1;x<10;x++)i=e/Math.sqrt(1-n*l(L)),phiN1=Math.atan((v+n*i*Math.sin(L))/M),L=phiN1;var I=d(L);this.lat=I,this.lng=b}function v(){var e,n,o=new r(6377563.396,6356256.909),s=.9996012717,i=-1e5,a=4e5,p=h(49),m=h(-2),g=o.maj,f=o.min,w=o.ecc,v=this.easting,y=this.northing,b=(g-f)/(g+f),M=0,L=(y-i)/(g*s)+p;do{L+=(y-i-(M=f*s*((1+b+5/4*b*b+5/4*b*b*b)*(L-p)-(3*b+3*b*b+21/8*b*b*b)*Math.sin(L-p)*Math.cos(L+p)+(15/8*b*b+15/8*b*b*b)*Math.sin(2*(L-p))*Math.cos(2*(L+p))-35/24*b*b*b*Math.sin(3*(L-p))*Math.cos(3*(L+p)))))/(g*s)}while(y-i-M>=.001);var x=g*s*Math.pow(1-w*l(L),-.5),I=g*s*(1-w)*Math.pow(1-w*l(L),-1.5),N=x/I-1,C=Math.tan(L)/(2*I*x),E=Math.tan(L)/(24*I*Math.pow(x,3))*(5+3*c(L)+N-9*c(L)*N),P=Math.tan(L)/(720*I*Math.pow(x,5))*(61+90*c(L)+45*c(L)*c(L)),O=u(L)/x,G=u(L)/(6*x*x*x)*(x/I+2*c(L)),S=u(L)/(120*Math.pow(x,5))*(5+28*c(L)+24*c(L)*c(L)),_=u(L)/(5040*Math.pow(x,7))*(61+662*c(L)+1320*c(L)*c(L)+720*c(L)*c(L)*c(L));return e=L-C*Math.pow(v-a,2)+E*Math.pow(v-a,4)-P*Math.pow(v-a,6),n=m+O*(v-a)-G*Math.pow(v-a,3)+S*Math.pow(v-a,5)-_*Math.pow(v-a,7),new t(d(e),d(n))}function y(){var t,e=new r(6377563.396,6356256.909),o=.9996012717,s=h(49),i=h(-2),a=e.maj,u=e.min,d=e.ecc,p=h(this.lat),m=h(this.lng),g=(a-u)/(a+u),f=a*o*Math.pow(1-d*l(p),-.5),w=a*o*(1-d)*Math.pow(1-d*l(p),-1.5),v=f/w-1,y=u*o*((1+g+5/4*g*g+5/4*g*g*g)*(p-s)-(3*g+3*g*g+21/8*g*g*g)*Math.sin(p-s)*Math.cos(p+s)+(15/8*g*g+15/8*g*g*g)*Math.sin(2*(p-s))*Math.cos(2*(p+s))-35/24*g*g*g*Math.sin(3*(p-s))*Math.cos(3*(p+s)))+-1e5,b=f/2*Math.sin(p)*Math.cos(p),M=f/24*Math.sin(p)*Math.pow(Math.cos(p),3)*(5-c(p)+9*v),L=f/720*Math.sin(p)*Math.pow(Math.cos(p),5)*(61-58*c(p)+Math.pow(Math.tan(p),4)),x=f*Math.cos(p),I=f/6*Math.pow(Math.cos(p),3)*(f/w-c(p)),N=f/120*Math.pow(Math.cos(p),5)*(5-18*c(p)+Math.pow(Math.tan(p),4)+14*v-58*c(p)*v);return t=y+b*Math.pow(m-i,2)+M*Math.pow(m-i,4)+L*Math.pow(m-i,6),new n(4e5+x*(m-i)+I*Math.pow(m-i,3)+N*Math.pow(m-i,5),t)}function b(){var e=new r(6378137,6356752.314),n=.9996,o=e.maj,s=e.ecc,i=s/(1-s),a=(1-Math.sqrt(1-s))/(1+Math.sqrt(1-s)),l=this.easting-5e5,c=this.northing,u=6*(this.lngZone-1)-180+3;m(this.latZone)-m("N")<0&&(c-=1e7);var h=c/n/(o*(1-s/4-3*s*s/64-5*Math.pow(s,3)/256)),d=h+(3*a/2-27*Math.pow(a,3)/32)*Math.sin(2*h)+(21*a*a/16-55*Math.pow(a,4)/32)*Math.sin(4*h)+151*Math.pow(a,3)/96*Math.sin(6*h),p=o/Math.sqrt(1-s*Math.sin(d)*Math.sin(d)),g=Math.tan(d)*Math.tan(d),f=i*Math.cos(d)*Math.cos(d),w=o*(1-s)/Math.pow(1-s*Math.sin(d)*Math.sin(d),1.5),v=l/(p*n);return new t((d-p*Math.tan(d)/w*(v*v/2-(5+3*g+10*f-4*f*f-9*i)*Math.pow(v,4)/24+(61+90*g+298*f+45*g*g-252*i-3*f*f)*Math.pow(v,6)/720))*(180/Math.PI),u+(v-(1+2*g+f)*Math.pow(v,3)/6+(5-2*f+28*g-3*f*f+8*i+24*g*g)*Math.pow(v,5)/120)/Math.cos(d)*(180/Math.PI))}function M(t,e){var n=new r(6378137,6356752.314),o=.9996,s=n.maj,a=n.ecc,l=this.lng,c=this.lat,u=c*(Math.PI/180),h=l*(Math.PI/180),d=Math.floor((l+180)/6)+1;c>=56&&c<64&&l>=3&&l<12&&(d=32),c>=72&&c<84&&(l>=0&&l<9?d=31:l>=9&&l<21?d=33:l>=21&&l<33?d=35:l>=33&&l<42&&(d=37)),null!=e&&(d=e);var p=(6*(d-1)-180+3)*(Math.PI/180),m=L(c);null!=t&&(m=t);var g=a/(1-a),f=s/Math.sqrt(1-a*Math.sin(u)*Math.sin(u)),w=Math.tan(u)*Math.tan(u),v=g*Math.cos(u)*Math.cos(u),y=Math.cos(u)*(h-p),b=s*((1-a/4-3*a*a/64-5*a*a*a/256)*u-(3*a/8+3*a*a/32+45*a*a*a/1024)*Math.sin(2*u)+(15*a*a/256+45*a*a*a/1024)*Math.sin(4*u)-35*a*a*a/3072*Math.sin(6*u)),M=o*f*(y+(1-w+v)*Math.pow(y,3)/6+(5-18*w+w*w+72*v-58*g)*Math.pow(y,5)/120)+5e5,x=o*(b+f*Math.tan(u)*(y*y/2+(5-w+9*v+4*v*v)*Math.pow(y,4)/24+(61-58*w+w*w+600*v-330*g)*Math.pow(y,6)/720));return c<0&&(x+=1e7),new i(M,x,m,d)}function L(t){return 84>=t&&t>=72?"X":72>t&&t>=64?"W":64>t&&t>=56?"V":56>t&&t>=48?"U":48>t&&t>=40?"T":40>t&&t>=32?"S":32>t&&t>=24?"R":24>t&&t>=16?"Q":16>t&&t>=8?"P":8>t&&t>=0?"N":0>t&&t>=-8?"M":-8>t&&t>=-16?"L":-16>t&&t>=-24?"K":-24>t&&t>=-32?"J":-32>t&&t>=-40?"H":-40>t&&t>=-48?"G":-48>t&&t>=-56?"F":-56>t&&t>=-64?"E":-64>t&&t>=-72?"D":-72>t&&t>=-80?"C":"Z"}pol.core.getUTMLatitudeZoneLetter=L,pol.core.LatLng=t,pol.core.UTMRef=i,window.chr=p})(),(()=>{var pol=window.pol;pol.mapref.formatDM=function(t){const e=Math.floor(Math.abs(t[1])),n=Math.floor(Math.abs(t[0]));return e+"° "+Math.round(6e3*(Math.abs(t[1])-e))/100+"' "+(t[1]<0?"S ":"N ")+"&nbsp;"+n+"° "+Math.round(6e3*(Math.abs(t[0])-n))/100+"' "+(t[0]<0?"W":"E")},pol.mapref.formatDD=function(t){return Math.round(1e4*t[1])/1e4+",&nbsp;"+Math.round(1e4*t[0])/1e4},pol.mapref.formatMaidenhead=function(t){const e=t[0]+180,n=t[1]+90,o=Math.floor(e/20),s=chr(65+o),i=Math.floor(n/10),a=chr(65+i),r=Math.floor(e%20/2),l=chr(48+r),c=Math.floor(n%10),u=chr(48+c),h=Math.floor(e%2*12),d=chr(97+h),p=Math.floor(n%1*24);return s+a+l+u+d+chr(97+p)},pol.mapref.formatUTM=function(t){const e=""+new pol.core.LatLng(t[1],t[0]).toUTMRef();return e.substring(0,5)+'<span class="kartref">'+e.substring(5,8)+"</span>"+e.substring(8,13)+'<span class="kartref">'+e.substring(13,16)+"</span>"+e.substring(16)},pol.mapref.toUTM=function(t){const e=""+new pol.core.LatLng(t[1],t[0]).toUTMRef();return{lngZone:e.substring(0,2),latZone:e.substring(2,3),lng:e.substring(4,10),lat:e.substring(11,18)}},pol.mapref.mgrs=pol.mapref.mgrs||{},pol.mapref.mgrs.latBands="CDEFGHJKLMNPQRSTUVWXX",pol.mapref.mgrs.e100kLetters=["ABCDEFGH","JKLMNPQR","STUVWXYZ"],pol.mapref.mgrs.n100kLetters=["ABCDEFGHJKLMNPQRSTUV","FGHJKLMNPQRSTUVABCDE"],pol.mapref.MGRSprefix=function(t){const e=new pol.core.LatLng(t[1],t[0]),n=e.toUTMRef(),o=n.lngZone,s=pol.mapref.mgrs.latBands.charAt(Math.floor(e.lat/8+10)),i=Math.floor(n.easting/1e5),a=pol.mapref.mgrs.e100kLetters[(o-1)%3].charAt(i-1),r=Math.floor(n.northing/1e5)%20;return o+s+a+pol.mapref.mgrs.n100kLetters[(o-1)%2].charAt(r)},pol.mapref.parseDM=function(t,e,n,o){if(!/^[0-9]{1,2}$/.test(t)||!/^[0-9]{1,3}$/.test(n))return[0,0];const s=parseFloat(t,10),i=parseFloat(e),a=parseFloat(n,10),r=parseFloat(o);return isNaN(s)||s<-90||s>90||isNaN(i)||i<0||i>60||isNaN(a)||isNaN(r)||r<0||r>60?(console.warn("Degrees/minutes out of bounds"),[0,0]):[a+r/60,s+i/60]},pol.mapref.parseUTM=function(t,e,n,o){if(!/^[0-9]{6}$/.test(t)||!/^[0-9]{7}$/.test(e)||!/^[0-9]{2}$/.test(o))return[0,0];const s=parseInt(t,10),i=parseInt(e,10),a=parseInt(o,10);if(isNaN(s)||isNaN(i)||isNaN(a)||s<0||s>999999||i<0||i>9999999||a<0||a>60)return console.warn("UTM zone/northing/easting out of bounds"),[0,0];const r=new pol.core.UTMRef(s,i,n,a).toLatLng(),l=pol.core.getUTMLatitudeZoneLetter(r.lat);return n!=l?(console.warn("Latitude '"+l+"' is outside of given lat zone: '"+n+"'"),[0,0]):[r.lng,r.lat]},pol.mapref.parseMGRS=function(t,e,n,o){if(!/^[0-9]{3}$/.test(n)||!/^[0-9]{3}$/.test(o))return[0,0];let s=parseInt(n,10),i=parseInt(o,10),a=null;if(e&&null!=e&&5==e.length){(e=e.toUpperCase()).length>5&&(e="0"+e);const t=parseInt(e.substring(0,2)),n=pol.mapref.mgrs.e100kLetters[(t-1)%3].indexOf(e[3])+1,o=pol.mapref.mgrs.n100kLetters[(t-1)%2].indexOf(e[4]);0!=n&&-1!=o||console.warn("Invalid row or column letter in MGRS prefix");const r=1e5*n,l=1e5*o,c=8*(pol.mapref.mgrs.latBands.indexOf(e[2])-10);c<-80&&console.warn("Invalid latitude band letter in MGRS prefix");const u=1e5*Math.floor(new pol.core.LatLng(c,0).toUTMRef().northing/1e5);let h=0;for(;h+l+i<u;)h+=2e6;a=new pol.core.UTMRef(r+100*s,h+l+100*i,"X",t).toLatLng()}else{console.warn("invalid MGRS prefix. Using center of map as reference");const e=t.getCenter(),n=new LatLng(e[1],e[0]).toUTMRef(),o=1e5*Math.floor(n.easting/1e5),r=1e5*Math.floor(n.northing/1e5);a=new pol.core.UTMRef(o+100*s,r+100*i,n.latZone,n.lngZone).toLatLng()}return[a.lng,a.lat]}})(),(()=>{var pol=window.pol;pol.core.RotateNorth=class extends ol.control.Control{constructor(t){const e=t||{},n=document.createElement("button");n.innerHTML="N";const o=document.createElement("div");o.className="rotate-north ol-unselectable ol-control",o.appendChild(n),super({element:o,target:e.target}),n.addEventListener("click",this.handleRotateNorth.bind(this),!1)}handleRotateNorth(){this.getMap().getView().setRotation(0)}},pol.core.MapBrowser=class{constructor(t,e){console.assert(t&&null!=t&&e&&null!=e,"targ="+t+", config="+e),this._init(t,e)}async _init(t,e){const n=this;e.mb=this,n.config=e,n.toolbar=new pol.core.Toolbar({},n),n.attribution=new ol.control.Attribution({collapsed:!1}),n.permaLink=!1,n.baseLayerCb=null,n.baseLayerName=null;let o=await n.config.get("_counter_",0);(o<=0||o>600)&&(console.log("Clear local storage"),n.config.clear(),o=0),o++,n.config.store("_counter_",o);let s="core",i=!1;n.baseLayerIdx=await n.config.get(s+".baselayer"),null==n.baseLayerIdx&&(n.baseLayerIdx=await n.config.get(s+".p.baselayer")),null==n.baseLayerIdx?n.baseLayerIdx=0:i=!0,n.baseLayerName=this.config.baseLayers[n.baseLayerIdx].values_.name;let a=await n.config.get(s+".resolution");(null==a||i)&&(a=await n.config.get(s+".p.resolution"));let r=await n.config.get(s+".center");(null==r||i)&&(r=await n.config.get(s+".p.center"));if(""!==window.location.hash){var l=window.location.hash.replace("#map=","").split("/");5===l.length&&(n.permaLink=!0,a=parseFloat(l[0]),r=[parseFloat(l[1]),parseFloat(l[2])],parseFloat(l[3]),n.baseLayerIdx=parseInt(l[4],10))}let c=await n.config.get(s+".projection");(null==c||i)&&(c=await n.config.get(s+".p.projection")),null==c&&(c="EPSG:3857"),n.view=new ol.View({projection:c,center:ol.proj.fromLonLat(r,c),zoom:2}),"EPSG:900913"!=c&&"EPSG:3857"!=c||(setTimeout(()=>n.view.setCenter(ol.proj.fromLonLat(r,c)),50),setTimeout(()=>n.view.setCenter(ol.proj.fromLonLat(r,c)),400)),n.mousepos=new pol.core.MousePos({}),n.map=new ol.Map({target:t,loadTilesWhileInteracting:!0,loadTilesWhileAnimating:!0,controls:[new ol.control.ScaleLine({}),n.mousepos,new ol.control.Zoom({}),new pol.core.RotateNorth,n.toolbar,n.attribution],view:n.view}),n.prevGda=1,n.featureInfo=new pol.core.FeatureInfo(this),n.initializeLayers(e),n.xLayers=[],n.setResolution(a),n.gui=new pol.core.Popup(n),n.ctxMenu=new pol.core.ContextMenu(n.gui),n.toolbar.setDefaultItems(),n.dpm=39.37*function(){var t=document.createElement("div");t.style.width="1in";var e=document.getElementsByTagName("body")[0];e.appendChild(t);var n=document.defaultView.getComputedStyle(t,null).getPropertyValue("width");return e.removeChild(t),parseFloat(n)}(),n.shouldUpdate=!0,window.addEventListener("popstate",t=>{null!==t.state&&(n.config.get("core.projection").then(e=>{map.getView().setCenter(ol.proj.fromLonLat(t.state.center,e))}),map.getView().setResolution(t.state.resolution),map.getView().setRotation(t.state.rotation),shouldUpdate=!1)}),n.map.on("moveend",function(){n.saveView()}),n.map.on("moveend",()=>n.updatePermalink())}saveView(){const t=this;t.config.storeSes("core.projection",t.view.getProjection().getCode()),t.config.storeSes("core.center",ol.proj.toLonLat(t.view.getCenter(),t.view.getProjection())),t.config.storeSes("core.resolution",t.view.getResolution()),t.config.store("core.p.projection",t.view.getProjection().getCode()),t.config.store("core.p.center",ol.proj.toLonLat(t.view.getCenter(),t.view.getProjection())),t.config.store("core.p.resolution",t.view.getResolution())}reset(){t.storage.clear()}setPermalink(t){if(this.permaLink=t,t)this.updatePermalink();else{window.location.hash="";var e=window.location.href;"#"==e[e.length-1]&&(window.location.href=e.substr(0,e.length-1))}}getPermalink(){return this.permaLink}updatePermalink(){if(this.permaLink)if(this.shouldUpdate){var t=ol.proj.toLonLat(this.view.getCenter(),this.view.getProjection()),e="#map="+Math.round(1e3*this.view.getResolution()/1e3)+"/"+Math.round(1e3*t[0])/1e3+"/"+Math.round(1e3*t[1])/1e3+"/"+this.view.getRotation()+"/"+this.baseLayerIdx,n={resolution:this.view.getResolution(),center:t,rotation:this.view.getRotation(),baselayer:this.baseLayerIdx};window.history.pushState(n,"map",e)}else this.shouldUpdate=!0}addContextMenu(t,e){this.ctxMenu.addMenuId("map",t,!1,e)}getBaseLayer(){return this.config.baseLayers[this.baseLayerIdx]}pix2LonLat(t){return ol.proj.toLonLat(this.map.getCoordinateFromPixel(t),this.map.getView().getProjection())}lonLat2Pix(t){return this.map.getPixelFromCoordinate(ol.proj.fromLonLat(t,this.map.getView().getProjection()))}async changeBaseLayer(t){console.assert(t>=0&&t<=this.config.baseLayers.length,"idx="+t);const e=this.config.baseLayers[t];if(this.baseLayerName=e.values_.name,!e||null==e)return;0==this.map.getLayers().getLength()?this.map.addLayer(e):this.map.getLayers().setAt(0,e);let n=e.projection;n||(n=await this.config.get("core.projection")),n||(n=this.view.getProjection()),n!=this.view.getProjection()&&this.changeView(n),null!=this.baseLayerCb&&this.baseLayerCb(e.values_.name),this.config.storeSes("core.baselayer",this.baseLayerIdx=t),this.config.store("core.p.baselayer",this.baseLayerIdx)}setBaseLayerCb(t){this.baseLayerCb=t}initializeLayers(t){if(this.map.getLayers().clear(),this.changeBaseLayer(this.baseLayerIdx),t.oLayers.length>0)for(var e=0;e<t.oLayers.length;e++){const n=t.oLayers[e];null!=n&&(this.featureInfo.registerRecursive(n),this.map.addLayer(n))}}addLayer(t){null!=this.map&&this.map.addLayer(t),null!=this.xLayers&&this.xLayers.push(t)}removeLayer(t){for(var e in this.map.removeLayer(t),this.xLayers)this.xLayers[e]===t&&this.xLayers.splice(e,1)}addVectorLayer(t){const e=new ol.source.Vector({wrapX:!1}),n=new ol.layer.Vector({source:e,style:t});return this.addLayer(n),n}async addConfiguredLayer(t,e,n){console.assert(null!=t&&null!=e,"layer="+t+", name="+e);const o=this.config.addLayer(t,e);let s=await this.config.get("core.olayer."+e);for(var i in null==s&&(s=!1,n&&(s=n),this.config.store("core.olayer."+e,s)),this.config.oLayers[o].setVisible(s),this.xLayers)this.map.removeLayer(this.xLayers[i]);this.featureInfo.registerRecursive(t),this.map.addLayer(t);for(const t in this.xLayers)this.map.addLayer(this.xLayers[t])}removeConfiguredLayer(t){console.assert(null!=t,"layer=null"),null!=t&&(this.featureInfo.unregister(t),this.map.removeLayer(t),this.config.removeLayer(t))}setCenter(t,e){if(e){const n=this.lonLat2Pix(this.getCenter()),o=this.lonLat2Pix(t);if(Math.abs(n[0]-o[0])<e&&Math.abs(n[1]-o[1])<e)return}this.view.setCenter(ol.proj.fromLonLat(t,this.view.getProjection())),this.mousepos.updatePosGeo(t)}getCenter(){return ol.proj.toLonLat(this.view.getCenter(),this.view.getProjection())}getCenterUTM(){const t=this.getCenter();return new pol.core.LatLng(t[1],t[0]).toUTMRef()}getExtent(){const t=this.view.getProjection(),e=this.view.getCenter(),n=this.view.calculateExtent(),o=[e[0],n[3]],s=[e[0],n[1]],i=[n[0],e[1]],a=[n[2],e[1]],r=ol.proj.transform(o,t,"EPSG:4326"),l=ol.proj.transform(s,t,"EPSG:4326"),c=ol.proj.transform(i,t,"EPSG:4326"),u=ol.proj.transform(a,t,"EPSG:4326");return[c[0],l[1],u[0],r[1]]}fitExtent(t){this.view.fit(ol.proj.transformExtent(t,"EPSG:4326",this.view.getProjection()),{size:this.map.getSize(),nearest:!0})}gotoExtent(t){let e=t.baseLayer,n=0;n="string"==typeof e?function(t){const e=CONFIG.baseLayers;for(let n in e)if(t==e[n].get("name"))return n;return 0}(e):e,isNaN(n)||this.changeBaseLayer(n),function(t){if(t&&null!=t)for(const e in CONFIG.oLayers)CONFIG.oLayers[e].setVisible(t[CONFIG.oLayers[e].get("name")])}(t.oLayers),t.extent&&null!=t.extent&&this.fitExtent(t.extent)}getResolution(){return this.view.getResolution()}setResolution(t){this.view.setResolution(t)}getScale(){const t=this.view.getResolution(),e=this.view.getCenter(),n=this.view.getProjection().getMetersPerUnit();return ol.proj.getPointResolution(this.view.getProjection(),t,e)*n*this.dpm}getScaleRounded(){let t=this.getScale();return t>=1e3&&(t=100*Math.round(t/100)),t>=1e4&&(t=1e3*Math.round(t/1e3)),t=t>=1e5?1e4*Math.round(t/1e4):Math.round(t),t}getProjection(){return this.view.getProjection().getCode()}geodeticAdjustment(){if(/EPSG:(900913|3857|4326)/.test(this.view.getProjection().getCode())&&null!=this.view.getCenter()){const t=ol.proj.toLonLat(this.view.getCenter(),this.view.getProjection());return Math.cos(t[1]/180*Math.PI)}return 1}refreshLayers(){!function t(e){e.forEach(e=>{if(e instanceof ol.layer.Vector){var n=e.getSource();n.clear(),n.refresh()}else e instanceof ol.layer.Group&&t(e.getLayers())})}(this.map.getLayers())}changeView(t){if(t==this.view.getProjection())return;this.view;this.view=new ol.View({projection:t,center:ol.proj.transform(this.view.getCenter(),this.view.getProjection(),t),resolution:this.view.getResolution()});const e=this.geodeticAdjustment();e<1&&1==this.prevGda?this.view.setResolution(this.view.getResolution()/e):this.prevGda<1&&1==e&&this.view.setResolution(this.view.getResolution()*this.prevGda),this.prevProj=this.view.getProjection(),this.prevGda=e,this.map.setView(this.view),this.refreshLayers(),this.view.changed()}show_Mapref(t){let e=!1;const n={view:()=>m("div",[m("div.field",m("span.sleftlab","UTM: "),m.trust(pol.mapref.formatUTM(t))),m("div.field",m("span.sleftlab",{onclick:()=>{e=!e,m.redraw()}},"LatLong: "),e?m.trust(pol.mapref.formatDD(t)):m.trust(pol.mapref.formatDM(t))),m("div.field",m("span.sleftlab","Loc: "),m.trust(pol.mapref.formatMaidenhead(t)))])};this.gui.removePopup(),this.gui.showPopup({html:'<div id="mapref"></div>',geoPos:t,image:!0}),m.mount(document.getElementById("mapref"),n)}show_MaprefPix(t){this.show_Mapref(this.pix2LonLat(t))}goto_Pos(t,e){t[0]<=0&&t[1]<=0||(this.setCenter(t),setTimeout(()=>{e?this.show_Mapref(t):this.gui.showImageGeo(t)},200))}}})(),(()=>{var pol=window.pol;pol.widget={},pol.widget._stored={},pol.widget._active={},pol.widget._factory={},pol.widget.setFactory=function(t,e){pol.widget._factory[t]=e},pol.widget.restore=async function(){pol.widget._stored=await CONFIG.get("core.widget._stored"),null==pol.widget._stored&&(pol.widget._stored={});for(const t in pol.widget._stored){if(null==pol.widget._stored[t])continue;const e=pol.widget.get(t);pol.widget._active[t]=e;const n=await CONFIG.get("core.widget."+t);null!=e&&e.activatePopup(t,n,!0);const o=pol.widget._factory[t];o&&o.create?o.onRestore&&null!=o.onRestore&&o.onRestore():(CONFIG.remove("core.widget."+t),delete pol.widget._stored[t],CONFIG.storeSes("core.widget._stored",pol.widget._stored))}},pol.widget.get=function(t,e){let n=pol.widget._active[t];const o=pol.widget._factory[t];return o&&o.create?(n&&null==e||(n=pol.widget._active[t]=o.create()),n):(console.warn("No factory found for: "+t),null)},pol.widget.start=function(t,e,n,o,s,i){const a=pol.widget.get(t,i);if(null==a)return;let r=null!=i?t+"_"+i:t;a.activatePopup(r,e,n,o),s&&null!=s&&setTimeout(()=>s(a),300)},pol.core.Widget=class{constructor(){this.successmsg=null,this.errmsg=null,this.resizable=!1,this.winpos=null,this.saved=!0,this.classname=null,this.domclass=null,this.active=!1,this._allowPopup=!0,this.rs_running=!1,this.rs_to=null,this.rs_func=null,this.rs_first=!0,this.rs_ro=new ResizeObserver(t=>{for(let e of t)this.rs_running&&null!=this.rs_to&&clearTimeout(this.rs_to),this.rs_running=!0,this.rs_to=setTimeout(()=>{1!=this.rs_first?(this.rs_func&&this.rs_func(),this.rs_running=!1,this.rs_to=null):this.rs_first=!1},400)})}successMsg(t,e){this.successmsg=t,this.waitmsg=this.errmsg=null,e>0&&setTimeout(()=>{this.successmsg=null,m.redraw()},e),m.redraw()}errMsg(t,e){this.errmsg=t,this.waitmsg=this.successmsg=null,e>0&&setTimeout(()=>{this.errmsg=null,m.redraw()},e),m.redraw()}waitMsg(t,e){this.waitmsg=t,this.errmsg=this.successmsg=null,e>0&&setTimeout(()=>{this.waitmsg=null,m.redraw()},e),m.redraw()}resizeObserve(t){this.rs_ro.observe($("#map").get(0)),this.rs_func=t}isActive(){return this.active}allowPopup(t){this._allowPopup=t}activate(t){console.assert(t&&null!=t,"w="+t),this.delement=t,m.mount(this.delement,this.widget),this.delement.addEventListener("unload",this.onclose),this.active=!0,this.onActivate&&this.onActivate()}closePopup(){this.active=!1,null!=this.popup&&this.popup.close()}onclose(){this.rs_ro.disconnect()}activatePopup(t,e,n,o){if(console.assert(null!=t&&null!=e&&e[0]>-50&&e[1]>-50,"id="+t+", pixPos="+e),!this._allowPopup)return null;null==e&&(e=[20,20]);const s=this;return this.winpos=e,s.saved=o,s.active=!0,s.onActivate&&s.onActivate(),this.popup=CONFIG.mb.gui.showPopup({vnode:this.widget,pixPos:e,draggable:!0,resizable:this.resizable,dragStop:function(t,e){s.winpos=[e.position.left,e.position.top],i()},pin:function(t){if(!s.saved)return;t?i():a()},pinned:n,id:t,cclass:"widget"+(null==this.domclass?"":" "+this.domclass),onclose:()=>{a(),s.active=!1,s.onclose()}}),this.popup&&null!=this.popup&&this.popup.adjustedPos&&(s.winpos=this.popup.adjustedPos),s.close=()=>{this.popup.close()},this.popup;function i(){CONFIG.storeSes("core.widget."+t,s.winpos),pol.widget._stored[t]&&null!=pol.widget._stored[t]||(pol.widget._stored[t]=!0,CONFIG.storeSes("core.widget._stored",pol.widget._stored))}function a(){CONFIG.remove("core.widget."+t,s.winpos),pol.widget._stored[t]&&null!=pol.widget._stored[t]&&(delete pol.widget._stored[t],CONFIG.storeSes("core.widget._stored",pol.widget._stored))}}setScrollTable(t,e){let n=$("#map").height()-($(t).height()-$(e).height())-this.winpos[1]-8;setTimeout(()=>{$(e).height()<n&&(n=$(e).height()),$(e+" table").table({height:Math.round(n)})},200)}setScroll(t,e,n){let o=$(e);o.css({height:"unset"}),setTimeout(()=>{let e=$("#map").height()-($(t).height()-o.height())-this.winpos[1]-20;if(o.height()>e){const t=o.height();o.css({display:"block","overflow-y":"auto","overflow-x":"hidden",height:""+Math.round(e)}),n&&o.scrollTop(t)}},100)}}})(),window.pol.core.FeatureInfo=class{constructor(t){this.layers=[];const e=this;CONFIG.mb.map.on("click",t=>{!function(t,n,o){let s=[];for(const n of e.layers){const e=CONFIG.mb.map.getFeaturesAtPixel(t,{hitTolerance:3,layerFilter:t=>t==n.layer});if(null==e)continue;let o=null;for(const t of e)t.hide||null!=o&&t.values_==o.values_||(t.handler=n.handler,s.push(t),o=t)}if(0!=s.length)if(s.length>1){const t=o(s);t>=0&&n(s[t])}else n(s[0])}(t.pixel,e=>o.popup(t,e),e=>(n.popup(t,e),-1))}),CONFIG.mb.map.on("movestart",()=>{for(const t of e.layers)t.layer.clearOnMove&&t.layer instanceof ol.layer.Vector&&t.layer.getSource().clear(!0)});const n={list:null,ev:null,view:()=>{let t=0;return m("div",[m("table.items",this.list.map(e=>{const n=e.handler(e),s=t++;return m("tr",m("td",{onclick:t=>{CONFIG.mb.gui.removePopup(),o.popup(this.ev,this.list[s])}},n[0].val))}))])},popup:(t,e)=>{this.list=e,this.ev=t,CONFIG.mb.gui.removePopup(),CONFIG.mb.gui.showPopup({vnode:n,geoPos:CONFIG.mb.pix2LonLat(t.pixel)}),t.stopPropagation()}},o={info:null,view:t=>m("div.featureInfo",[this.info.map(t=>[m("span.field",[t.lbl?m("span.sleftlab",t.lbl+": "):null,"undefined"==t.val?null:t.val])])]),popup:(t,e)=>{this.info=e.handler(e),CONFIG.mb.gui.removePopup(),CONFIG.mb.gui.showPopup({vnode:o,geoPos:CONFIG.mb.pix2LonLat(t.pixel)}),t.stopPropagation()}}}registerRecursive(t){t instanceof ol.layer.Group?t.getLayers().forEach(t=>{this.registerRecursive(t)}):t.displayInfo&&this.layers.push({layer:t,handler:t.displayInfo})}register(t,e){this.layers.push({layer:t,handler:e})}unregister(t){if(t instanceof ol.layer.Group)t.getLayers().forEach(t=>{this.unregister(t)});else for(let e in this.layers)this.layers[e]==t&&this.layers.splice(e,1)}},(()=>{var pol=window.pol;pol.core.Time=class{constructor(t){var e=this;e.handler=t,e.tdate=pol.core.Time.formatDate(new Date),e.ttime=m.stream(pol.core.Time.formatTime(new Date))}static parseDate(t){return new Date(t)}static decrementDay(t){let e=t.getDate();e--,t.setDate(e)}static incrementDay(t){let e=t.getDate();e++,t.setDate(e)}static formatDate(t){return t.getFullYear()+"-"+(t.getMonth()<9?"0":"")+(t.getMonth()+1)+"-"+(t.getDate()<10?"0":"")+t.getDate()}static formatTime(t){return(t.getHours()<10?"0":"")+t.getHours()+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()}static pad(t,e){for(var n=String(t);n.length<e;)n="0"+n;return n}adjust_time(t,e){const n=this.ttime(),[o,s]=n.split(":").map(Number);let i=o+t,a=s+e;if(a>59?(i++,a-=60):a<0&&(i--,a+=60),i>23){let t=new Date(this.tdate);pol.core.Time.incrementDay(t),this.tdate=pol.core.Time.formatDate(t),i=0}else if(i<0){let t=new Date(this.tdate);pol.core.Time.decrementDay(t),this.tdate=pol.core.Time.formatDate(t),i=23}this.ttime(pol.core.Time.pad(i,2)+":"+pol.core.Time.pad(a,2)),this.handler instanceof Function&&this.handler()}decr_minute(){this.adjust_time(0,-1)}incr_minute(){this.adjust_time(0,1)}decr_hour(){this.adjust_time(-1,0)}incr_hour(){this.adjust_time(1,0)}timeIsSet(){return null!=this.tdate&&null!=this.ttime&&""!=this.tdate&&""!=this.ttime&&"-"!=this.tdate&&"-"!=this.ttime}setNow(){const t=new Date;this.tdate=pol.core.Time.formatDate(t),this.ttime(pol.core.Time.formatTime(t))}}})(),(()=>{var pol=window.pol;pol.ui.autojump=function(t,e){if(null==t||null==e)return void console.error("Field id is null");let n=0,o=null;const s=document.getElementById(t);s.nextField=document.getElementById(e),s.onkeydown=function(){n=s.value.length,o=s},s.onkeyup=function(){s==o&&s.value.length>n&&s.value.length>=s.maxLength&&s.nextField.focus();o=null}},pol.ui.apply=function(t,e){return function(){t(e)}},pol.ui.br=m("br"),pol.ui.hr=m("hr"),pol.ui.nbsp=m.trust("&nbsp;");const t={view:function(t){var e=this,n=1==t.attrs.passwd?"password":"text";return m("input#"+t.attrs.id,{type:n,list:t.attrs.list,config:t.attrs.config,size:t.attrs.size,maxLength:t.attrs.maxLength,contentEditable:!t.attrs.contentEditable||t.attrs.contentEditable,oninput:function(e){t.attrs.value(e.target.value),t.attrs.regex&&(t.attrs.regex.test(e.target.value)?(t.state.cssclass="valid",t.dom.title="Input OK",$(t.dom).attr("ok",!0)):(t.state.cssclass="invalid",t.dom.title="Invalid input!",$(t.dom).attr("ok",!1)))},onchange:function(n){t.attrs.value(n.target.value),e.cssclass="",null!=t.attrs.onchange&&t.attrs.onchange()},value:t.attrs.value(),className:e.cssclass?e.cssclass:""})}};pol.ui.textInput=t;const e={view:function(t){return m("span.nobr",{title:t.attrs.title},m("input#"+t.attrs.id,{onclick:t.attrs.onclick,type:"checkbox",name:t.attrs.name,value:t.attrs.id,checked:t.attrs.checked?"checked":null,onchange:t.attrs.onchange}),pol.ui.nbsp,t.children)}};pol.ui.checkBox=e;const n={view:function(t){return m("select#"+t.attrs.id,{onchange:t.attrs.onchange},t.attrs.list.map(t=>m("option",{value:t.val,style:t.style},t.label)))}};pol.ui.select=n;const o={oncreate:function(t){t.state.id=t.attrs.id},doSelect:function(t,e){t.state.selected=e,$("div#iconlist").css("visibility","hidden"),$("div#iconlist").css("max-height","1px"),$("#iconpick").get(0).value=e},showIcons:function(){$("div#iconlist").css("visibility","visible"),$("div#iconlist").css("max-height","")},view:function(t){const e=t.attrs.icons,n=t.attrs.default?t.attrs.default:0,o=t.attrs.value&&null!=t.attrs.value?t.attrs.value:e[n],s=t.state.selected?t.state.selected:o;return setTimeout(()=>{s&&$("#iconpick").get(0)&&($("#iconpick").get(0).value=s)},600),m("span",[m("span#iconpick",{onclick:()=>this.showIcons(),onchange:()=>{t.state.selected=$("#iconpick>img").val()}},m("img",{src:s})),m("div#iconlist",{style:"max-height: 1px"},e.map(e=>m("img",{src:e,onclick:()=>this.doSelect(t,e)})))])}};pol.ui.iconPick=o;const s={oncreate:function(t){const e=document.createElement("input");this.input=e,e.readOnly=!0,e.id=t.attrs.id,e.value=t.attrs.value,t.dom.appendChild(e),flatpickr(e,{enableTime:!1,dateFormat:"Y-m-d"})},onupdate(t){this.input.value=t.attrs.value},onchange:function(t){t.attrs.value=input.value},view:function(t){return m("span.datepick")}};pol.ui.Datepick=s;const i={view:function(t){return m("span.datetime",m(pol.ui.Datepick,{value:t.attrs.tval.tdate,id:t.attrs.id+"_date"}),m(pol.ui.textInput,{id:t.attrs.id+"_time",size:"5",maxLength:"5",value:t.attrs.tval.ttime,regex:/^(([0-1][0-9])|(2[0-3]))\:[0-5][0-9]$/}),m("img",{title:"Set time to now",src:"images/time.png",onclick:()=>t.attrs.tval.setNow()}))}};pol.ui.dateTime=i;const a={view:function(t){const e=t.attrs.tval;return m("span",t.attrs.hour?m("button.tm_fw",{type:"button",title:"Go back 1 hour",onclick:()=>e.decr_hour()},m("img",{src:"images/fback.png",height:"22px"})):null,m("button.tm_fw",{type:"button",title:"Go back 1 minute",onclick:()=>e.decr_minute()},m("img",{src:"images/back.png",height:"22px"})),m("button.tm_fw",{type:"button",title:"Go forward 1 minute",onclick:()=>e.incr_minute()},m("img",{src:"images/forward.png",height:"23px"})),t.attrs.hour?m("button.tm_fw",{type:"button",title:"Go forward 1 hour",onclick:()=>e.incr_hour()},m("img",{src:"images/fforward.png",height:"22px"})):null)}};pol.ui.timeButt=a;pol.ui.mgrsInput=class{constructor(){this.prefix=m.stream(""),this.locx=m.stream(""),this.locy=m.stream(""),CONFIG.mb.map.on("moveend",()=>{this.setPrefix(),this.locx(""),this.locy("")}),this.setPrefix()}setPrefix(){const t=CONFIG.mb.getCenter();this.prefix(pol.mapref.MGRSprefix(t))}onupdate(t){const e=pol.mapref.parseMGRS(CONFIG.mb,this.prefix(),this.locx(),this.locy());t.attrs&&(t.attrs.value[0]=e[0],t.attrs.value[1]=e[1])}view(){return m("span",{onclick:function(){pol.ui.autojump("locx","locy")}},m(pol.ui.textInput,{id:"mgrsprefix",size:"5",maxLength:"5",regex:/^[0-9]{2}[C-X][A-Z][A-V]$/i,value:this.prefix}),pol.ui.nbsp,m(pol.ui.textInput,{id:"locx",size:"3",maxLength:"3",value:this.locx,regex:/^[0-9]{3}$/}),m(pol.ui.textInput,{id:"locy",size:"3",maxLength:"3",value:this.locy,regex:/^[0-9]{3}$/}),pol.ui.nbsp)}};pol.ui.utmInput=class{constructor(){this.lngZone=m.stream(""),this.latZone=m.stream(""),this.lat=m.stream(""),this.lng=m.stream("")}getFromModel(t){if(console.assert(t.attrs.value&&null!=t.attrs.value&&Array.isArray(t.attrs.value),"Model must be array [x,y]"),this.pModel&&t.attrs.value[0]==this.pModel[0]&&t.attrs.value[1]==this.pModel[1])return;this.pModel=t.attrs.value;const e=this.validPoint(this.pModel)?pol.mapref.toUTM(this.pModel):CONFIG.mb.getCenterUTM();this.lngZone(e.lngZone),this.latZone(e.latZone),this.validPoint(this.pModel)?(this.lng(e.lng),this.lat(e.lat)):(this.lng(""),this.lat(""))}validPoint(t){return 0!=t[0]&&0!=t[1]}onupdate(t){const e=pol.mapref.parseUTM(this.lng(),this.lat(),this.latZone(),this.lngZone());t.attrs.value[0]=e[0],t.attrs.value[1]=e[1]}view(t){const e=this;return this.getFromModel(t),m("span",{onclick:function(){pol.ui.autojump("utmz","utmnz"),pol.ui.autojump("utmnz","utmx"),pol.ui.autojump("utmx","utmy")}},m(pol.ui.textInput,{id:"utmz",size:"2",maxLength:"2",value:e.lngZone,regex:/^[0-9]{2}$/}),m(pol.ui.textInput,{id:"utmnz",size:"1",maxLength:"1",value:e.latZone,contentEditable:!1}),pol.ui.nbsp,pol.ui.nbsp,m(pol.ui.textInput,{id:"utmx",size:"6",maxLength:"6",value:e.lng,regex:/^[0-9]{6}$/}),m(pol.ui.textInput,{id:"utmy",size:"7",maxLength:"7",value:e.lat,regex:/^[0-9]{7}$/}),pol.ui.nbsp)}};const r=/^(([0-5]?[0-9])|60)(\.([0-9]{1,4}))?$/;pol.ui.latLngInput=class{constructor(){this.Nd=m.stream(""),this.Nm=m.stream(""),this.Ed=m.stream(""),this.Em=m.stream("")}getFromModel(t){if(this.pModel&&t.attrs.value[0]==this.pModel[0]&&t.attrs.value[1]==this.pModel[1])return;this.pModel=t.attrs.value;const e=Math.floor(t.attrs.value[0]),n=Math.floor(t.attrs.value[1]);this.Ed(""+(e>0?Math.abs(e):"")),this.Em(""+(e>0?Math.abs(Math.round(60*(t.attrs.value[0]-e)*1e3)/1e3):"")),this.Nd(""+(n>0?Math.abs(n):"")),this.Nm(""+(n>0?Math.abs(Math.round(60*(t.attrs.value[1]-n)*100)/100):""))}view(t){const e=CONFIG.mb.getCenter();return this.getFromModel(t),m("span",{onclick:function(){pol.ui.autojump("ll_Nd","ll_Nm"),pol.ui.autojump("ll_Nm","ll_Ed"),pol.ui.autojump("ll_Ed","ll_Em")}},m(pol.ui.textInput,{id:"ll_Nd",size:"2",maxLength:"2",value:this.Nd,regex:/^(([0-8]?[0-9])|90)$/}),"°",pol.ui.nbsp,pol.ui.nbsp,m(pol.ui.textInput,{id:"ll_Nm",size:"6",maxLength:"6",value:this.Nm,regex:r}),"'",pol.ui.nbsp,m("span#ll_NS",{onclick:this.clickNS},e[1]<0?"S":"N"),pol.ui.nbsp,pol.ui.nbsp,m(pol.ui.textInput,{id:"ll_Ed",size:"3",maxLength:"3",value:this.Ed,regex:/^[0-9]{1,3}$/}),"°",pol.ui.nbsp,pol.ui.nbsp,m(pol.ui.textInput,{id:"ll_Em",size:"6",maxLength:"6",value:this.Em,regex:r}),"'",pol.ui.nbsp,m("span#ll_EW",{onclick:this.clickEW},e[0]<0?"W":"E"),pol.ui.nbsp,pol.ui.nbsp)}onupdate(t){const e=pol.mapref.parseDM(this.Nd(),this.Nm(),this.Ed(),this.Em());if(t.attrs&&t.attrs.value){const n=$("#ll_NS").html(),o=$("#ll_EW").html();t.attrs.value[0]="W"==o?-e[0]:e[0],t.attrs.value[1]="S"==n?-e[1]:e[1]}}clickNS(){const t=$("#ll_NS").html();$("#ll_NS").html("N"==t?"S":"N")}clickEW(){const t=$("#ll_EW").html();$("#ll_EW").html("E"==t?"W":"E")}};pol.ui.latLngInputDec=class{constructor(){this.Nd=m.stream(""),this.Ed=m.stream("")}view(t){CONFIG.mb.getCenter();return m("span",{onclick:function(){pol.ui.autojump("ll_Nd","ll_Ed")}},m(pol.ui.textInput,{id:"ll_Ndd",size:"8",maxLength:"12",value:this.Nd,regex:/^\-?(([0-8]?[0-9])(\.[0-9]+)?|90(\.0+)?)?$/}),"° N",pol.ui.nbsp,pol.ui.nbsp,m(pol.ui.textInput,{id:"ll_Edd",size:"9",maxLength:"13",value:this.Ed,regex:/^\-?[0-9]{1,3}(\.[0-9]+)?$/}),"° E",pol.ui.nbsp,pol.ui.nbsp)}onupdate(t){const e=pol.mapref.parseDM(this.Nd(),0,this.Ed(),0);t.attrs&&t.attrs.value&&(t.attrs.value[0]=e[0],t.attrs.value[1]=e[1])}};const l={view:t=>m("span.removeEdit",[m("img",{src:"images/edit-delete.png",onclick:t.attrs.remove}),null!=t.attrs.edit?m("img",{src:"images/edit.png",onclick:t.attrs.edit}):null])};pol.ui.removeEdit=l,pol.ui.dragdrop=function(t,e){function n(){$(t).removeClass("dragover")}t.addEventListener("dragover",function(e){e.preventDefault(),$(t).addClass("dragover")}),t.addEventListener("dragleave",n),t.addEventListener("dragend",n),t.addEventListener("drop",n),t.addEventListener("drop",function(t){t.preventDefault(),"function"==typeof e&&e(t.dataTransfer||t.target)}),window.addEventListener("blur",n)},pol.ui.formatDTG=function(t){const e=new Date(t),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],o=e.getDate(),s=e.getHours(),i=e.getMinutes();return o+" "+n+" "+s+":"+(i<=9?"0":"")+i}})(),(()=>{var pol=window.pol;pol.core.isMobile=!1,pol.core.Popup=class{constructor(t){this.mb=t,this.onDiv=document.getElementById("map"),this.activepopup=null,this.allowedPopups=1,this.onCallback=null,this.offCallback=null,this.image=null,this.ready=!0;const e=this;function n(){e.ready?e.removePopup():console.log("NOT READY")}this.mb.map.on("movestart",n),this.mb.map.on("click",n),this.mb.map.on("change:view",function(){e.removePopup()})}removePopup(){null!=this.activepopup&&(null!=this.offCallback&&this.offCallback(),this.isMenu=!1,this.allowedPopups++,this.activepopup.style.display="none",null!=this.activepopup.parentNode&&this.activepopup.parentNode.removeChild(this.activepopup),this.activepopup=null)}popupActive(){return null!=this.activepopup}onPopup(t,e){this.onCallback=t,this.offCallback=e}showPopup(t){const e=this;let n,o;if(null!=e.activepopup&&e.allowedPopups<=1)return null;if(t.id&&null!=t.id&&null!=document.getElementById(t.id))return $("#"+t.id).effect("bounce"),null;let s=t.elem&&null!=t.elem?t.elem:document.createElement("div");t.html&&(s.innerHTML=t.html),t.vnode&&m.mount(s,t.vnode),t.id&&null!=t.id&&(s.id=t.id),s.className="POPUP"+(t.cclass&&null!=t.cclass?" "+t.cclass:""),t.geoPos&&null!=t.geoPos&&(t.pixPos=e.mb.map.getPixelFromCoordinate(ol.proj.fromLonLat(t.geoPos,e.mb.view.getProjection()))),t.pixPos&&null!=t.pixPos&&(n=t.pixPos[0],o=t.pixPos[1]),e.popup_(s,n,o,t.image),t.label&&e.allowedPopups++,t.draggable&&t.pinned&&(s._pinned=!0,e.allowedPopups++,e.activepopup=null,t.pin&&t.pin(s._pinned),setTimeout(()=>{const t=document.createElement("img");t.className="popup_close",t.src="images/16px/close.png",s.appendChild(t),t.onclick=t=>s.close()},200)),t.resizable&&$(s).resizable(),t.draggable&&$(s).draggable({handle:"h1,h2,.handle",delay:100,opacity:.7,start:t.dragStart,stop:t.dragStop}),s.onmousedown=function(t){return(t=t||(event||null)).stopPropagation(),null},s.onmouseup=function(t){return t=t||(event||null),null},s.onclick=function(t){return(t=t||(event||null)).stopPropagation(),null},s.close=()=>{t.vnode&&m.mount(s,null),t.onclose&&t.onclose(),s._pinned=!1;const n=e.activepopup;e.activepopup=s,e.allowedPopups--,e.removePopup(),e.activepopup=n,e.removePopup(),t.pin&&t.pin(s._pinned)};const i=new IntersectionObserver(t=>{t.forEach(t=>{if(!t.isIntersecting){let e=t.boundingClientRect.x,n=t.boundingClientRect.y;e>this.onDiv.clientWidth&&(e=this.onDiv.clientWidth-s.clientWidth),n>this.onDiv.clientHeight&&(n=this.onDiv.clientHeight-s.clientHeight),setTimeout(()=>this.setPosition_(s,this.image,e,n),500)}})});return i.observe(s),s}imagePopup(t,e,n,o){n.html='<h1 class="popupimg">'+t+"</h1>"+(null!=o?o:"")+'<img class="popupimg" src="'+e.substring(2)+'"/>';return this.showPopup(n)}remotePopup(t,e,n,o){const s=this.showPopup(o);return t.GET(e,n,t=>{s.innerHTML=t}),s}remotePopupCSS(t,e,n){this.remotePopup(t,n);null!=e&&setTimeout(()=>{div.className=e},900)}showImageGeo(t){setTimeout(()=>{var e=this.mb.map.getPixelFromCoordinate(ol.proj.fromLonLat(t,this.mb.view.getProjection()));this.popup_(null,e[0],e[1],!0)},900)}setPositionGeo(t){if(this.activepopup&&null!=this.activepopup){var e=this.mb.map.getPixelFromCoordinate(ol.proj.fromLonLat(t,this.mb.view.getProjection()));this.setPosition_(this.activepopup,this.image,e[0],e[1])}}setPositionPix(t){this.activepopup&&null!=this.activepopup&&this.setPosition_(this.activepopup,this.image,t[0],t[1])}setPosition_(t,e,n,o){let s=0,i=0,a=!1,r=!1;return null!=e?(e.style.left="-16px",e.style.top="-9px"):(n<0&&(n=0),o<0&&(o=0)),s=n+20+t.clientWidth-this.onDiv.clientWidth,s>0&&(a=!0,(n-=s)<1&&(n=1),null!=e&&(e.style.left=s-16+"px")),i=o+20+t.clientHeight-this.onDiv.clientHeight,i>0&&(r=!0,(o-=i)<1&&(o=1),null!=e&&(e.style.top=i-9+"px")),t.style.left=n+"px",t.style.top=o+"px",a&&r&&null!=e&&(e.style.display="none"),[n,o]}popup_(t,e,n,o){var s=this;if(this.allowedPopups<=0)return;null==t&&(t=document.createElement("div")),this.activepopup=t,null!=o&&o&&(this.image=document.createElement("img"),this.activepopup.appendChild(this.image),this.image.src="images/cross.png",this.image.style.position="absolute",this.image.className="marker"),this.onDiv.appendChild(this.activepopup),this.activepopup.style.position="absolute",this.activepopup.style.display="block",this.activepopup.style.padding="2px",this.activepopup.style.cursor="default",this.onDiv.clientWidth<500&&t.clientWidth>this.onDiv.clientWidth&&(this.activepopup.style.minWidth=this.onDiv.clientWidth-2+"px"),t.clientHeight+10>this.onDiv.clientHeight?(this.activepopup.style.maxHeight=this.onDiv.clientHeight-5+"px",t.id="wrapper",this.activepopup.style.overflowY="scroll"):this.activepopup.style.overflowY="visible";const i=s.activepopup,a=s.image;function r(t,e,n,o){null!=t&&(t.adjustedPos=s.setPosition_(t,e,n+5,o))}r(i,a,e,n),setTimeout(()=>{r(i,a,e,n)},300),setTimeout(()=>{r(i,a,e,n)},1500),this.allowedPopups--,null!=this.onCallback&&this.onCallback(),s.ready=!1,setTimeout(()=>{s.ready=!0},500)}}})(),(()=>{var pol=window.pol;pol.core.PopupMenu=class{constructor(t,e){this.popupmgr=t,this.lastItem=null,this.menudiv=document.createElement("div"),this.heading=e,this.sections=[],this.secNo=0}clear(){this.lastItem=null,this.menudiv=document.createElement("div"),this.secNo=0,this.sections=[]}setHeading(t){this.heading=t}add(t,e,n){if(null==t)this.lastItem.className="ITEM_sep",this.sections[this.secNo++]=this.lastItem;else{const o=null==t?"":t,s=null==e?"":e;this.lastItem=this.createItem_(o,s,n),this.menudiv.appendChild(this.lastItem)}}addSeparator(){this.add(null)}insert(t,e,n,o){if(assert(t>=0&&t<this.sections.length,"sect="+t),0==this.secNo)return void this.add(e,n,o);t>=this.secNo&&(t=this.secNo-1),this.sections[t].className="";const s=null==e?"":e,i=null==n?"":n,a=this.createItem_(s,i,o);this.sections[t].parentNode.insertBefore(a,this.sections[t].nextSibling),a.className="ITEM_sep",this.sections[t]=a}activate(t,e){console.assert(t>0&&e>0,"x="+t+", y="+e),null!=this.lastItem&&(this.lastItem.className="ITEM_last");const n=document.createElement("div");if(null!=this.heading){var o=document.createElement("H1"),s=document.createTextNode(this.heading);o.appendChild(s),n.appendChild(o)}return n.appendChild(this.menudiv),n.style.display="none",n.className="POPUPMENU",n.onmousemove=function(t){return t.stopPropagation(),null},this.popupmgr.popup_(n,t,e,!1),n}createItem_(t,n,o){const s=this,i=document.createElement("div");return i.origCls="",pol.core.isMobile&&i.addEventListener("tap",()=>{a(i,n,o),e.cancelBubble=!0},!1),i.onmouseup=function(t){a(i,n,o)},i.onmousedown=function(t){a(i,n,o),t.cancelBubble=!0},i.onmouseover=function(t){i.origCls=i.className,i.className+=" ITEM_hover"},i.onmouseout=function(t){i.className=i.origCls},i.appendChild(document.createTextNode(t)),i;function a(t,e,n){t.active||(t.className+=" ITEM_selected",t.active=!0,setTimeout(()=>{s.popupmgr.removePopup(),e(n),t.active=!1},300))}}},pol.core.addHandler=function(t,e,n){let o=null;function s(t){return null!=o&&(t.iconX=o.right-10,t.iconY=o.bottom-6),n(t),t.cancelBubble=!0,!1}e&&(setTimeout(()=>o=t.getBoundingClientRect(),200),t.onclick=s),t.oncontextmenu=s},pol.core.addHandlerId=function(t,e,n){const o=document.getElementById(t);pol.core.addHandler(o,e,n)},pol.core.ContextMenu=class{constructor(t){this.callbacks=new Array,this.txt=new pol.core.PopupMenu(t,null)}addCallback(t,e){this.callbacks[t]||(this.callbacks[t]=new Array),this.callbacks[t].push(e)}show(t,e,n){console.assert(null!=t&&t.name&&e>0&&n>0,"ctxt="+t+", x="+e+", y="+n);const o=this;o.txt.clear(),o.txt.x=e,o.txt.y=n;let s=t.name,i=t.name;if(null==i)s="MAP";else if("_STOP_"===i)return;!function(e){const n=o.callbacks[e];if(n)for(let e=0;e<n.length;e++){const s=n[e];null!=s&&s(o.txt,t)}}(s),o.txt.activate(e,n).className+=" ctxt_"+s}addMenu(t,e,n,o){pol.core.addHandler(t,n,s=>{let i=null;o&&(i=o(s)),null==i?this.showHandler(t,s,{name:e},n):this.showHandler(t,s,i,n)})}addMenuId(t,e,n,o){const s=document.getElementById(t);this.addMenu(s,e,n,o)}showOnPos(t,e){this.show(t,e[0]+3,e[1])}showHandler(t,e,n,o){e=e||(event||null),o&&this.show(n,e.iconX,e.iconY),this.show(n,e.clientX+3,e.clientY)}}})(),window.pol.core.Measure=class{constructor(){const t=this;let e,n,o,s;function i(){return e&&e.parentNode.removeChild(measureTooltipElement),e=document.createElement("div"),e.className="tooltip tooltip-measure",n=new ol.Overlay({element:e,offset:[0,-15],positioning:"bottom-center"}),CONFIG.mb.map.addOverlay(n),n}function a(t){return t*Math.PI/180}t.tooltips=[],t.vector=CONFIG.mb.addVectorLayer(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#d11",width:2})})),t.draw=new ol.interaction.Draw({source:t.vector.getSource(),type:"LineString",style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 250, 0.6)",lineDash:[7,8],width:2}),image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.7)"}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"})})})}),CONFIG.mb.map.addInteraction(t.draw),t.draw.on("drawstart",t=>{s=t.feature,o=s.getGeometry().on("change",t=>{const o=t.target.getLastCoordinate();e.innerHTML=function(t){const e=t.getCoordinates(),n=CONFIG.mb.view.getProjection();let o=0,s=0,i=0;for(let t=0,a=e.length-1;t<a;++t)s=ol.proj.transform(e[t],n,"EPSG:4326"),i=ol.proj.transform(e[t+1],n,"EPSG:4326"),o+=ol.sphere.getDistance(s,i);let r=function(t,e){var n=a(t[1]),o=a(e[1]),s=a(e[0]-t[0]),i=Math.sin(s)*Math.cos(o),r=Math.cos(n)*Math.sin(o)-Math.sin(n)*Math.cos(o)*Math.cos(s),l=Math.atan2(i,r);return(180*l/Math.PI+360)%360}(s,i),l="";return l=o>100?Math.round(o/1e3*100)/100+" km":Math.round(100*o)/100+" m",l+=" &nbsp"+Math.round(10*r)/10+"°",l}(t.target),n.setPosition(o)})},t),t.draw.on("drawend",()=>{e.className="tooltip tooltip-static",n.setOffset([0,-7]),s=null,e=null,t.tooltips.push(i()),ol.Observable.unByKey(o)},t),t.tooltips.push(i())}deactivate(t){this.draw.setActive(!1),CONFIG.mb.map.removeInteraction(this.draw),CONFIG.mb.removeLayer(this.vector);for(const t of this.tooltips)CONFIG.mb.map.removeOverlay(t)}},(()=>{var pol=window.pol;pol.core.Toolbar=class extends ol.control.Control{constructor(t,e){const n=t||{},o=document.createElement("div");o.className="toolbar ol-unselectable ol-control",super({element:o,target:n.target}),this.browser=e,this.lastElem=null,this.sections=[],this.nextSect=0}addSection(){const t=document.createElement("div");this.element.appendChild(t),this.sections[this.nextSect++]=t}setDefaultItems(){this.addSection(),this.addIcon(0,"images/menu.png","toolbar",null,"Main menu"),this.addSection(),this.addIcon(1,"images/layers.png","tb_layers",null,"Layer selector"),this.addIcon(1,"images/areaselect.png","tb_area",null,"Area menu"),this.addSection(),this.addIcon(2,"images/ruler1.png","tb_measure",null,"Measure distance");pol.core.addHandlerId("tb_layers",!0,t=>WIDGET("core.LayerSwitcher",[t.iconX,t.iconY],!0));let t=!1,e=null;pol.core.addHandlerId("tb_measure",!0,n=>{t=!t,t?(e=new pol.core.Measure,$("#tb_measure").attr("class","selected")):($("#tb_measure").attr("class",""),null!=e&&e.deactivate())}),this.browser.ctxMenu.addMenuId("toolbar","TOOLBAR",!0),this.browser.ctxMenu.addMenuId("tb_area","AREASELECT",!0),this.browser.ctxMenu.addCallback("AREASELECT",t=>{let e=getWIDGET("core.AreaList");for(const o in e.myAreas){const s=e.myAreas[o];s&&null!=s&&t.add(s.name,n(e.myAreas,o))}e.myAreas.length>0&&t.add(null),null!=CONFIG.server&&CONFIG.server.isAuth()&&CONFIG.server.hasDb&&(t.add("Edit YOUR areas..",()=>WIDGET("core.AreaList",[90,70],!0)),t.add(null));for(const e in this.browser.config.aMaps){const o=this.browser.config.aMaps[e];o&&o.name&&o.name.length>1&&!o.hidden&&t.add(o.title,n(this.browser.config.aMaps,e))}function n(t,e){return function(){CONFIG.browser.gotoExtent(t[e])}}})}setMap(t){super.setMap(t)}addIcon(t,e,n,o,s){const i=document.createElement("img");return null!=n&&i.setAttribute("id",n),i.setAttribute("src",e),s&&i.setAttribute("title",s),this.sections[t].appendChild(i),this.lastElem=i,o&&null!=o&&(i.onclick=o),i}changeIcon(t,e,n,o){const s=document.getElementById(t);null!=s&&(s.setAttribute("src",e),n&&null!=n&&(s.onclick=n),o&&s.setAttribute("title",o))}addDiv(t,e,n,o){const s=document.createElement("div");return null!=e&&s.setAttribute("id",e),n&&s.setAttribute("title",n),o&&(s.className=o),this.sections[t].appendChild(s),this.lastElem=s,s}changeDiv(t,e,n){const o=document.getElementById(t);return null!=o&&(null!=e&&o.setAttribute("title",e),null!=n&&(o.className=n),!0)}hideDiv(t,e){const n=document.getElementById(t);n.style.visibility=e?"hidden":"visible",n.style.width=e?"0":"unset"}divExists(t){return null!=document.getElementById(t)}ddSpacing(){null!=this.lastElem&&(this.lastElem.className+=" x-space")}}})(),(()=>{var pol=window.pol;pol.core.AreaList=class extends pol.core.Widget{constructor(){super();const t=this;function e(e){return!t.myAreas[e].readonly}function n(e){return!t.myAreas[e].noremove}function o(e){const n=t.myAreas[e];pol.getShareWidget().setIdent(n.index,n.name,"Area",null)}function s(){if(""==t.currName())return!1;for(const e of t.myAreas)if(t.currName()==e.name)return!1;return!0}function i(e,n){if(!n&&1!=n&&0==confirm("Remove - are you sure?"))return;const o=CONFIG.server;null!=o&&o.isAuth()&&o.hasDb&&""!=t.myAreas[e].index&&o.removeObj("area",t.myAreas[e].index),t.myAreas.splice(e,1)}function a(e){l(e),t.currName(t.myAreas[e].name),m.redraw()}function r(){const e=CONFIG.mb.getExtent(),n={name:t.currName(),extent:e};n.baseLayer=CONFIG.mb.getBaseLayer().get("name"),n.oLayers=function(){const t={};for(const e of CONFIG.oLayers)t[e.get("name")]=e.getVisible();return t}();const o=CONFIG.server;null!=o&&o.isAuth()&&o.hasDb?o.putObj("area",n,e=>{t.getMyAreas()}):console.warn("Not logged in to server")}function l(e){const n=t.myAreas[e];CONFIG.mb.gotoExtent(n)}t.classname="core.AreaList",t.myAreas=[],t.currName=m.stream(""),this.widget={view:function(){let c=0;return m("div",[m("h1","My map areas"),m("table.mapAreas",m("tbody",t.myAreas.map(t=>m("tr",[m("td",[n(c)?m(pol.ui.removeEdit,{remove:pol.ui.apply(i,c),edit:pol.ui.apply(a,c)}):"",e(c)?m("img",{src:"images/16px/user.png",title:"Sharing",onclick:pol.ui.apply(o,c)}):""]),m("td",{onclick:pol.ui.apply(l,c++),class:t.server?"onserver":null},t.name)])))),m(pol.ui.textInput,{id:"editArea",value:t.currName,size:16,maxLength:25,regex:/^[^\<\>\'\"]+$/i}),m("button",{onclick:r,disabled:!s(),title:"Add area to list"},"Add")])}},t.getMyAreas(),t.authCb=CONFIG.server.addAuthCb(()=>{t.getMyAreas(),CONFIG.server.isAuth()||t.closePopup()})}getMyAreas(){const t=this,e=CONFIG.server;m.redraw(),setTimeout(()=>{null!=e&&e.hasDb?e.getObj("area",e=>{t.myAreas=[];for(const n of e)if(null!=n){const e=n.data;e.index=n.id,e.server=!0,e.readonly=n.readOnly,e.noremove=n.noRemove,t.myAreas.push(e)}t.myAreas.sort((t,e)=>t.name<e.name?-1:1),m.redraw()}):console.warn("Not logged in to server with database plugin")},4e3)}},pol.widget.setFactory("core.AreaList",{create:()=>new pol.core.AreaList})})(),(()=>{var pol=window.pol;pol.core.MousePos=class extends ol.control.Control{constructor(t){const e=t||{},n=document.createElement("div"),o=document.createElement("div"),s=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div");n.className="mousepos ol-unselectable ol-control",s.className="mouse_utm",o.className="scale",i.className="mouse_latlong",a.className="mouse_maidenhead",n.appendChild(o),n.appendChild(s),n.appendChild(i),n.appendChild(a),super({element:n,target:e.target}),this.latlong=i,this.scale=o,this.maidenhead=a,this.utm=s,this.lastMouseMovePixel_=null}setMap(t){super.setMap(t);const e=this;if(t){const n=t.getViewport();n.addEventListener("mousemove",function(t){const n=e.getMap().getEventPixel(t);e.updatePos(n)}),n.addEventListener("mouseout",function(t){e.updatePos(null)}),t.on("moveend",function(t){let n=CONFIG.mb.getScaleRounded();n>=1e6?(n=1e5*Math.round(n/1e5),n/=1e6,n+=" Million"):n>=1e4&&(n=Math.round(n/1e3)+" 000");e.scale.innerHTML="<span>Scale 1 : "+n+"</span>"}),e.updatePos(null)}}updatePos(t){if(null==t)this.updatePosGeo(null);else{const e=this.getMap();let n=e.getCoordinateFromPixel(t);null==n&&(n=[0,0]);const o=ol.proj.toLonLat(n,e.getView().getProjection());this.updatePosGeo(o)}}updatePosGeo(t){if(null==t)this.utm.innerHTML="<span>(utm pos)</span>",this.latlong.innerHTML="<span>(latlong pos)</span>",this.maidenhead.innerHTML="<span>(locator)</span>";else{this.getMap();this.latlong.innerHTML="<span>"+pol.mapref.formatDM(t)+"</span>",this.utm.innerHTML="<span>"+pol.mapref.formatUTM(t)+"</span>",this.maidenhead.innerHTML="<span>"+pol.mapref.formatMaidenhead(t)}}}})(),(()=>{var pol=window.pol;pol.core.LayerSwitcher=class extends pol.core.Widget{constructor(){super(),this.classname="pol.core.LayerSwitcher";var t=this;this.mb=CONFIG.mb,this.storage=null,this.delement=null,this.mb.map.on("moveend",function(){t.evaluateLayers()}),this.mb.map.getLayers().on("change:length",function(){t.evaluateLayers()}),this.widget={view:function(){var e=0;return m("div#layerSwitcher",[m("h2","Base layer"),m("form",t.mb.config.baseLayers.map(n=>{var o,s=e++;return n.predicate()?m("span",{title:n.get("description")},[m("input#blayer"+s,{onclick:(o=s,function(){t.mb.changeBaseLayer(o),t.evaluateLayers()}),type:"radio",name:"layer",value:"layer"+s,checked:n==t.mb.map.getLayers().item(0)?"checked":null}),pol.ui.nbsp,n.get("name"),br]):null})),m("h2","Overlays"),m("form",t.mb.config.oLayers.map(n=>{var o,s=e++;return n.predicate()?m(pol.ui.checkBox,{id:"layer"+s,onclick:(o=s,function(){t.toggleOverlay(o)}),checked:n.getVisible()},m("span",{title:n.get("description")},n.get("name")),br):null}))])}}}toggleOverlay(t){t-=this.mb.config.baseLayers.length,console.assert(t>=0&&t<=this.mb.config.oLayers.length,"i="+t);const e=this.mb.config.oLayers[t].getVisible();this.mb.config.oLayers[t].setVisible(!e),this.mb.config.oLayers[t].wasOn=!e,this.mb.config.store("core.olayer."+this.mb.config.oLayers[t].get("name"),!e)}evaluateLayers(){if(!this.mb.getBaseLayer().predicate()){const t=this.mb.config.baseLayers;for(const e in t)if(t[e].predicate()){this.mb.changeBaseLayer(e);break}}const t=this.mb.config.oLayers;for(const e in t)t[e].predicate()?t[e].wasOn&&t[e].setVisible(!0):t[e].setVisible(!1);m.redraw()}},pol.widget.setFactory("core.LayerSwitcher",{create:()=>new pol.core.LayerSwitcher})})(),(()=>{var pol=window.pol;pol.core.refSearch=class extends pol.core.Widget{constructor(){super();const t=this;t.classname="core.refSearch",t.mgrsVal=[0,0],t.utmVal=[0,0],t.llVal=[0,0],t.llVal2=[0,0];let e="";function n(t,n){const o=[t[0],t[1]];0==o[0]&&0==o[1]?(e="Invalid "+n+" map reference",setTimeout(()=>{e="",m.redraw()},7e3)):CONFIG.mb.goto_Pos(o,!0)}this.widget={view:function(){return m("div",[m("h1","Show reference on map"),m("div.errmsg",e),m("form.mapref",[m("div.field",m("span.sleftlab",{title:"MGRS 100x100m square"},"MGRS ref: "),m(pol.ui.mgrsInput,{value:t.mgrsVal}),m("button#butt_mgrs",{type:"button",onclick:()=>n(t.mgrsVal,"MGRS")},"Find")),pol.ui.hr,m("div.field",m("span.sleftlab","UTM ref: "),m(pol.ui.utmInput,{value:t.utmVal}),m("button#butt_utm",{type:"button",style:"margin-right:3.5em",onclick:()=>n(t.utmVal,"UTM")},"Find")),pol.ui.hr,m("div.field",m("span.sleftlab",{title:"Degrees, decimal-minutes (click to change hemisphere)"},"Lat Long: "),m(pol.ui.latLngInput,{value:t.llVal}),m("button#butt_ll",{type:"button",onclick:()=>n(t.llVal,"LatLong")},"Find")),pol.ui.hr,m("div.field",m("span.sleftlab",{title:"Decimal degrees"},"Dec. LL: "),m(pol.ui.latLngInputDec,{value:t.llVal2}),m("button#butt_lld",{type:"button",onclick:()=>n(t.llVal2,"LatLong")},"Find"))])])}},CONFIG.mb.map.on("moveend",()=>{m.redraw()})}},pol.widget.setFactory("core.refSearch",{create:()=>new pol.core.refSearch})})(),(()=>{var pol=window.pol;window.pol.uid="ol4test";function t(t){return function(e){let o=t.slice(0);for(let s in t)e.values_.get=function(t){return this[t]},o[s]={lbl:t[s].lbl,val:n(t[s].val,e.values_)};return o}}function e(t){let e=CONFIG.styles[t];return e||(console.warn("Unknown style id: "+t),e=CONFIG.styles[defaultStyle]),e}function n(t,e){return t.replace(/\$\([^\)]+\)/g,t=>function(t){const n=(t=t.substring(2,t.length-1)).split(".");var o=e.get(n[0]);if("string"==typeof o)return o;for(var s=1;s<n.length;s++)void 0!==o&&(o=o[n[s]]);return void 0===o?"":("string"!=typeof o&&console.warn("Reference to non-string object: ",o),o)}(t))}window.WELCOME=function(t){CONFIG.set("welcome_popup",t)},window.LOGO=function(t){CONFIG.set("logo",t)},window.SECURE=function(t){CONFIG.set("secure",t)},window.SERVER=function(t){CONFIG.set("server",t)},window.PORT=function(t){CONFIG.set("port",t)},window.MAX_CLIENTS=function(t){CONFIG.set("max_clients",t)},window.ALT_SECURE=function(t){CONFIG.set("alt_secure",t)},window.ALT_SERVER=function(t){CONFIG.set("alt_server",t)},window.ALT_PORT=function(t){CONFIG.set("alt_port",t)},window.WSPREFIX=function(t){CONFIG.set("wsprefix",t)},window.AJAXPREFIX=function(t){CONFIG.set("ajaxprefix",t)},window.ICONPATH=function(t){CONFIG.set("iconpath",t)},window.DEFAULT_ICON=function(t){CONFIG.set("default_icon",t)},window.ll2proj=function(t){return ol.proj.transform(t,"EPSG:4326",CONFIG.mb.view.getProjection())},window.proj2ll=function(t){return ol.proj.transform(t,CONFIG.mb.view.getProjection(),"EPSG:4326")},window.DEFAULT_FILTER=function(t,e){null==t?CONFIG.set("default_filter",e):CONFIG.set("default_filter."+t,e)},window.TRUE=function(){return!0},window.ADD_PROJECTION=function(t,e,n){console.log("ADD_PROJECTION: "+t+", "+e),proj4.defs(t,e),ol.proj.proj4.register(proj4);const o=ol.proj.get(t);return o.setExtent(n),o},window.PROJECTION=function(t){CONFIG.set("core.projection",t)},window.SUPPORTED_PROJ=function(t){CONFIG.set("core.supported_proj",t)},window.CENTER=function(t,e){CONFIG.set("core.center",[t,e])},window.SCALE=function(t){CONFIG.set("core.resolution",t)},window.TILEGRID_WMTS=function(t,e,n,o,s,i){const a=t.getExtent(),r=s||ol.extent.getWidth(a)/256;let l=[],c=[],u=0;for(let t=e;t<=n;t++)l[u]=r/Math.pow(2,t),c[u++]=o&&null!=o?o+":"+t:t;return new ol.tilegrid.WMTS({extent:a,origin:i||ol.extent.getTopLeft(utmproj.getExtent()),resolutions:l,matrixIds:c})},window.createLayer_MapCache=function(t){setTimeout(()=>{let n=CONFIG.server.host;if(null==n){let t=window.location.host,e=window.location.protocol;n="",e&&(n+=e+"//"),n+=t||"localhost"}e.getSource().setUrl(t.url?t.url:n+"/mapcache/wms?")},2e3);const e=new ol.layer.Tile({name:t.name?t.name:"noname",preload:2,opacity:t.opacity?t.opacity:1,max_res:t.seed_max_res,source:new ol.source.TileWMS({url:t.url?t.url:"/mapcache/wms?",projection:utmproj,params:{LAYERS:t.layers,VERSION:"1.1.1",TRANSPARENT:!0},tilegrid:t.tilegrid,cacheSize:4096,attributions:t.attributions})});return e},window.LAYERS=async function(t,e){if(null!=e&&e.length>0)for(var n=0;n<e.length;n++){var o=e[n];if(!o.attribution&&t.attribution&&(o.attribution=t.attribution),!o.predicate&&t.predicate&&(o.predicate=t.predicate),!o.projection&&t.projection&&(o.projection=t.projection),t.base)CONFIG.baseLayers.push(o);else{const t=await CONFIG.get("core.olayer."+o.get("name"));o.setVisible(t),CONFIG.oLayers.push(o)}}},window.VIEWS=function(t){if(null!=t)for(let e=0;e<t.length;e++){const n=t[e];CONFIG.aMaps[n.name]=n}},window.POLYGON=function(t){return t.push(t[0]),new ol.geom.Polygon([t])},window.IN_EXTENT=function(t){return function(){return function(t){const e=CONFIG.mb.getExtent();return!(null==e||!t.intersectsExtent(e))}(t)}},window.SELECTED_BASE=function(t){return function(){return function(t){return null!=CONFIG.mb&&CONFIG.mb.getBaseLayer().get("name")==t}(t)}},window.IS_PROJ=function(t){return function(){return function(t){return CONFIG.mb.getProjection()===t}(t)}},window.RESOLUTION_LT=function(t){return function(){return CONFIG.mb.getResolution()<t}},window.RESOLUTION_GT=function(t){return function(){return CONFIG.mb.getResolution()>t}},window.SCALE_LT=function(t){return function(){return CONFIG.mb.getScale()<t}},window.SCALE_GT=function(t){return function(){return CONFIG.mb.getScale()>t}},window.LOGIN=function(){return function(){return null!=CONFIG.server&&CONFIG.server.isAuth()}},window.AND=function(t,e){return function(){return t()&&e()}},window.OR=function(t,e){return function(){return t()||e()}},window.NOT=function(t){return function(){return!t()}},window.createLayer_GPX=function(e){const n=new ol.source.Vector({format:1==e.gjson?new ol.format.GeoJSON:new ol.format.GPX,loader:(t,o,s)=>{CONFIG.server.GET(e.url,null,t=>{var e=n.getFormat().readFeatures(t,{featureProjection:s});n.addFeatures(e)},e=>{console.warn("Get GPX/JSON object: "+e),n.removeLoadedExtent(t)})}}),o=new ol.layer.Vector({name:e.name,source:n,style:e.style,gpxLayer:!0});return e.info?o.displayInfo=e.info:o.displayInfo=t([{val:"$(name)"},{val:"$(desc)"}]),o},window.createLayer_WFS=function(t){1==t.newVersion?(t.outputFormat="text/xml; subtype=gml/3.2.1",t.wfsVersion="2.0.0"):(t.outputFormat="text/xml; subtype=gml/3.1.1",t.wfsVersion="1.1.0"),t.cql?t.cql="&cql_filter="+t.cql:t.cql="";const e=new ol.source.Vector({format:new ol.format.WFS({gmlFormat:1==t.newVersion?new ol.format.GML32:new ol.format.GML3,version:1==t.newVersion?"2.0.0":"1.1.0"}),url:function(e){let n=t.srs;return t.srs||(n=CONFIG.mb.view.getProjection().getCode()),t.url+"?service=WFS&version="+t.wfsVersion+"&request=GetFeature&typename="+t.ftype+"&outputFormat="+t.outputFormat+"&srsname="+n+"&bbox="+e.join(",")+","+n+t.cql+(null!=t.token?"&token="+t.token:"")},strategy:ol.loadingstrategy.bbox});e.ftype=t.ftype,e.oformat=t.oformat,e.baseurl=t.url;const n=new ol.layer.Vector({name:t.name,description:t.description,source:e,style:t.style});return n.clearOnMove=!0,t.info&&(n.displayInfo=t.info),n},window.FEATUREINFO=t,window.STYLES=function(t){for(let e in t){let n=t[e];const o=n.id?n.id:"style_"+e;delete n.id,n.stroke&&(n.stroke=new ol.style.Stroke(n.stroke)),n.fill&&(n.fill=new ol.style.Fill({color:n.fill})),n.text&&(n.text.fill&&(n.text.fill=new ol.style.Fill({color:n.text.fill})),n.text.stroke&&(n.text.stroke=new ol.style.Stroke(n.text.stroke)),n.text=new ol.style.Text(n.text)),CONFIG.styles[o]=new ol.style.Style(n),CONFIG.styles[o].tag=n.tag}},window.GETSTYLE=function(t){return function(n,o){return e(t)}},window.SETLABEL=function(t,e){return function(o,s){return function(t,e){let n=CONFIG.styles[t].clone();return e&&null!=e&&n.getText().setText(e),n}(t,n(e,o))}},window.TESTRES=function(t,e,n){return function(o,s){return s<t?e(o,s):n(o,s)}},window.ICON=function(t,e){return e||(e={}),e.src=t,new ol.style.Icon(e)},window.CIRCLE=function(t,e){return e||(e={}),e.radius=t,e.fill&&(e.fill=new ol.style.Fill({color:e.fill})),e.stroke?e.stroke=new ol.style.Stroke(e.stroke):e.stroke=new ol.style.Stroke({color:"#000",width:1}),new ol.style.Circle(e)},window.WIDGET=function(t,e,n,o,s){pol.widget.start(t,e,!0,n,o,s)},window.POPUP=function(t,e,n){pol.widget.start(t,e,!1,!1,n)},window.getWIDGET=function(t){return pol.widget.get(t)},window.GETJSON=function(t){return t},window.getStyle=e})(),(()=>{var pol=window.pol;pol.core.DocReader=class extends pol.core.Widget{constructor(){super(),this.classname="core.DocReader";var t=this;t.heading="Info",t.widget={view:function(){return m("div#docreader",[m("h1",t.heading),m("div#dcontent","...")])}},t.resizeObserve(()=>t.setScrollTable2("div#docreader","div#dcontent","",!1))}setContent(t,e){$.ajax(e,{success:e=>{null!=t&&(this.heading=t),$("div#dcontent").html(e),m.redraw(),this.setScrollTable2("div#docreader","div#dcontent","",!1)}})}},pol.widget.setFactory("core.DocReader",{create:()=>new pol.core.DocReader})})(),(()=>{var pol=window.pol;pol.core.MapInfo=class extends pol.core.Widget{constructor(){super();function t(){const t=CONFIG.mb.getResolution();if(e())if(t>e())alert("Seeding not supported in this zoom level");else{const t=CONFIG.mb.getBaseLayer().getSource().params_.LAYERS,e=CONFIG.mb.getExtent(),n=ol.proj.transformExtent(e,"EPSG:4326",CONFIG.mb.getBaseLayer().getSource().getProjection());let o={args:[t,""+Math.round(n[0]),""+Math.round(n[1]),""+Math.round(n[2]),""+Math.round(n[3])]};srv.POST("scripts/seeder",JSON.stringify(o),()=>alert("Tile downloading started.."),()=>alert("Couldn't start tile downloading on server"))}else alert("Seeding not supported for this map")}function e(){return CONFIG.mb.getBaseLayer().values_.max_res}function n(t){return Math.round(1e3*t)/1e3}function o(t){return"["+n(t[0])+", "+n(t[1])+"]"}this.classname="core.MapInfo",this.baselayer=CONFIG.mb.getBaseLayer(),this.widget={view:function(){return m("div",[m("h1","Map view info"),m("div.field",m("span.sleftlab","Base layer:"),m("span",CONFIG.mb.getBaseLayer().values_.name)),m("div.field",m("span.sleftlab","Projection:"),m("span",CONFIG.mb.getProjection())),m("div.field",m("span.sleftlab","Resolution:"),m("span",n(CONFIG.mb.getResolution())),pol.ui.nbsp,m("span","(zoom "+Math.round(1e3*CONFIG.mb.view.getZoom())/1e3+")")),m("div.field",m("span.sleftlab","Scale:"),m("span",Math.round(CONFIG.mb.getScale()))),m("div.field",m("span.sleftlab","Extent:"),m("span",(s=CONFIG.mb.getExtent(),"["+n(s[0])+", "+n(s[1])+", "+n(s[2])+", "+n(s[3])+"]"))),m("div.field",m("span.sleftlab","Center:"),m("span",o(CONFIG.mb.getCenter()))),CONFIG.mb.getResolution()<e()&&srv.auth.admin?m("div.butt",m("button",{onclick:t,title:"Download map tiles for this area"},"Download Tiles"),"to server"):""]);var s}},getWIDGET("core.LayerSwitcher")}},pol.widget.setFactory("core.MapInfo",{create:()=>new pol.core.MapInfo})})()})();