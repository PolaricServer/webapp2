(()=>{var pol;pol=window.pol,window.pol.psadmin=window.pol.psadmin||{},pol.psadmin.Passwd=class extends pol.core.Widget{constructor(){super();var e=this;function t(){if(e.passwd1()!=e.passwd2())return void alert("Passwords do not match.");if(e.passwd1().length<8)return void alert("Too short (should be at least 8 characters)");const t={passwd:e.passwd1()};e.server.PUT("mypasswd",JSON.stringify(t),e=>{alert("Password updated ok.")},e=>{console.log("Update passwd -> "+e.status+": "+e.statusText+" ("+e.responseText+")"),alert('Cannot update password.\n"'+e.responseText+'"')})}e.server=CONFIG.server,e.classname="psadmin.Passwd",e.passwd1=m.stream(""),e.passwd2=m.stream(""),this.widget={view:function(){return m("div#pwdEdit",[m("h1","Change your password  "),m("span.pwintro","Please enter new password"),m("div.field",m("span.xsleftlab","Password:"),m(pol.ui.textInput,{id:"passwd1",value:e.passwd1,size:16,maxLength:32,regex:/.*/i,passwd:!0})),m("div.field",m("span.xsleftlab","Repeat it:"),m(pol.ui.textInput,{id:"passwd2",value:e.passwd2,size:16,maxLength:32,regex:/.*/i,passwd:!0})),m("div.butt",[m("button",{type:"button",onclick:t},"Update")])])}}}onActivate(){this.passwd1(""),this.passwd2(""),setTimeout(()=>$("#passwd1").val(""),100),m.redraw()}},pol.widget.setFactory("psadmin.Passwd",{create:()=>new pol.psadmin.Passwd}),(()=>{var pol=window.pol;window.pol.psadmin=window.pol.psadmin||{},pol.psadmin.statusInfo=class extends pol.core.Widget{constructor(){super();const e=this;e.classname="psadmin.StatusInfo",e.data={runsince:"",version:"",items:0,ownobj:0,clients:0,loggedin:0,usedmem:0,plugins:[],channels:[]},e.clients=[],this.showClients={view:function(){return m("table",m("thead",m("tr",m("th","Created"),m("th","Client"),m("th","M"),m("th","In"),m("th","Out"),m("th","Userid"))),m("tbody",e.clients.map(t=>{const s=new Date(t.created);return m("tr",{class:e.editMode&&t.name===e.name()?"selected":null},[m("td",{title:pol.core.Time.formatDate(s)},pol.core.Time.formatTime(s)),m("td",t.cid),m("td",t.mobile?"M":""),m("td.n",t.in),m("td.n",t.out),m("td",t.userid)])})))}},this.widget={view:function(){const t=new Date(e.data.runsince);return m("div#statusinfo",[m("h1","Status Info"),m("form.status",[m("div.field",m("span.wleftlab","Server run since: "),pol.core.Time.formatDate(t)+" / "+pol.core.Time.formatTime(t)),m("div.field",m("span.wleftlab","Server address: "),CONFIG.server.host),m("div.field",m("span.wleftlab","Server callsign: "),CONFIG.server.auth.servercall),m("div.field",m("span.wleftlab","Server version: "),e.data.version),m("div.field",m("span.wleftlab","Number of items: "),e.data.items),m("div.field",m("span.wleftlab","Own objects: "),e.data.ownobj),m("div.field",m("span.wleftlab","Clients (logged in): "),e.data.clients+" ("+e.data.loggedin+")"),m("div.field",m("span.wleftlab","Plugin modules: "),m("div#plugins",e.data.plugins.map(e=>function(e){let t=e;e.length>45&&(t=e.substring(0,42)+"...");return m("div.plug",{title:e},t)}(e)))),null!=e.data.remotectl&&""!=e.data.remotectl?m("div.field",m("span.wleftlab","Remote control: "),e.data.remotectl):null]),m("div#clientList")])}},e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()})}getInfo(){CONFIG.server.GET("system/adm/status",null,e=>{this.data=GETJSON(e),m.redraw()},e=>{console.log("Cannot GET data (se browser log)",e)})}getClients(){CONFIG.server.GET("system/adm/clients",null,e=>{this.clients=GETJSON(e),this.clients.sort((e,t)=>e.cid<t.cid?-1:e.cid===t.cid?0:1),setTimeout(()=>this.mountList(),200),m.redraw(),this.nclients=this.clients.length},e=>{console.log("Cannot GET data (se browser log)",e)})}onclose(){null!=this.updates&&clearInterval(this.updates)}onActivate(){this.resizable=!0,this.getInfo(),this.getClients(),this.updates=setInterval(()=>{this.getInfo(),this.getClients()},1e4)}mountList(){m.mount($("div#clientList").get(0),this.showClients),this.setScrollTable("#statusinfo","div#clientList")}},pol.widget.setFactory("psadmin.StatusInfo",{create:()=>new pol.psadmin.statusInfo})})(),(()=>{var pol=window.pol;pol.psadmin.db=pol.psadmin.db||{},pol.psadmin.db.SyncNodes=class extends pol.core.Widget{constructor(){super();const e=this;function t(e){s(e,!0)}function s(t,s){const i=s?e.children:e.parents,a=i[t];0!=confirm("Remove sync node "+a.nodeid+" - are you sure?")&&(s&&0==confirm("Warning: Manual removal of child node - are you sure?")||e.server.DELETE("sync/nodes/"+a.nodeid,e=>{i.splice(t),m.redraw()},e=>{console.log("Cannot remove parent node -> "+e.status+": "+e.statusText+" ("+e.responseText+")"),alert("Cannot remove parent node: "+a.nodeid+'\n"'+e.responseText+'"')}))}function i(){const t={nodeid:"",items:e.items(),url:e.url()};e.server.POST("sync/nodes",JSON.stringify(t),s=>{t.nodeid=s,e.parents.push(t),m.redraw()},t=>{console.log("Add node -> "+t.status+": "+t.statusText+" ("+t.responseText+")"),alert("Cannot add node: "+e.url()+'\n"'+t.responseText+'"')})}function a(){e.items(""),e.url(""),m.redraw()}function n(t){e.items(e.parents[t].items),e.url(e.parents[t].url),m.redraw()}e.server=CONFIG.server,e.classname="psadmin.db.SyncNodes",e.parents=[],e.children=[],e.items=m.stream(""),e.url=m.stream(""),e.parentList={view:function(){var t=0;return m("table",m("tbody",e.parents.map(e=>m("tr",[m(pol.ui.removeEdit,{remove:pol.ui.apply(s,t),edit:pol.ui.apply(n,t++)}),m("td",e.nodeid),m("td",e.url),m("td",e.items.substring(0,12)+"..."),e.active?m("img",{src:"images/16px/ok.png"}):null]))))}},e.childList={view:function(){var s=0;return m("table",m("tbody",e.children.map(e=>m("tr",[m(pol.ui.removeEdit,{remove:pol.ui.apply(t,s++),edit:null}),m("td",e.nodeid),m("td",e.items),e.active?m("img",{src:"images/16px/ok.png"}):null]))))}},e.widget={view:function(){return m("div#syncNodes",[m("h1","Synch nodes"),m("h3","Parent nodes:"),m(e.parentList),m("h3","Child nodes:"),m(e.childList),hr,m("div.field",m("span.xsleftlab","Srv URL:"),m(pol.ui.textInput,{id:"nodeUrl",value:e.url,size:30,maxLength:64,regex:/.*/i})),m("div.field",m("span.xsleftlab","Items:"),m(pol.ui.textInput,{id:"nodeItems",value:e.items,size:30,maxLength:64,regex:/.*/i})),m("div.butt",[m("button",{id:"abutt",type:"button",onclick:i},"Add"),m("button",{type:"button",onclick:a},"Clear")])])}},e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()}),setInterval(()=>e.getNodes(),6e4)}getNodes(){this.children=[],this.parents=[],this.server.GET("sync/nodes","",e=>{var t=GETJSON(e);for(e of t)null==e.url||""==e.url?this.children.push(e):this.parents.push(e);m.redraw()})}onActivate(){this.getNodes()}},pol.widget.setFactory("psadmin.db.SyncNodes",{create:()=>new pol.psadmin.db.SyncNodes})})(),(()=>{var pol=window.pol;window.pol.psadmin=window.pol.psadmin||{},pol.psadmin.Users=class extends pol.core.Widget{constructor(){super();var e=this;function t(){e.admin=!e.admin}function s(){e.suspend=!e.suspend}function i(){e.hidesuspend=!e.hidesuspend}function a(){e.group=$("select#pgroup").val();for(const t of e.groupList)t.ident==e.group&&(e.selGroup=t.name);console.log("GROUP/SELGROUP: ",e.group,e.selGroup),m.redraw()}function n(){e.altgroup=$("select#agroup").val();for(const t of e.groupList)t.ident==e.altgroup&&(e.selAGroup=t.name);console.log("GROUP/SELGROUP: ",e.altgroup,e.selAGroup),m.redraw()}function l(){const t={ident:e.ident(),name:e.name(),callsign:""==e.callsign()||" "==e.callsign()?"":e.callsign().toUpperCase(),passwd:""==e.passwd()||" "==e.passwd()?null:e.passwd(),group:e.group,altgroup:e.altgroup,admin:e.admin,suspend:e.suspend};e.server.POST("users",JSON.stringify(t),s=>{t.passwd=NaN,e.users.push(t),e.sortList(),e.mountList()},t=>{console.log("Add user -> "+t.status+": "+t.statusText+" ("+t.responseText+")"),alert("Cannot add user: "+e.ident()+'\n"'+t.responseText+'"')})}function r(){const t={name:e.name(),passwd:""==e.passwd()||" "==e.passwd()?null:e.passwd(),callsign:""==e.callsign()||" "==e.callsign()?"":e.callsign().toUpperCase(),group:e.group,altgroup:e.altgroup,admin:e.admin,suspend:e.suspend};e.server.PUT("users/"+e.ident(),JSON.stringify(t),s=>{for(let s in e.users)if(e.users[s].ident==e.ident()){e.users[s].name=t.name,e.users[s].callsign=t.callsign,e.users[s].group=t.group,e.users[s].altgroup=t.altgroup,e.users[s].admin=t.admin,e.users[s].suspend=t.suspend;break}e.mountList()},t=>{console.log("Update user -> "+t.status+": "+t.statusText+" ("+t.responseText+")"),alert("Cannot update user: "+e.ident()+'\n"'+t.responseText+'"')})}function o(t){0!=confirm("Remove - are you sure?")&&e.server.DELETE("users/"+e.users[t].ident,s=>{console.log("Removed user: "+e.users[t].ident),e.users.splice(t,1),e.mountList()})}function d(t){const s=e.users[t];e.ident(s.ident),e.name(s.name),e.callsign(s.callsign),e.passwd(""),e.group=s.group,e.altgroup=s.altgroup,e.admin=s.admin,e.suspend=s.suspend,setTimeout(()=>{$("select#pgroup").val(e.group).trigger("change"),$("select#agroup").val(e.altgroup).trigger("change")},100)}e.server=CONFIG.server,e.classname="psadmin.Users",e.users=[],e.ident=m.stream(""),e.name=m.stream(""),e.callsign=m.stream(""),e.passwd=m.stream(""),e.group="DEFAULT",e.altgroup="DEFAULT",e.selGroup="",e.selAGroup="",e.groupList=[],e.sar=!1,e.admin=!1,e.suspend=!1,e.hidesuspend=!0,this.userList={view:function(){var t=0;return m("table",m("tbody",e.users.filter(s=>{return s.idx=t++,i=s,!e.hidesuspend||!i.suspend;var i}).map(e=>m("tr",[m("td",m(pol.ui.removeEdit,{remove:pol.ui.apply(o,e.idx),edit:pol.ui.apply(d,e.idx)})),m("td",e.ident),m("td",(e.suspend?"U":"")+(e.admin?"A":"")+(null!=e.callsign&&e.callsign.length>1?"H":"")),m("td",e.group),m("td",p(e.lastused)),m("td",e.name)]))))}},e.authCb=CONFIG.server.addAuthCb(()=>{this.getUsers(),CONFIG.server.isAuth()||e.closePopup()}),e.groups={view:function(){return m("select#pgroup",{onchange:a},e.groupList.map(e=>m("option",{value:e.ident},e.ident)))}},e.agroups={view:function(){return m("select#agroup",{onchange:n},e.groupList.map(e=>m("option",{value:e.ident},e.ident)))}},this.widget={view:function(){return m("div#userEdit",[m("h1","User Management"),m("div.field",m("span.xsleftlab","Ident:"),m(pol.ui.textInput,{id:"userId",value:e.ident,size:16,maxLength:25,regex:/.*/i})),m("div.field",m("span.xsleftlab",{title:"HAM radio (APRS) callsign"},"Callsign:"),m(pol.ui.textInput,{id:"callsign",value:e.callsign,size:16,maxLength:32,regex:/[A-Z0-9\-]*/i})),m("div.field",m("span.xsleftlab","Name:"),m(pol.ui.textInput,{id:"name",value:e.name,size:25,maxLength:32,regex:/.*/i})),m("div.field",m("span.xsleftlab","Passwd:"),m(pol.ui.textInput,{id:"passwd",value:e.passwd,size:25,maxLength:32,regex:/.*/i})),m("div.field",m("span.xsleftlab",{title:"Primary Group"},"Group:"),m(e.groups),m("span#selGroup",""+e.selGroup),pol.ui.nbsp),m("div.field",m("span.xsleftlab",{title:"Secondary group"},"Alt group:"),m(e.agroups),m("span#selAGroup",""+e.selAGroup),pol.ui.nbsp),m("div.field",m("span.xsleftlab","Access:"),m(pol.ui.checkBox,{id:"acc_admin",onclick:t,checked:e.admin,title:"Administrator (super user level)"},"Admin"),pol.ui.nbsp,m(pol.ui.checkBox,{id:"acc_susp",onclick:s,checked:e.suspend,title:"User access is suspended (no login)"},"Suspend (U)"),pol.ui.nbsp,m(pol.ui.checkBox,{id:"acc_susp",onclick:i,checked:e.hidesuspend},"Hide suspended"),m("span#hamop",null!=e.callsign()&&e.callsign().length>1?"(HAM radio op)":"")),m("div.butt",[m("button",{type:"button",onclick:r},"Update"),m("button",{type:"button",onclick:l},"Add"),m("button",{type:"button",onclick:()=>{e.clear()}},"Clear")]),m("div#userList")])}},e.server.GET("groups","",t=>{e.groupList=GETJSON(t)}),setTimeout(()=>e.clear(),100);const c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function p(e){if(null==e)return"";const t=new Date(e);return t.getDate()+" "+c[t.getMonth()]+" "+t.getFullYear()+" "+(t.getHours()<10?"0":"")+t.getHours()+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()}}clear(){this.ident(""),this.name(""),this.passwd(""),this.group="DEFAULT",this.altgroup="DEFAULT",this.admin=!1,this.suspend=!1,m.redraw(),setTimeout(()=>{$("select#pgroup").val(this.group).trigger("change"),$("select#agroup").val(this.altgroup).trigger("change")},100)}getUsers(){CONFIG.server.GET("users","",e=>{this.users=GETJSON(e),this.sortList(),setTimeout(()=>this.mountList(),500)})}mountList(){m.mount($("div#userList").get(0),this.userList),this.setScrollTable("#userEdit","div#userList")}sortList(){this.users.sort((e,t)=>e.ident<t.ident?-1:1)}onActivate(){this.resizable=!0,this.getUsers()}},pol.widget.setFactory("psadmin.Users",{create:()=>new pol.psadmin.Users})})(),(()=>{var pol=window.pol;window.pol.psadmin=window.pol.psadmin||{},pol.psadmin.ServerConfig=class extends pol.core.Widget{constructor(){super();var e=this;function t(){e.igate_on=!e.igate_on}function s(){e.rfgate_allow=!e.rfgate_allow}function i(){e.obj_rfgate=!e.obj_rfgate}function a(){e.remotectl_on=!e.remotectl_on}function n(){const t={mycall:e.mycall(),always_rf:e.msg_alwaysrf(),authkey:e.rctl_key(),igate:e.igate_on,objigate:e.obj_rfgate,path_igate:e.igate_path(),path_messages:e.msg_path(),path_objects:e.obj_path(),radius:parseInt(e.igate_range()),rc_server:e.rctl_server(),remote_radius:parseInt(e.rctl_range()),remotectl:e.remotectl_on,rfigate:e.rfgate_allow};e.server.PUT("system/adm/server",JSON.stringify(t),t=>{console.log("Update succeeded"),e.successMsg("Update succeeded. Restart of aprsd may be necessary",1e4),m.redraw()},(t,s,i)=>{console.log("Server update failed: ",s,i),e.errMsg("Server update failed: "+i,1e4)})}e.server=CONFIG.server,e.classname="psadmin.ServerConfig",e.mycall=m.stream(""),e.igate_range=m.stream(""),e.igate_path=m.stream(""),e.msg_path=m.stream(""),e.obj_path=m.stream(""),e.msg_alwaysrf=m.stream(""),e.rctl_range=m.stream(""),e.rctl_server=m.stream(""),e.rctl_key=m.stream(""),e.igate_on=!1,e.rfgate_allow=!1,e.obj_rfgate=!1,e.remotectl_on=!1,e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()}),this.widget={view:function(){return m("div#serverConfig",[m("h1","Polaric-APRSD Server Config"),null!=e.errmsg?m("div#errmsg",e.errmsg):null,null!=e.successmsg?m("div#successmsg",e.successmsg):null,m("div.field",m("span.wleftlab","Callsign:"),m(pol.ui.textInput,{id:"mycall",value:e.mycall,size:10,maxLength:16,regex:/[A-Z0-9\-]*/i})),pol.ui.br,m("div.field",m("span.wleftlab","Igate:"),m(pol.ui.checkBox,{id:"rfgate_allow",onclick:t,checked:e.rfgate_on,title:"RF/Internet gateway (igate)"},"Activate")),m("div.field",m("span.wleftlab","Igating to RF:"),m(pol.ui.checkBox,{id:"rfgate_allow",onclick:s,checked:e.rfgate_allow,title:"Allow igating to RF"},"Activate"),pol.ui.nbsp,m(pol.ui.checkBox,{id:"obj_rfgate",onclick:i,checked:e.obj_rfgate,title:"Allow igating to RF for objects"},"RF igating for object")),m("div.field",m("span.wleftlab","Range objects:"),m(pol.ui.textInput,{id:"igate_range",value:e.igate_range,size:6,maxLength:6,regex:/0-9]*/i})),m("div.field",m("span.wleftlab","Igate digi path:"),m(pol.ui.textInput,{id:"ig_digipath",value:e.igate_path,size:25,maxLength:32,regex:/a-zA-Z0-9\,\-]*/i})),m("div.field",m("span.wleftlab","Messages digi path:"),m(pol.ui.textInput,{id:"ig_msgpath",value:e.msg_path,size:25,maxLength:32,regex:/a-zA-Z0-9\,\-]*/i})),m("div.field",m("span.wleftlab","Objects digi path:"),m(pol.ui.textInput,{id:"ig_objpath",value:e.obj_path,size:25,maxLength:32,regex:/a-zA-Z0-9\,\-]*/i})),m("div.field",m("span.wleftlab",{title:"Messages with DEST matching this expression will be sent on RF"},"Always send on RF:"),m(pol.ui.textInput,{id:"ig_alwaysrf",value:e.msg_alwaysrf,size:25,maxLength:32,regex:/.*/i})),pol.ui.br,m("div.field",m("span.wleftlab","Remote control:"),m(pol.ui.checkBox,{id:"remotectl_on",onclick:a,checked:e.remotectl_on,title:"Coordinate with other server-instances over APRS"},"Activated")),m("div.field",m("span.wleftlab",{title:"Radius (km) in which we want to receive item-updates"},"Range updates:"),m(pol.ui.textInput,{id:"rctl_range",value:e.rctl_range,size:6,maxLength:6,regex:/0-9]*/i})),m("div.field",m("span.wleftlab",{title:"Callsign of another Polaric Server instance"},"RC server:"),m(pol.ui.textInput,{id:"rctl_server",value:e.rctl_server,size:10,maxLength:16,regex:/a-zA-Z0-9\-]*/i})),m("div.field",m("span.wleftlab","Authentication key:"),m(pol.ui.textInput,{id:"rctl_key",value:e.rctl_key,size:25,maxLength:64,regex:/.*/i})),m("div.butt",[m("button",{type:"button",onclick:n},"Update"),m("button",{type:"button",onclick:()=>{e.clear()}},"Clear")])])}}}clear(){}getConfig(){CONFIG.server.GET("system/adm/server","",e=>{const t=GETJSON(e),s=this;s.mycall(t.mycall),s.igate_range(""+t.radius),s.igate_path(t.path_igate),s.msg_path(t.path_messages),s.obj_path(t.path_objects),s.msg_alwaysrf(t.always_rf),s.rctl_range(""+t.remote_radius),s.rctl_server(t.rc_server),s.rctl_key(t.authkey),s.igate_on=t.igate,s.rfgate_allow=t.rfigate,s.obj_rfgate=t.objigate,s.remotectl_on=t.remotectl,m.redraw()})}onActivate(){this.getConfig()}},pol.widget.setFactory("psadmin.ServerConfig",{create:()=>new pol.psadmin.ServerConfig})})(),(()=>{var pol=window.pol;window.pol.psadmin=window.pol.psadmin||{},pol.psadmin.OwnposConfig=class extends pol.core.Widget{constructor(){super();var e=this;e.classname="psadmin.OwnposConfig",e.txon=!1,e.allowrf=!1,e.compress=!1,e.symbol=m.stream("/."),e.digipath=m.stream(""),e.descr=m.stream(""),e.pos=[0,0],e.gpson=!1,e.adjustclock=!1,e.gpsport=m.stream(""),e.gpsbaud=m.stream(""),e.minpause=m.stream(""),e.maxpause=m.stream(""),e.mindist=m.stream(""),e.maxturn=m.stream(""),e.sym=m.stream("c"),e.symtab=m.stream("/"),e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()});const t={view:function(){return m("span.symselect",[m(pol.ui.textInput,{id:"symtab",size:1,maxLength:1,value:e.symtab,regex:/[\/\\a-zA-Z]/i}),m(pol.ui.textInput,{id:"symbol",size:1,maxLength:1,value:e.sym,regex:/[a-zA-Z]/i}),m(pol.ui.select,{id:"symSelect",onchange:r,list:[{label:"Post",val:"/c"},{label:"Sign",val:"\\m"},{label:"Cross",val:"\\."},{label:"Triangle",val:"\\n"},{label:"Red Cross",val:"/+"},{label:"OPS/EOS",val:"/o"},{label:"Radio Station",val:"/r"}]})])}};function s(){e.txon=!e.txon}function i(){e.allowrf=!e.allowrf}function a(){e.compress=!e.compress}function n(){e.gpson=!e.gpson}function l(){e.adjustclock=!e.adjustclock}function r(){const t=$("#symSelect").val();e.symtab(t[0]),e.sym(t[1]),m.redraw()}function o(){console.log("sym",e.symtab(),e.sym());const t={txon:e.txon,allowrf:e.allowrf,compress:e.compress,symbol:""+e.symtab().charAt(0)+e.sym().charAt(0),rfpath:e.digipath(),comment:e.descr(),pos:e.pos,gpson:e.gpson,adjustclock:e.adjustclock,gpsport:e.gpsport(),baud:parseInt(e.gpsbaud()),minpause:parseInt(e.minpause()),maxpause:parseInt(e.maxpause()),mindist:parseInt(e.mindist()),maxturn:parseInt(e.maxturn())};CONFIG.server.PUT("system/adm/ownpos",JSON.stringify(t),t=>{console.log("Update succeeded"),e.successMsg("Update succeeded. Reboot may be necessary",1e4)},(t,s,i)=>{console.log("Server update failed",s,i),e.errMsg("Server update failed: "+i,1e4)})}this.widget={view:function(){return m("div#ownposConfig",[m("h1","Tracking of own position"),null!=e.errmsg?m("div#errmsg",e.errmsg):null,null!=e.successmsg?m("div#successmsg",e.successmsg):null,m("div.field",m("span.wleftlab","Position report:"),m(pol.ui.checkBox,{id:"ownpos_txon",onclick:s,checked:e.txon},"Activate"),m(pol.ui.checkBox,{id:"ownpos_rf",onclick:i,checked:e.allowrf},"Allow transmission on RF")),m("div.field",m("span.wleftlab",""),m(pol.ui.checkBox,{id:"ownpos_compress",onclick:a,checked:e.compress},"Compress")),pol.ui.br,m("div.field",m("span.wleftlab","Symbol:"),m(t)),m("div.field",m("span.wleftlab","Digipeater path:"),m(pol.ui.textInput,{id:"ownpos_digipath",value:e.digipath,size:28,maxLength:32,regex:/[a-zA-Z0-9\,\-]*/i})),m("div.field",m("span.wleftlab","Description:"),m(pol.ui.textInput,{id:"ownpos_descr",value:e.descr,size:28,maxLength:32,regex:/.*/i})),pol.ui.br,m("div.field",m("span.wleftlab","Default position: "),m(pol.ui.latLngInput,{value:e.pos})),pol.ui.br,m("div.field",m("span.wleftlab","Tracking with GPS:"),m(pol.ui.checkBox,{id:"ownpos_gpson",onclick:n,checked:e.gpson},"Activate"),m(pol.ui.checkBox,{id:"ownpos_adjustclk",onclick:l,checked:e.adjustclock},"Adjust clock from GPS")),m("div.field",m("span.wleftlab","GPS Port:"),m(pol.ui.textInput,{id:"ownpos_gpsport",value:e.gpsport,size:15,maxLength:32,regex:/[a-zA-Z0-9\/\-]*/i})),m("div.field",m("span.wleftlab","GPS Baud:"),m(pol.ui.textInput,{id:"ownpos_gpsbaud",value:e.gpsbaud,size:8,maxLength:10,regex:/[0-9]*/i})),pol.ui.br,m("div.field",m("span.wleftlab","Min pause:"),m(pol.ui.textInput,{id:"ownpos_minpause",value:e.minpause,size:5,maxLength:8,regex:/[0-9]*/i})),m("div.field",m("span.wleftlab","Max pause:"),m(pol.ui.textInput,{id:"ownpos_maxpause",value:e.maxpause,size:5,maxLength:8,regex:/[0-9]*/i})),m("div.field",m("span.wleftlab","Min distance:"),m(pol.ui.textInput,{id:"ownpos_mindist",value:e.mindist,size:5,maxLength:8,regex:/[0-9]*/i})),m("div.field",m("span.wleftlab","Max turn:"),m(pol.ui.textInput,{id:"ownpos_maxturn",value:e.maxturn,size:5,maxLength:8,regex:/[0-9]*/i})),m("div.butt",[m("button",{type:"button",onclick:o},"Update"),m("button",{type:"button",onclick:()=>{e.clear()}},"Clear")])])}}}clear(){}getConfig(){CONFIG.server.GET("system/adm/ownpos","",e=>{const t=GETJSON(e),s=this;s.txon=t.txon,s.allowrf=t.allowrf,s.compress=t.compress,s.sym(t.symbol.charAt(1)),s.symtab(t.symbol.charAt(0)),s.digipath(t.rfpath),s.descr(t.comment),s.pos=t.pos,s.gpson=t.gpson,s.adjustclock=t.adjustclock,s.gpsport(t.gpsport),s.gpsbaud(""+(t.baud>0?t.baud:"")),s.minpause(""+(t.minpause>0?t.minpause:"")),s.maxpause(""+(t.maxpause>0?t.maxpause:"")),s.mindist(""+(t.mindist>0?t.mindist:"")),s.maxturn(""+(t.maxturn>0?t.maxturn:"")),m.redraw()},(e,t,s)=>{console.log("Failed to fetch data from server:",t,s),this.errMsg("Failed to fetch data from server: "+s,1e4)})}onActivate(){this.getConfig()}},pol.widget.setFactory("psadmin.OwnposConfig",{create:()=>new pol.psadmin.OwnposConfig})})(),(()=>{var pol=window.pol;pol.psadmin.Channels=class extends pol.core.Widget{constructor(){super();const e=this,t=CONFIG.server;e.editMode=!1,e.clist=[],e.rclist=[],e.rcfilter=m.stream(""),e.chanSelect="",e.classname="psadmin.Channels",e.type="APRSIS",e.clearAllVars(),e.typelist=[{label:"APRSIS"},{label:"APRSIS-SRV"},{label:"KISS"},{label:"TCPKISS"},{label:"TNC2"},{label:"ROUTER"}];const s={view:function(){return e.editMode&&null!=e.ch?m("span",e.ch.specific.type):m("span.ctypeselect",[m(pol.ui.select,{id:"ctypeSelect",onchange:h,list:e.typelist})])}},i={view:function(){let t,s=[];for(t of e.clist)"APRSIS"!=t.specific.type&&"APRSIS-SRV"!=t.specific.type||s.push({label:t.name});return m(pol.ui.select,{id:"chanSelect",list:s})}},a={view:function(){let t=0;return m("table.myChannels",m("tbody",e.clist.map(s=>m("tr",{class:e.editMode&&s.name===e.name()?"selected":null},[m("td",m(pol.ui.removeEdit,{remove:pol.ui.apply(w,t),edit:pol.ui.apply(v,t++)})),m("td.flags",c(s)),m("td",s.generic.inRouter?m("img",{src:"images/16px/router.png",title:"Via router"}):"ROUTER"===s.specific.type?m("img",{src:"images/16px/router2.png"}):null),m("td",s.specific.type),m("td.name",s.name),m("td","OFF"!=s.generic.state?"RUNNING"===s.generic.state?m("img",{src:"images/16px/ok.png"}):"FAILED"===s.generic.state?m("img",{src:"images/16px/warn.png",title:"Failed"}):m("img",{src:"images/16px/maybe.png",title:"trying..."}):null)]))))}},n={view:function(){return m("div#stats",[m("div.field",m("span.lleftlab","Traffic in:"),m("span",e.ch.specific.heardpackets)),m("div.field",m("span.lleftlab","Traffic out:"),m("span",e.ch.specific.sentpackets)),"APRSIS"===e.type?m("div.field",m("span.lleftlab","Blocked pkts:"),m("span",e.ch.specific.blocked)):null,"APRSIS-SRV"===e.type?m("div.field",m("span.lleftlab","Clients:"),m("span",e.ch.specific.nclients),nbsp,pol.ui.nbsp,m("span.link_id",{onclick:I},"(show)")):null])}},l={view:function(){return m("div#stats",[m("div.field",m("span.lleftlab","AIS packets:"),m("span",e.ch.specific.messages)),m("div.field",m("span.lleftlab","Vessels:"),m("span",e.ch.specific.vessels))])}},r={view:function(){return"AIS-TCP"===e.type||"AIS-SERIAL"===e.type?m(l):m(n)}},o={view:function(){return m("div.rChannels",[e.rclist.map(e=>m("div.field",m("span.lleftlab",{title:"Filter for traffic TO the channel"},"Filter '"+e.name+"' :"),m(pol.ui.textInput,{id:"filt"+e.name,value:e.filter,size:29,maxLength:64,regex:/.*/i}))),m("div.field",m("span.lleftlab","Connect chan:"),m(i),m("span.add",{title:"Add connected channel",onclick:f},"+"))])}},d={view:function(){return"KISS"===e.type||"TNC2"===e.type||"AIS-SERIAL"===e.type?m("div#config",[m("div.field",m("span.lleftlab","Channel:"),m(pol.ui.checkBox,{id:"activated",onclick:p,checked:e.activated},"Activate"),m(pol.ui.checkBox,{id:"activated",onclick:g,checked:e.primary},"Primary")),m("div.field",m("span.lleftlab","Serial port:"),m(pol.ui.textInput,{id:"serport",value:e.serport,size:15,maxLength:32,regex:/[a-zA-Z0-9\-\.\/]*/i})),m("div.field",m("span.lleftlab","Baud:"),m(pol.ui.textInput,{id:"baud",value:e.baud,size:8,maxLength:10,regex:/[0-9]*/i})),"KISS"===e.type?m("div.field",m("span.lleftlab","KISS port:"),m(pol.ui.textInput,{id:"kissport",value:e.kissport,size:3,maxLength:3,regex:/[0-9]*/i})):null]):"TCPKISS"===e.type||"AIS-TCP"===e.type?m("div#config",[m("div.field",m("span.lleftlab","Channel:"),m(pol.ui.checkBox,{id:"activated",onclick:p,checked:e.activated},"Activate"),m(pol.ui.checkBox,{id:"activated",onclick:g,checked:e.primary},"Primary")),m("div.field",m("span.lleftlab","Server addr:"),m(pol.ui.textInput,{id:"host",value:e.host,size:15,maxLength:32,regex:/[a-zA-Z0-9\-\.]*/i})),m("div.field",m("span.lleftlab","Server port:"),m(pol.ui.textInput,{id:"port",value:e.port,size:6,maxLength:6,regex:/[0-9]*/i})),"AIS-TCP"!==e.type?m("div.field",m("span.lleftlab","KISS port:"),m(pol.ui.textInput,{id:"kissport",value:e.kissport,size:3,maxLength:3,regex:/[0-9]*/i})):null]):"APRSIS-SRV"===e.type?m("div#config",[m("div.field",m("span.lleftlab","Channel:"),m(pol.ui.checkBox,{id:"activated",onclick:p,checked:e.activated},"Activate"),m(pol.ui.checkBox,{id:"activated",onclick:g,checked:e.primary},"Primary")),m("div.field",m("span.lleftlab","Listen port:"),m(pol.ui.textInput,{id:"port",value:e.port,size:6,maxLength:6,regex:/[0-9]*/i})),m("div.field",m("span.lleftlab",{title:"Internal filter for all incoming traffic"},"Input filter:"),m(pol.ui.textInput,{id:"filter",value:e.filter,size:30,maxLength:64,regex:/.*/i})),m("div.field",m("span.lleftlab",{title:"Default for client logins (clients may override)"},"Default filter:"),m(pol.ui.textInput,{id:"dfilter",value:e.dfilter,size:30,maxLength:64,regex:/.*/i}))]):"ROUTER"===e.type?m("div#config",[m("div.field",m("span.lleftlab","Channel:"),m(pol.ui.checkBox,{id:"activated",onclick:p,checked:e.activated},"Activate"),m(pol.ui.checkBox,{id:"activated",onclick:g,checked:e.primary},"Primary")),m(o)]):m("div#config",[m("div.field",m("span.lleftlab","Channel:"),m(pol.ui.checkBox,{id:"activated",onclick:p,checked:e.activated},"Activate"),m(pol.ui.checkBox,{id:"activated",onclick:g,checked:e.primary},"Primary")),m("div.field",m("span.lleftlab","Server addr:"),m(pol.ui.textInput,{id:"host",value:e.host,size:15,maxLength:32,regex:/[a-zA-Z0-9\-\.]*/i})),m("div.field",m("span.lleftlab","Server port:"),m(pol.ui.textInput,{id:"port",value:e.port,size:6,maxLength:6,regex:/[0-9]*/i})),m("div.field",m("span.lleftlab","Passcode:"),m(pol.ui.textInput,{id:"passcode",value:e.passcode,size:6,maxLength:6,regex:/[0-9]*/i})),m("div.field",m("span.lleftlab",{title:"Filter to be used with server"},"Filter:"),m(pol.ui.textInput,{id:"filter",value:e.filter,size:29,maxLength:64,regex:/.*/i})),m("div.field",m("span.lleftlab",{title:"Internal filter"},"Input filter:"),m(pol.ui.textInput,{id:"xfilter",value:e.xfilter,size:29,maxLength:64,regex:/.*/i}))])}};function c(e){let t="";return e.isaprs?t+="a":t+="-",e.isrf?t+="r":t+="-",e.rfchan||e.inetchan?t+="P":t+="-",t}function p(){e.activated=!e.activated}function u(){e.loggedinonly=!e.loggedinonly}function g(){e.primary=!e.primary}function h(){const t=$("#ctypeSelect").val();e.type=t,m.redraw()}function f(){const t=$("#chanSelect").val();e.rclist.push({name:t,filter:m.stream("*")})}function v(t){const s=e.clist[t];e.name(""),e.name(s.name),m.redraw(),e.getChannel(s.name),e.editMode=!0,null!=e.chanUpd&&clearInterval(e.chanUpd),e.chanUpd=setInterval(()=>e.getChannel(s.name,!0),1e4)}function b(){let s={active:e.activated,name:e.name(),generic:{restricted:e.loggedinonly,state:"OFF",tag:""}};"KISS"===e.type?s.specific={port:e.serport(),baud:parseInt(e.baud()),kissport:parseInt(e.kissport())}:"TCPKISS"===e.type?s.specific={host:e.host(),port:parseInt(e.port()),kissport:parseInt(e.kissport())}:"TNC2"===e.type?s.specific={port:e.serport(),baud:parseInt(e.baud())}:"APRSIS"===e.type?s.specific={host:e.host(),port:parseInt(e.port()),pass:parseInt(e.passcode()),filter:e.filter(),xfilter:e.xfilter()}:"APRSIS-SRV"===e.type?s.specific={port:parseInt(e.port()),defaultfilt:e.dfilter()}:"AIS-TCP"===e.type?s.specific={host:e.host(),port:parseInt(e.port())}:"ROUTER"===e.type&&(s.specific={channels:y()}),s.specific.type=e.type,t.POST("system/adm/channels",JSON.stringify(s),()=>{console.log("Channel added: "+e.name()),e.successMsg("Channel added",1e4),e.getObjects()},(t,s,i)=>{console.warn("Couldn't add channel: ",e.name(),""),e.errMsg("Couldn't add channel",1e4)})}function w(t){const s=e.clist[t];e.remove(s.name)}function x(){e.ch.active=e.activated,e.ch.generic.restricted=e.loggedinonly,e.ch.generic.tag=e.tag(),e.ch.isaprs&&(e.ch.isrf?e.ch.rfchan=e.primary:e.ch.inetchan=e.primary),"TCPKISS"!==e.type&&"APRSIS"!==e.type&&"AIS-TCP"!==e.type||(e.ch.specific.host=e.host(),e.ch.specific.port=parseInt(e.port())),"TCPKISS"!==e.type&&"KISS"!==e.type||(e.ch.specific.kissport=parseInt(e.kissport())),"KISS"!==e.type&&"TNC2"!==e.type||(e.ch.specific.port=e.serport(),e.ch.specific.baud=parseInt(e.baud())),"APRSIS"===e.type&&(e.ch.specific.pass=parseInt(e.passcode()),e.ch.specific.filter=e.filter(),e.ch.specific.xfilter=e.xfilter()),"ROUTER"===e.type&&(e.ch.specific.channels=y()),"APRSIS-SRV"===e.type&&(e.ch.specific.port=parseInt(e.port()),e.ch.specific.filter=e.filter(),e.ch.specific.defaultfilt=e.dfilter()),t.PUT("system/adm/channels/"+e.name(),JSON.stringify(e.ch),()=>{console.log("Channel updated: "+e.name()),e.successMsg("Channel updated",1e4),e.getObjects()},(t,s,i)=>{console.warn("Couldn't update channel: "+i),e.errMsg("Couldn't update channel",1e4)})}function y(){let t=[];for(const s of e.rclist)t.push({name:s.name,filter:s.filter()});return t}function I(){console.warn("Clients display feature not yet implemented")}this.widget={view:function(){return m("div#channels",[m("h1","Data Channels Config"),m("div#chanList",m(a)),null!=e.errmsg?m("div#errmsg",e.errmsg):null,null!=e.successmsg?m("div#successmsg",e.successmsg):null,m("div.field",m("span.lleftlab","Name:"),e.editMode&&null!=e.ch?m("span",e.ch.name):m(pol.ui.textInput,{id:"name",value:e.name,size:15,maxLength:32,regex:/[a-zA-Z0-9\-\.]*/i})),m("div.field",m("span.lleftlab","Type:"),m(s)),null!=e.ch?m("div.field",m("span.lleftlab","State:"),m("span",e.ch.generic.state)):null,e.editMode&&null!=e.ch?m(r):null,m(d),"ROUTER"!=e.type?m("div.field",m("span.lleftlab","Visibility:"),m(pol.ui.checkBox,{id:"loggedinonly",onclick:u,checked:e.loggedinonly},"Only for logged in users")):null,"ROUTER"!=e.type?m("div.field",m("span.lleftlab","Tag:"),m(pol.ui.textInput,{id:"tag",value:e.tag,size:15,maxLength:32,regex:/[a-zA-Z0-9\-\.]*/i})):null,m("div.butt",[m("button",{type:"button",disabled:!!e.editMode,onclick:b},"Add"),m("button",{type:"button",disabled:!e.editMode,onclick:x},"Update"),m("button",{type:"button",onclick:()=>{e.clear()}},"New")])])}},CONFIG.server.hasService("ais")&&(e.typelist.push({label:"AIS-TCP"}),e.typelist.push({label:"AIS-SERIAL"})),e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()})}putRouterChannels(e){if(this.rclist=[],null!=e)for(const t of e)this.rclist.push({name:t.name,filter:m.stream(t.filter)})}onclose(){clearInterval(this.listUpd),null!=this.chanUpd&&clearInterval(this.chanUpd)}onActivate(){this.getObjects(),this.listUpd=setInterval(()=>this.getObjects(),1e4)}clear(){this.editMode=!1,this.clearAllVars(),null!=this.chanUpd&&clearInterval(this.chanUpd)}clearAllVars(){const e=this;e.tag=m.stream(""),e.name=m.stream(""),e.ch=null,e.activated=!1,e.primary=!1,e.host=m.stream(""),e.port=m.stream(""),e.serport=m.stream(""),e.baud=m.stream(""),e.kissport=m.stream(""),e.passcode=m.stream(""),e.filter=m.stream(""),e.dfilter=m.stream(""),e.xfilter=m.stream(""),e.channels=m.stream(""),e.rclist=[]}getObjects(){CONFIG.server.GET("system/adm/channels",null,e=>{this.clist=GETJSON(e),this.clist.sort((e,t)=>e.specific.type>t.specific.type?1:e.specific.type<t.specific.type?-1:e.name>t.name?1:e.name<t.name?-1:0),m.redraw()},(e,t,s)=>{console.warn("Couldn't get channel-list: ",s),this.errMsg("Couldn't get channel-list",1e4)})}getChannel(e,t){CONFIG.server.GET("system/adm/channels/"+e,null,e=>{this.ch=GETJSON(e),t||(this.type=this.ch.specific.type,this.host(this.ch.specific.host),this.port(""+this.ch.specific.port),this.kissport(""+this.ch.specific.kissport),this.passcode(""+this.ch.specific.pass),this.filter(null==this.ch.specific.filter?"*":this.ch.specific.filter),this.xfilter(null==this.ch.specific.xfilter?"*":this.ch.specific.xfilter),this.dfilter(null==this.ch.specific.defaultfilt?"":this.ch.specific.defaultfilt),this.activated=this.ch.active,this.primary=this.ch.rfchan||this.ch.inetchan,this.loggedinonly=this.ch.generic.restricted,this.tag(this.ch.generic.tag),this.putRouterChannels(this.ch.specific.channels),m.redraw())},(t,s,i)=>{console.warn("Couldn't get channel-information: ",e,i),this.errMsg("Couldn't get channel-information: "+e,1e4)})}removeRouterChan(e){let t;for(t in this.rclist)if(e==this.rclist[t].name==e)break;t==this.rclist.length&&this.rclist[t].name!=e||this.rclist.splice(t,1)}remove(e){e&&null!=e&&0!=confirm("Remove - are you sure?")&&srv.DELETE("system/adm/channels/"+e,()=>{console.log("Removed channel: "+e),this.successMsg("Channel deleted",1e4),this.getObjects(),this.removeRouterChan(e),this.name()===e&&this.clear()},(t,s,i)=>{console.warn("Couldn't delete channel: ",e,i),this.errMsg("Couldn't delete channel: "+e,1e4)})}},pol.widget.setFactory("psadmin.Channels",{create:()=>new pol.psadmin.Channels})})(),(()=>{var pol=window.pol;window.pol.psadmin=window.pol.psadmin||{},pol.psadmin.TestRest=class extends pol.core.Widget{constructor(){super();var e=this;e.server=CONFIG.server,e.classname="psadmin.TestRest",e.url=m.stream(""),e.method=m.stream("GET"),e.body=null,e.sel={json:!1,hdrs:!1},e.response="",e.headers=[{name:m.stream(""),val:m.stream("")}];var t={view:function(){var t=0;return m("span.headerEdit",e.headers.map(s=>(t++,m("span",[m(pol.ui.textInput,{value:s.name,size:10})," ",m(pol.ui.textInput,{value:s.val,size:20}),t<e.headers.length?br:m("span.plus",{onclick:i},"+")]))))}};function s(){e.sel.json=!e.sel.json}function i(){e.headers.push({name:m.stream(""),val:m.stream("")}),m.redraw()}function a(){e.headers=[{name:m.stream(""),val:m.stream("")}],m.redraw()}function n(){e.sel.hdrs=!e.sel.hdrs,m.redraw()}function l(){const t=$("#methodSelect").val();e.method(t),m.redraw()}function r(){let t={};for(const s of e.headers)""!=s.name()&&""!=s.val&&(t[s.name()]=s.val());return t}function o(){e.response="",e.body=$("#body").val(),m.redraw(),"GET"===e.method()?e.server.GET(e.url(),null,d,c,null,r()):"POST"===e.method()?e.server.POST(e.url(),e.body,d,c,null,r()):"PUT"===e.method()?e.server.PUT(e.url(),e.body,d,c,null,r()):"DELETE"===e.method()&&e.server.DELETE(e.url(),d,c,null,r())}function d(t){if($("#testResp").removeClass("err").addClass("success"),e.sel.json)try{console.log("RESPONSE: ",GETJSON(t)),e.response="Success (JSON)"}catch(t){e.response="RETURN VALUE NOT JSON!!",$("#testResp").removeClass("success").addClass("err")}else console.log("RESPONSE: ",t),t.length<32?e.response="Success: '"+t+"'":!e.sel.json&&t.length<300?e.response=t:e.response="Success (see log)";m.redraw()}function c(t){e.response=t.statusText,console.log("ERROR: ",e.response),null!=t.responseText&&t.responseText.length<100?e.response+=": "+t.responseText:e.response+=" (see log)",m.redraw(),$("#testResp").removeClass("success").addClass("err")}this.widget={view:function(){return m("div#testrest",[m("h1","REST API Testbench"),m("div.field",m("span.xsleftlab","Method:"),m(pol.ui.select,{id:"methodSelect",onchange:l,list:[{label:"GET",val:"GET"},{label:"POST",val:"POST"},{label:"PUT",val:"PUT"},{label:"DELETE",val:"DELETE"}]})),m("div.field",m("span.xsleftlab","Resource:"),m(pol.ui.textInput,{id:"url",value:e.url,size:35,maxLength:35,regex:/.*/i})),"POST"===e.method()||"PUT"===e.method()?m("div.field",m("span.xsleftlab","Body:"),m("textarea",{id:"body",value:e.body,size:256})):null,e.sel.hdrs?m("div.field",m("span.xsleftlab","Headers:"),m(t)):null,m("div.field",m("span.xsleftlab","Select: "),m(pol.ui.checkBox,{id:"sel.json",onclick:s,checked:e.sel.json,title:"Check to parse response data as JSON"},"JSON resp",pol.ui.nbsp,pol.ui.nbsp),m(pol.ui.checkBox,{id:"vis.zoom",onclick:n,checked:e.sel.hdrs,title:"Check to edit headers for request"},"Headers",pol.ui.nbsp,pol.ui.nbsp)),br,m("div#testResp",e.response),m("div.butt",[m("button",{type:"button",onclick:o},"SEND"),m("button",{type:"button",onclick:a},"Clr Hdr")])])}}}},pol.widget.setFactory("psadmin.TestRest",{create:()=>new pol.psadmin.TestRest})})()})();