(()=>{var pol=window.pol;window.pol.tracking=window.pol.tracking||{},pol.tracking.isSign=function(e){return 0===e.getId().indexOf("__")},pol.tracking.ctxName=function(e){return pol.tracking.isSign(e)?"photo"===e.point.type?"PHOTO":"SIGN":"POINT"},pol.tracking.Tracking=class{constructor(e,t){const s=this;s.zoom=0,s.contextOn=!1,s.filter=null,s.tag=null,s.ready=!1,s.server=e,s.srch=!1,s.tracked=null,CONFIG.get("tracking.tracked").then(e=>{s.tracked=e,"null"==s.tracked&&(s.tracked=null)}),s.iconpath="",CONFIG.get("iconpath").then(e=>{s.iconpath=e,null==s.iconpath&&(s.iconpath="")}),s.iconscale=t,null==s.iconscale&&(s.iconscale=1);var i=!0;s.producer=new pol.tracking.MapUpdate(s.server),s.showLabel={},CONFIG.get("tracking.showlabel").then(e=>{s.showLabel=e,null==s.showLabel&&(s.showLabel={})}),s.showTrail={},CONFIG.get("tracking.showtrail").then(e=>{s.showTrail=e,null==s.showTrail&&(s.showTrail={})}),s.layer=CONFIG.mb.addVectorLayer(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#d11",width:2})})),s.onOpenHandler=null,s.source=this.layer.getSource();const n=new URLSearchParams(window.location.search);function r(){s.srch}function o(){let e=Math.round(CONFIG.mb.getScale()/1e3);e>999?e=Math.round(e/100):e>99&&(e=Math.round(e/10));const t=e!=s.zoom;s.zoom=e,s.srch||(i?i=!1:(s.layer.setVisible(!0),t&&s.clear(),s.producer.subscribe(s.filter,e=>s.update(e),s.tag,1!=t)))}s.tag=n.get("tag"),CONFIG.mb.addContextMenu("MAP",e=>{const t=s.getPointsAt([e.clientX,e.clientY]);return t&&null!=t?t.length>1?(s.showList(t,[e.clientX,e.clientY],!0),{name:"_STOP_"}):(t.length>0&&(s.contextOn=!0),setTimeout(()=>{s.contextOn=!1},3e3),null==t[0]?null:{sarAuth:t[0].point.sarAuth,name:pol.tracking.ctxName(t[0]),ident:t[0].getId(),aprs:t[0].point.aprs,own:t[0].point.own,telemetry:t[0].point.telemetry,point:t[0]}):null}),CONFIG.mb.map.on("click",e=>{if(s.contextOn)return;const t=s.getPointsAt(e.pixel);if(null!=t&&t.length>0)if(1==t.length){const i=CONFIG.mb.lonLat2Pix(t[0].point.pos);s.createFeedback(i,1300),s.server.infoPopup(t[0],e.pixel)}else s.showList(t,e.pixel)}),CONFIG.mb.map.on("change:view",e=>{s.clear();const t=CONFIG.mb.map.getOverlays();setTimeout(()=>t.clear(),10),s.producer.subscribe(s.filter,e=>s.update(e),s.tag,!1)}),s.source.on("clear",()=>{s.clear()}),s.producer.onopen=function(){s.ready=!0,CONFIG.mb.map.on("movestart",r),CONFIG.mb.map.on("moveend",o),null!=s.filter&&s.producer.subscribe(s.filter,e=>s.update(e),s.tag,!1),null!=s.onOpenHandler&&s.onOpenHandler()}}onOpen(e){this.onOpen=e}isConnected(){return this.producer.isConnected()}reconnect(){this.producer.close(),setTimeout(()=>this.producer.open(),1500)}reportLayer(e){this.isConnected()&&this.producer.reportLayer(e)}close(){this.clear(),this.producer.close()}createFeedback(e,t){let s=document.getElementById("map"),i=document.createElement("div");s.appendChild(i),i.className="indicator",i.style.position="absolute",i.style.top=e[1]-13+"px",i.style.left=e[0]-13+"px",setTimeout(()=>{i.remove()},t)}showList(e,t,s){const i=this,n={view:function(){return m("div.pointlist",[m("table.items",e.map(e=>{let n=null!=e.alias?e.alias:"P"==e.point.href[0]?"(image)":"(point)";null!=e.point.type&&(n=e.point.type);let r=e.point.title.substring(0,64);return 64==r.length&&(r+=".."),m("tr",{onclick:n=>{i.redrawFeature(e.getId()),function(e,n){s?(CONFIG.mb.gui.removePopup(),CONFIG.mb.ctxMenu.showOnPos({sarAuth:n.point.sarAuth,name:pol.tracking.ctxName(n),ident:n.getId(),aprs:n.point.aprs,own:n.point.own,telemetry:n.point.telemetry,point:n},t)):i.server.infoPopup(n,t)}(0,e)}},[m("td",n),m("td",m.trust(r))])}))])}};CONFIG.mb.gui.showPopup({vnode:n,geoPos:CONFIG.mb.pix2LonLat(t)})}getLayerSource(){return this.source}redrawFeature(e){const t=this,s=t.source.getFeatureById(e);if(console.assert(null!=s,"feature=null"),null==s)return;const i=s.point;null!=i&&(i.redraw=!0,t.addPoint(i))}updateIconStyle(){const e=this.source.getFeatures();for(const t of e)this.setStyle(t)}clear(){const e=this.source.getFeatures();for(const t of e)this.removePoint(t.getId())}setFilter(e){console.assert(null!=e&&""!=e,"flt="+e),this.filter=e,this.ready&&(this.clear(),this.producer.subscribe(this.filter,e=>this.update(e),this.tag))}addPoint(e,t){console.assert(null!=e,"Assertion failed");let s="";null!=t&&t>0&&(s="."+t);const i=e.ident+s,n=ll2proj(e.pos);e.redraw&&this.removePoint(i),this._trailHidden(i,!1)||this.addTrail(e,t);let r=this.source.getFeatureById(i);if(null==r)r=new ol.Feature(new ol.geom.Point(n)),r.setId(i),this.source.addFeature(r);else if(!e.redraw)return;r.getGeometry().setCoordinates(n),null!=this.tracked&&this.tracked==i&&CONFIG.mb.setCenter(e.pos,70),null!=e.label&&(r.alias=e.label.id),r.point=e,this.setStyle(r),null==e.label||this._labelHidden(i,e.label.hidden)?r.label&&CONFIG.mb.map.removeOverlay(r.label):(r.label&&CONFIG.mb.map.removeOverlay(r.label),r.label=this.createLabel(n,i,e.label))}setStyle(e){const t=e.point;if(null==t)return;const s=new ol.style.Style({image:new ol.style.Icon({scale:this.iconscale*CONFIG.labelStyle.getIconScale(),anchor:[.5,.5],src:this.iconpath+t.icon,opacity:null!=t.label&&t.label.style.includes("lstill")?.8:1})});e.setStyle(s)}createPopupLabel(e,t,s){let i=document.createElement("div");i.className="popuplabel";let n=new ol.Overlay({element:i,offset:[-7,-1],insertFirst:!1,positioning:"center-left"});return n.setPosition(e),CONFIG.mb.map.addOverlay(n),i.onclick=function(n){CONFIG.mb.gui.removePopup(),i._clicked=!0,CONFIG.mb.gui.showPopup({geoPos:proj2ll(e),html:t+"<br>"+s}),n.stopPropagation()},n}createLabel(e,t,s){const i=this;console.assert(null!=e&&null!=s,"Assertion failed");let n=document.createElement("div");n.className=s.style,n.innerHTML=s.id,t==this.tracked&&$(n).addClass("tracked");let r=new ol.Overlay({element:n,offset:[14,0],insertFirst:!1,positioning:"center-left"});return r.setPosition(e),r.tracklabel=!0,CONFIG.mb.map.addOverlay(r),n.onclick=function(e){i.server.infoPopup(i.source.getFeatureById(t),[e.clientX,e.clientY]),e.stopPropagation()},n.onmouseenter=function(e){n._cancel=!1,setTimeout(()=>{n._cancel||i.redrawFeature(t),CONFIG.labelStyle&&CONFIG.labelStyle.setFont()},800)},n.onmouseleave=function(e){n._cancel=!0},n.oncontextmenu=function(e){const s=i.source.getFeatureById(t);CONFIG.mb.ctxMenu.showOnPos({name:"POINT",point:s.point,aprs:s.point.aprs,own:s.point.own,telemetry:s.point.telemetry,sarAuth:s.point.sarAuth,ident:t},[e.clientX,e.clientY])},r}_labelHidden(e,t){return null!=this.showLabel[e]?0==this.showLabel[e]:t}labelHidden(e){const t=this.source.getFeatureById(e);return null!=t&&this._labelHidden(e,!t.label||null==t.label)}hideLabel(e,t){this.showLabel[e]=!t;const s=this.source.getFeatureById(e);null!=s&&(t?(CONFIG.mb.map.removeOverlay(s.label),s.label=null):s.label=this.createLabel(s.getGeometry().getCoordinates(),e,s.point.label),CONFIG.mb.map.render(),CONFIG.store("tracking.showlabel",this.showLabel))}_trailHidden(e,t){return null!=this.showTrail[e]?0==this.showTrail[e]:t}trailHidden(e){const t=this.source.getFeatureById(e);return this.source.getFeatureById(e+".trail"),null!=t&&this._trailHidden(e,!1)}hideTrail(e,t){this.showTrail[e]=!t;const s=this.source.getFeatureById(e),i=this.source.getFeatureById(e+".trail"),n=this.source.getFeatureById(e+".trailpoints");t?(null!=i&&this.source.removeFeature(i),null!=n&&(this.source.removeFeature(n),this.removeTrailPoints(s.point))):null!=s.point&&this.addTrail(s.point),CONFIG.mb.map.render(),CONFIG.store("tracking.showtrail",this.showTrail)}addTrail(e,t){let s="";null!=t&&t>0&&(s="."+t);const i=e.ident+".trail"+s;console.assert(null!=e,"p is null");let n=this.source.getFeatureById(i);if(null!=n&&!e.redraw)return;if(null!=n&&this.source.removeFeature(n),null==e.trail)return;n=new ol.Feature(new ol.geom.LineString([ll2proj(e.pos)])),n.setId(i),this.source.addFeature(n);for(let t in e.trail.linestring)n.getGeometry().appendCoordinate(ll2proj(e.trail.linestring[t].pos));const r=new ol.style.Style({stroke:new ol.style.Stroke({color:"#"+e.trail.style[0],width:2*this.iconscale})});n.setStyle(r),CONFIG.mb.getResolution()<90&&this.addTrailPoints(e,t)}formatTime(e){const t=new Date(e);return t.getDate()+" "+["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"][t.getMonth()]+" "+(t.getHours()<10?"0":"")+t.getHours()+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+":"+(t.getSeconds()<10?"0":"")+t.getSeconds()}addTrailPoints(e,t){console.assert(null!=e,"p is null");let s="";null!=t&&t>0&&(s="."+t);const i=e.ident+".trailpoints"+s;let n=this.source.getFeatureById(i);null!=n&&this.source.removeFeature(n),n=new ol.Feature(new ol.geom.MultiPoint([])),n.setId(i),e.trail.labels=[];for(const t of e.trail.linestring)e.trail.labels.push(this.createPopupLabel(ll2proj(t.pos),this.formatTime(t.time),e.ident+(null!=t.path?"<br>Via: "+t.path:""))),CONFIG.mb.getResolution()<30&&null!=t.path&&"(ext)"!=t.path&&"(int)"!=t.path&&"AIS"!=t.path&&n.getGeometry().appendPoint(new ol.geom.Point(ll2proj(t.pos)));const r=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:"#"+e.trail.style[1]}),radius:2.1})});n.setStyle(r),this.source.addFeature(n)}removeTrailPoints(e){let t=this.source.getFeatureById(e.ident+".trailpoints");if(this.source.removeFeature(t),e.trail&&e.trail.labels){for(const t of e.trail.labels)CONFIG.mb.map.removeOverlay(t);e.trail.labels=[]}}addCoveragePoints(e,t,s){const i=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:"#"+s}),radius:5})}),n=new ol.Feature(new ol.geom.MultiPoint([]));n.setId(t+".coveragepoints");for(const t of e)n.getGeometry().appendPoint(new ol.geom.Point(ll2proj(t.pos)));n.setStyle(i),this.source.addFeature(n)}addLine(e){let t=new ol.Feature(new ol.geom.LineString([ll2proj(e.from),ll2proj(e.to)]));const s=new ol.style.Style({stroke:new ol.style.Stroke("prim"===e.type?{color:"#a00",width:1.6}:{color:"#00c",width:1.5,lineDash:[3,3]})});t.setStyle(s),t.setId("line."+e.ident),this.source.addFeature(t)}removePoint(e){if(null==e||""==e)return;const t=this.source.getFeatureById(e);null!=t&&(t.label&&CONFIG.mb.map.removeOverlay(t.label),this.source.removeFeature(t),t.point&&this.removeTrailPoints(t.point))}getPointsAt(e){console.assert(null!=e&&e[0]>=0&&e[1]>=null,"Assertion failed");const t=CONFIG.mb.map.getFeaturesAtPixel(e,{hitTolerance:CONFIG.server.mobile?15:6,layerFilter:e=>e==this.layer});return null==t?null:t.filter(e=>e.point)}goto_Point(e){console.assert(null!=e&&""!=e,"ident="+e);const t=CONFIG.server.isAuth()?"xpos":"pos";this.server.GET("item/"+e+"/"+t,null,e=>{if(null==e)return void console.log("Goto point: Not found on server");const t=GETJSON(e);CONFIG.mb.gui.removePopup(),CONFIG.mb.goto_Pos(t,!1)})}searchMode(e){!this.srch&&e&&this.clear(),this.srch&&!e&&(this.clear(),this.producer.subscribe(this.filter,e=>this.update(e),this.tag)),this.srch=e}setTracked(e){this.tracked=e,this.clear(),this.producer.subscribe(this.filter,e=>this.update(e),this.tag),CONFIG.store("tracking.tracked",null==e?"null":e)}isTracked(e){return null!=this.tracked&&this.tracked==e}update(e,t,s){if((!this.srch||t)&&null!=e){if(e.overload)return console.log("Overload (too many points in overlay generation)"),void CONFIG.filt.setDisabled(!0);CONFIG.filt.setDisabled(!1),!t&&this.srch&&this.clear(),this.srch=t;for(let t in e.points)this.addPoint(e.points[t],s);for(let t in e.lines)this.addLine(e.lines[t]);null!=e.pcloud&&this.addCoveragePoints(e.pcloud,e.ident,e.color);for(let t in e.delete)this.removePoint(e.delete[t]);CONFIG.mb.map.render(),CONFIG.labelStyle&&CONFIG.labelStyle.setFont()}}}})(),(()=>{var pol=window.pol;window.pol.core=window.pol.core||{},window.pol.tracking=window.pol.tracking||{},pol.tracking.ServerManager=class{constructor(e,t){this.mobile=e,this.callback=t}instantiate(){const e=new pol.tracking.PolaricServer(this.mobile);return null!=this.callback&&this.callback(e),e}},pol.tracking.PolaricServer=class extends pol.core.Server{constructor(e){super(),this.auth={userid:"",groupid:"",callsign:"",servercall:"",admin:!1,sar:!1,nclients:0,services:""},this.hasDb=!1;const t=this;t.userid="_NONE_",t.temp_role=null,t.key=null,t.authOk=!1,t.authCallbacks=[],t.startcb=null,t.stopcb=null,t.cbId=0,t.mobile=e,t.init(),setInterval(()=>{this.loginStatus()},36e4)}async init(e){const t=this;await pol.sleep(1500),await super._init(e),await t.restoreCredentials(),t.pubsub=new pol.tracking.PubSub(this),null!=t.startcb&&t.startcb(),t.loginStatus(),t.pubsub.onopen=function(){},t.pubsub.onclose=function(){}}stop(){this.key=null,null!=this.stopcb&&this.stopcb()}getRole(){return null!=this.temp_role?this.temp_role:this.auth.groupid}async genAuthString(e){const t=pol.security.getRandom(8),s=await this.getHmac(t,e);if(null==s)return null;let i="";return null!=this.temp_role&&(i=";"+this.temp_role),this.userid+";"+t+";"+s+i}async genHeaders(e){const t=await this.genAuthString(e);return null==t?null:{Authorization:"Arctic-Hmac "+t}}async getHmac(e,t){let s="";return null==this.key?null:(null!=t&&""!=t&&(s=await pol.security.Sha256_B64(t)),await pol.security.hmac_Sha256_B64(this.key,e+s))}async setCredentials(e,t){const s=await pol.security.hmac_getKey(t);this.key=s,await CONFIG.remove("api.key"),this.mobile?(await CONFIG.store("api.key",t),await CONFIG.store("api.userid",e)):(CONFIG.storeSes("api.key",t),CONFIG.storeSes("api.userid",e)),this.userid=e}async restoreCredentials(){const e=await CONFIG.get("api.key"),t=await CONFIG.get("api.userid");null!=t&&(this.userid=t),null==e||64!=e.length?this.key=null:this.key=await pol.security.hmac_getKey(e)}onStart(e){this.startcb=e}onStop(e){this.stopcb=e}onLogin(e,t){this.logincb=e,this.logoutcb=t}removeKey(){CONFIG.remove("api.key"),this.key=null}isAuth(){return null!=this.key&&this.authOk}clearAuth(){this.removeKey(),this.loginStatus()}addAuthCb(e){return this.cbId++,this.authCallbacks.push({cbid:this.cbId,func:e}),this.cbId}removeAuthCb(e){for(const t in this.authCallbacks)this.authCallbacks[t].cbid==e&&this.authCallbacks.slice(t)}putObj(e,t,s){this.POST("objects/"+e,JSON.stringify(t),e=>{console.log("Added server object for user: "+this.auth.userid),"function"==typeof s&&s(e)},(e,t,s)=>{console.log("ERROR: ",s)})}updateObj(e,t,s,i){this.PUT("objects/"+e+"/"+t,JSON.stringify(s),e=>{console.log("Updated server object "+t+" for user "+this.auth.userid),"function"==typeof i&&i(e)},(e,t,s)=>{console.log("ERROR: ",s)})}removeObj(e,t,s){this.DELETE("objects/"+e+"/"+t,e=>{console.log("Server object "+t+" for user "+this.auth.userid+": "+e+" objects removed"),"function"==typeof s&&s(GETJSON(e))},(e,t,s)=>{console.log("ERROR: ",s)})}getObj(e,t){this.GET((this.isAuth()?"":"open/")+"objects/"+e,"",e=>t(GETJSON(e)))}hasService(e){for(const t of this.auth.services)if(t===e)return!0;return!1}async setAltServer(){null!=await CONFIG.get("alt_server")&&(this.pubsub.close(),CONFIG.tracks.close(),this.stop(),this.init(!0))}async checkLoad(){const e=await CONFIG.get("max_clients");null!=e&&this.auth.nclients>e&&this.setAltServer()}loginStatus(){this.GET("authStatus","",e=>{this.authOk&&null==this.temp_role||(this.auth=GETJSON(e),this.checkLoad(),this.authOk=!0,this.hasDb=this.hasService("database"),this.pubsub.close(),this.doAuthCb(),null!=this.logincb&&this.logincb())},(e,t,s)=>{this.authOk&&(this.pubsub.close(),this.authOk=!1,this.doAuthCb(),null!=this.logoutcb&&this.logoutcb(s)),this.loginStatus2()})}loginStatus2(){this.GET("authStatus2","",e=>{this.auth=GETJSON(e),this.checkLoad(),this.hasDb=this.hasService("database")},null)}doAuthCb(){for(const e of this.authCallbacks)e.func()}getPhoto(e,t){this.GET((this.isAuth()?"":"open/")+"photos/"+e,"",e=>{const s=GETJSON(e);t(s)})}infoPopup(e,t){console.assert(null!=e,"(infopopup) p==null"),CONFIG.mb.gui.removePopup(),pol.tracking.isSign(e)?0===e.point.href.indexOf("P:")?CONFIG.mb.gui.imagePopup(e.point.title,e.point.href,{draggable:!0,id:"imagepopup",pixPos:this.mobile?[0,0]:t}):"photo"===e.point.type?this.getPhoto(e.point.ident.substring(5),e=>{CONFIG.mb.gui.imagePopup(e.descr+" - "+formatDTG(e.time)+(this.isAuth()&&this.userid===e.userid?"":" (by "+e.userid+")"),"  data:image/jpeg;base64, "+e.image,{draggable:!0,id:"imagepopup",pixPos:this.mobile?[0,0]:t})}):CONFIG.mb.gui.showPopup({pixPos:t,html:e.point.href?'<a href="'+e.point.href+'">'+e.point.title+"</a>":e.point.title}):POPUP("tracking.PointInfo",t,t=>t.getItem(encodeURIComponent(e.point.ident)))}}})(),window.pol.tracking.PubSub=class{constructor(e){const t=this;t.server=e,t.suspend=!1,t.retry=-1,t.cretry=0,t.firstopen=!0,t.kalive=null,t.onopen=null,t.onclose=null,t.subscriptions=[],t.rooms={},t.open(),setInterval(()=>{0==t.retry?t.open():t.retry>0&&t.retry--},5e3)}open(){const e=this;e.retry=-1;let t=e.server.wsurl;function s(){null!=e.onclose&&e.onclose()}function i(){e.retry=0==e.cretry?2:2*e.retry,e.cretry<10?e.cretry++:(console.log("Giving up connecting (pubsub)"),e.retry=-1)}t+="notify",console.log("Opening Websocket. URL: "+t),CONFIG.server.genAuthString(null).then(n=>{e.websocket=new WebSocket(t+(null==n?"":"?"+n)),e.websocket.onopen=function(){console.log("Connected to server (for notify service)."),$("#warnmode").addClass("warn_hidden"),null!=e.onopen&&e.firstopen&&e.onopen(),e.firstopen=!1,e.restoreSubs(),e.retry=-1,e.cretry=0,null!=e.kalive&&clearInterval(e.kalive),e.kalive=setInterval(()=>e.websocket.send("****"),12e4)},e.websocket.onmessage=function(t){const s=t.data.indexOf(","),i=t.data.slice(0,s),n=t.data.slice(s+1),r=e.rooms[i];if(!e.suspend&&null!=r)for(const e in r)r[e].json?r[e].cb(JSON.parse(n)):r[e].cb(n)},e.websocket.onclose=function(t){clearInterval(e.kalive),e.closed?console.log("Connection closed"):(console.log("Lost connection to server (pubsub): ",t.code,t.reason),s(),1e3==t.code?e.retry=5:i())},e.websocket.onerror=function(t){console.log("Server connection error (pubsub)"),e.closed||(clearInterval(e.kalive),i(),s())}})}suspend(e){console.assert(e>0,"Assertion failed"),this.suspend=!0,setTimeout(()=>{this.suspend=!1},e)}isConnected(){return null!=this.websocket&&this.websocket.readyState===Websocket.OPEN}close(){this.websocket.close()}putText(e,t){this.websocket.send("PUT,"+e+","+t)}put(e,t){this.putText(e,JSON.stringify(t))}restoreSubs(){for(const e of Object.keys(this.rooms))this.websocket.send("SUBSCRIBE,"+e)}subscribe(e,t,s){return console.assert(null!=e&&""!=e,"Room is null or blank"),console.assert(null!=t,"Client is null"),this.rooms[e]&&null!=this.rooms[e]||(this.rooms[e]=new Array,this.websocket.send("SUBSCRIBE,"+e)),this.rooms[e].push({cb:t,json:!s}),this.suspend=!1,t}unsubscribeAll(e){this.rooms[e]=null}unsubscribe(e,t){console.assert(null!=e&&""!=e&&this.rooms[e]&&null!=this.rooms[e]&&null!=t,"Assertion failed");var s=this.rooms[e];if(null!=s&&0!=s.length)if(1==s.length)this.rooms[e]=null,this.websocket.send("UNSUBSCRIBE,"+e);else for(let e in s)s[e].cb==t&&s.splice(e,1)}},window.pol.tracking.MapUpdate=class{constructor(e){const t=this;t.suspend=!1,t.retry=-1,t.cretry=0,t.server=e,t.kalive=null,t.closed=!1,t.firstopen=!0,t.onopen=null,t.subscriber=null,t.open(),setInterval(()=>{0==t.retry?t.open():t.retry>0&&t.retry--},5e3)}open(){const e=this;e.closed=!1,e.retry=-1;let t=e.server.wsurl;function s(){null!=e.onclose&&e.onclose()}function i(){e.retry=0==e.cretry?2:2*e.retry,e.cretry<10?e.cretry++:(console.log("Giving up connecting (tracking overlay)"),e.retry=-1)}t+="jmapdata",console.log("Opening Websocket. URL: "+t),CONFIG.server.genAuthString(null).then(n=>{e.websocket=new WebSocket(t+(CONFIG.server.phone?"?_MOBILE_"+(null==n?"":"&"+n):null==n?"":"?"+n)),e.websocket.onopen=function(){console.log("Connected to server (for tracking overlay)."),$("#warnmode").addClass("warn_hidden"),null!=e.onopen&&e.onopen(),e.firstopen=!1,e.retry=-1,e.cretry=0,null!=e.kalive&&clearInterval(e.kalive),e.reportLayer(CONFIG.mb.baseLayerName),e.kalive=setInterval(()=>{e.websocket.send("****")},12e4)},e.websocket.onmessage=function(t){if(!e.suspend&&null!=e.subscriber)try{e.subscriber(JSON.parse(t.data))}catch(e){console.warn("Cannot parse data from server: ",t.data)}},e.websocket.onclose=function(t){clearInterval(e.kalive),e.closed?console.log("Connection closed (for tracking overlay)"):(console.log("Lost connection to server (for tracking overlay): ",t.code),s(),1e3==t.code?e.retry=5:i())},e.websocket.onerror=function(t){console.log("Server connection error (tracking overlay): "),e.closed||(clearInterval(e.kalive),i(),s())}})}suspend(e){console.assert(e>0,"(suspend) time<=0"),this.suspend=!0,setTimeout(()=>{this.suspend=!1},e)}isConnected(){return null!=this.websocket&&this.websocket.readyState===WebSocket.OPEN}close(){this.closed=!0,this.websocket.close()}reportLayer(e){var t="BASELAYER,"+e;this.websocket.send(t)}subscribe(e,t,s,i){console.assert(null!=e&&""!=e,"(subscribe) flt is empty or null"),console.assert(null!=t,"(subscribe) c is null"),this.subscriber=t,this.suspend=!1;var n=CONFIG.mb.getExtent(),r=CONFIG.mb.getScale(),o=n[3],a=n[1],l="SUBSCRIBE,"+e+","+c(n[0])+","+c(a)+","+c(n[2])+","+c(o)+","+Math.round(r)+(i?",true":",false")+(s?","+s:"");function c(e){return Math.round(1e3*e)/1e3}this.websocket.send(l)}},(()=>{var pol=window.pol;pol.tracking.Search=class extends pol.core.Widget{constructor(){super(),this.classname="tracking.Search",this.server=CONFIG.server,this.tags=[],this.selected={};const e=this;function t(t){var s,i;s=e.search(),i=function(){let t="";for(let s in e.selected)t=t+(""==t?"":",")+s;return t}(),e.server.GET((CONFIG.server.isAuth()?"xitems":"items")+"?srch="+(null==s?"*":s)+(null!=i?"&tags="+i:""),null,t=>{e.result=GETJSON(t),m.mount($("div#searchresult").get(0),e.showRes),e.setScrollTable("div#search","div#searchresult"),$("span#found").text(e.result.length+" items found")}),e.getTags()}function s(e){null!=e.pos&&(CONFIG.mb.gui.removePopup(),CONFIG.mb.goto_Pos(e.pos,!1))}function i(t){e.selected[t]?delete e.selected[t]:e.selected[t]=!0}function n(e){return e.name==e.ident&&null==e.alias?null:null!=e.alias?e.ident+(null==e.alias?"":" | Alias='"+e.alias+"'"):e.ident}function r(e){const t=e.ident.indexOf("@");let s="";return null!=e.alias&&(s="alias "),t>0?s+"obj":e.name!=e.ident?s+"name":s}function o(e){return e.name!=e.ident?e.name:null!=e.alias?e.alias:e.ident}function a(e){return e.length>60?e.substring(0,60)+" [..]":e}function l(e){return e<0?" ":e<22.5?"N":e<67.5?"NE":e<112.5?"E":e<157.5?"SE":e<202.5?"S":e<247.5?"SW":e<292.5?"W":e<337.5?"NW":"N"}e.search=m.stream("*"),e.result=[],e.showRes={view:()=>m("table",m("thead",m("tr",[m("th","Ident"),m("th","Updated"),m("th","Dir"),m("th","Description")])),m("tbody",e.result.map(e=>m("tr",[m("td.ident",{onclick:pol.ui.apply(s,e),title:n(e)},m("span."+r(e),o(e))),m("td",u(e.updated)),m("td",l(e.course)),m("td",a(e.descr))]))))},this.widget={view:()=>m("div#search",[m("h1","Search stations/objects"),m("div#searchform",[m("form",["Keywords (tags): ",pol.ui.br,m("div#tags",e.tags.filter(t=>function(t){const s=t.split(".");if(1==s.length)return!0;if(!e.tagUsed(e.tags,s[0]))return!0;for(let t in e.selected)if(s[0]==t.split(".")[0])return!0;return!1}(t)).map(t=>m(pol.ui.checkBox,{checked:e.selected[t],id:"tag_"+t,onchange:pol.ui.apply(i,t)},function(e,t){return e.substring(0,t-1)+(e.length>t?"..":"")}(t,20)))),"Free text search: ",m(pol.ui.textInput,{id:"search",size:10,maxLength:40,value:e.search,regex:/^.*$/i}),m("button#searchbutton",{onclick:t,type:"button"},"Search"),pol.ui.nbsp,m("span#found","")])],br,m("div#searchresult"))])};const c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function u(e){const t=new Date(e);return t.getDate()+" "+c[t.getMonth()]+" "+(t.getHours()<10?"0":"")+t.getHours()+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()}}tagUsed(e,t){for(let s in e)if(t==e[s])return!0;return!1}getTags(){this.server.GET("system/tags",null,e=>{this.tags=[];const t=GETJSON(e);for(const e in t)if("-"!=t[e].charAt(0))if("+"==t[e].charAt(0)){if(this.tagUsed(this.tags,t[e].substring(1)))continue;this.tags.push(t[e].substring(1))}else this.tags.push(t[e]);m.redraw()})}onActivate(){this.selected={},this.getTags(),m.redraw()}},pol.widget.setFactory("tracking.Search",{create:()=>new pol.tracking.Search})})(),window.pol.tracking.Filters=class{constructor(e){var t=this,s=CONFIG.server.auth.groupid;null!=s&&""!=s||(s="NOLOGIN"),t.filterViews=[],t.tracker=e,t.tbar=CONFIG.mb.toolbar,CONFIG.mb.ctxMenu.addCallback("FILTERSELECT",e=>{e.clear();for(const s in t.filterViews)e.add(t.filterViews[s][1],i(s));function i(e){return function(){$("#filterChoice").html(t.filterViews[e][1]),t.tracker.setFilter(t.filterViews[e][0]),CONFIG.storeSes("tracking.selectedfilt."+s,t.filterViews[e][0]),CONFIG.store("tracking.selectedfilt."+s,t.filterViews[e][0])}}}),t.getFilters(),async function(){t.filt=await CONFIG.get("tracking.selectedfilt."+s),(null==t.filt||""==t.filt)&&(t.filt=await CONFIG.get("default_filter."+s)),null!=t.filt&&""!=t.filt||(t.filt=await CONFIG.get("default_filter"))}()}addToolbarMenu(){this.tbar.addIcon(1,"images/filter.png","tb_filter",null,"Filter selector"),this.tbar.addDiv(1,"filterChoice",null),CONFIG.mb.ctxMenu.addMenuId("tb_filter","FILTERSELECT",!0)}setDisabled(e){1==e&&null!=t.tbar?this.tbar.changeIcon("tb_filter","images/filter.gray.png",null,"Too many points - overlay disabled"):this.tbar.changeIcon("tb_filter","images/filter.png",null,"Filter selector")}getFilters(){const e=CONFIG.server.isAuth()?"myfilters":"filters";CONFIG.server.GET(e,"",e=>{this.filterViews=GETJSON(e);var t=0;for(var s in 0==this.filterViews.length&&this.filterViews.push(["Null","No filters found"]),this.filterViews)if(this.filterViews[s][0]===this.filt){t=s;break}t>=this.filterViews.length&&(t=0),$("#filterChoice").html(this.filterViews[t][1]),this.tracker.setFilter(this.filterViews[t][0])})}},(()=>{var pol=window.pol;pol.tracking.Notifier=class{constructor(){this.list=[],this.server=CONFIG.server;var e=this;e.list=[],this.audio=new Audio("sound/sound2.wav"),CONFIG.get("tracking.Notifications").then(t=>{e.list=t,null==e.list&&(e.list=[])}),CONFIG.mb.toolbar.divExists("toolbar_not")?CONFIG.mb.toolbar.hideDiv("toolbar_not",!1):(CONFIG.mb.toolbar.addDiv(3,"toolbar_not","Nofifications"),$("#toolbar_not").append('<img src="images/bell.png"></img>'),$("#toolbar_not").click(()=>WIDGET("tracking.NotifyList",[180,70],!0))),e.updateNumber(),e.server.isAuth()&&e.server.pubsub.subscribe("notify:"+e.server.userid,t=>e.add(t)),e.server.pubsub.subscribe("notify:SYSTEM",t=>e.add(t)),e.server.auth.admin&&e.server.pubsub.subscribe("notify:ADMIN",t=>e.add(t)),e.setInt=setInterval(()=>{for(const t in e.list){const s=e.list[t];s.ttl<=0||new Date(s.time).getTime()/6e4+s.ttl<Date.now()/6e4&&e.remove(t)}},1e4)}stop(){const e=this;null!=e.setInt&&clearInterval(e.setInt),e.server.pubsub.unsubscribeAll("notify:"+e.server.userid),e.server.pubsub.unsubscribeAll("notify:SYSTEM"),e.server.pubsub.unsubscribeAll("notify:ADMIN"),CONFIG.mb.toolbar.divExists("toolbar_not"),CONFIG.mb.toolbar.hideDiv("toolbar_not",!0)}updateNumber(){$("#not_number").remove(),this.list.length>0&&$("#toolbar_not").append('<span id="not_number">'+this.list.length+"</span>"),m.redraw()}add(e){this.audio.play(),this.list.unshift(e),this.updateNumber(),CONFIG.store("tracking.Notifications",this.list),m.redraw()}remove(e){this.list.splice(e,1),this.updateNumber(),CONFIG.store("tracking.Notifications",this.list),m.redraw()}},pol.tracking.NotifyList=class extends pol.core.Widget{constructor(){super(),this.classname="test.NotifyList",this.notifier=CONFIG.notifier;var e=this;function t(e,t){return e.length>t?e.substring(0,t-3)+"...":e}function s(){const t={type:"info",from:"admin",time:new Date,text:e.msg(),ttl:120};CONFIG.server.pubsub.put("notify:SYSTEM",t)}function i(t){e.notifier.remove(t),m.redraw()}function n(t){e.setScroll("div#notifications","div#notifications tbody",t)}e.msg=m.stream(""),e.sendNot={view:function(){return m("div#sendNot",[m(pol.ui.textInput,{id:"notMsg",value:e.msg,maxLength:55,regex:/.*/i}),m("button",{type:"button",onclick:s},"Send")])}},e.widget={view:function(){var s=0;return m("div#notifications",[m("h1","My Notifications"),m("table",m("tbody",(CONFIG.notifier?CONFIG.notifier.list:[]).map(e=>{return m("tr",[m("td",m("img",{onclick:"chat"===e.type?()=>WIDGET("tracking.Mailbox",[50,70],!0):null,class:"icon",src:(n=e.type,"loc"===n?"images/32px/loc.png":"share"===n?"images/32px/sharing.png":"check"===n?"images/32px/check2.png":"chat"===n?"images/32px/chat2.png":"mail"===n?"images/32px/mail.png":"system"===n?"images/32px/system2.png":"error"===n?"images/32px/error.png":"alert"===n?"images/emergency.png":"images/32px/info.png")})),m("td",m("div",[m("span.header",[e.from+", "+formatDTG(e.time)]),m("img",{src:"images/16px/close.png",onclick:pol.ui.apply(i,s++)}),br,m("span.txt",{title:e.text},t(e.text,32))]))]);var n}))),CONFIG.server.auth&&CONFIG.server.auth.admin?m(e.sendNot):""])}},e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()}),e.resizeObserve(()=>n()),n()}},pol.widget.setFactory("tracking.NotifyList",{create:()=>new pol.tracking.NotifyList})})(),(()=>{var pol=window.pol;pol.tracking.BullBoard=class extends pol.core.Widget{constructor(){super();const e=this;this.classname="tracking.BullBoard",this.server=CONFIG.server,e.groups=[],e.messages=[],e.selectedGroup=0,e.edit=[[]],e.showOld=!0,e.sentText=[];let t=m.stream("");const s={view:function(t){return m("table",t.attrs.msgs.filter(t=>e.showOld||!l(t)).map(e=>m("tr"+(l(e)?".oldmsg":""),[m("td",e.sender),m("td",m("table",e.bulls.map(e=>{if(null!=e)return m("tr"+(a(e)?".oldmsg":""),[m("td"+(t=e,s=new Date(t.time),i=new Date,n=i-s,r=Math.floor(n/1e3/60),r<=15?".newmsg":a(e)?".oldmsg":""),e.text),m("td.time",p(e.time))]);var t,s,i,n,r})))])))}},i={view:function(t){var s=0;return m("div.mybulls",[m("h4","My bulletins (send):"),m("div",e.edit[e.selectedGroup].map(t=>m("span.mline",[m("span",""+(0==e.selectedGroup?String.fromCharCode("A".charCodeAt(0)+s):""+s)),m(pol.ui.textInput,{id:"edit"+s++,value:t,size:60,maxLength:67,regex:/^[^\<\>\'\"]+$/i}),s==e.edit[e.selectedGroup].length?m("span",{onclick:c},"+"):""]))),m("button",{type:"button",onclick:d},"Update"),m("button",{type:"button",onclick:u},"Clear")])}};e.widget={view:function(){var n=0;return m("div#bullboard",[m("h1","APRS Bulletin Board"),m("div.content",[m("h4","Bulletin group:"),m("div.bgroups",e.groups.map(t=>[m("span",{class:n==e.selectedGroup?"selected":"",onclick:pol.ui.apply(r,n++)},t)," "]),e.canSend()?m("span",[m(pol.ui.textInput,{id:"addGrp",value:t,size:5}),m("span",{onclick:o},pol.ui.nbsp,"[+]")]):""),m(s,{msgs:e.messages}),e.canSend()?m(i):""])])}};for(var n=0;n<26;n++)e.sentText[n]=!1;function r(t){e.selectGroup(t)}function o(){if(console.log("grpAdd",t()),""!=t()){for(let s in e.groups)if(e.groups[s]==t())return e.selectGroup(s),void m.redraw();console.log("grpAdd - push"),e.groups.push(t().toUpperCase()),e.selectGroup(e.groups.length-1),e.messages=[],t(""),e.updateScreen()}}function a(t){var s=new Date(t.time),i=new Date-s,n=Math.floor(i/1e3/60);return"_A_"==e.group()?n>2880:n>1440}function l(e){var t=!0;for(var s of e.bulls)null==s||a(s)||(t=!1);return t}function c(){e.edit[e.selectedGroup].push(m.stream(""))}function u(){for(let t in e.edit[e.selectedGroup])e.edit[e.selectedGroup][t]("");e.updateScreen(),d()}function d(){var t=e.edit[e.selectedGroup];for(const i in t)if(""!=t[i]()||0!=sentText[i]){e.sentText[i]=""!=t[i]();var s={bullid:0==e.selectedGroup?String.fromCharCode(Number(i)+"A".charCodeAt(0)):""+i,groupid:e.group(),text:t[i]()};e.server.POST("bullboard/"+e.group()+"/messages",JSON.stringify(s),e=>{console.log("Sent bulletin to: "+s.groupid+": "+s.text)},e=>{console.log("Send bulletin -> "+e.status+": "+e.statusText+" ("+e.responseText+")"),alert('Cannot send bulletin:\n"'+e.responseText+'"')})}}function p(e){var t=new Date(e),s=new Date-t,i=Math.floor(s/1e3/60/60),n=Math.floor((s-1e3*i*60*60)/1e3/60);return 0==i?n+"m":i+"h"+n+"m"}setInterval(()=>m.redraw(),6e4)}getGroups(){const e=this;e.server.GET("bullboard/groups","",t=>{e.groups=GETJSON(t),e.groups.unshift("APRS"),e.groups.unshift("Announcements"),CONFIG.get("tracking.BullBoard.selgroup").then(t=>{e.selectedGroup=e.groupIndex(t),e.selectedGroup||(e.selectedGroup=0),e.selectGroup(e.selectedGroup)})})}getMessages(){this.server.GET("bullboard/"+this.group()+"/messages","",e=>{this.messages=GETJSON(e),this.updateScreen()})}getMyMessages(){const e=this.server.auth.callsign;null!=e&&""!=e&&this.server.GET("bullboard/"+this.group()+"/messages/"+e,"",e=>{var t=GETJSON(e);for(const e in t)null!=t[e]&&(this.sentText[e]=!0,this.edit[this.selectedGroup][e]=m.stream(t[e].text))})}group(){var e=this.selectedGroup,t=this.groups[this.selectedGroup];return 0==e?t="_A_":1==e&&(t="_B_"),t}groupIndex(e){for(var t in this.groups)if(e==this.groups[t])return t;return 0}selectGroup(e){e>=this.groups.length&&(e=0),this.edit[e]&&0!=this.edit[e].length||(this.edit[e]=[],this.edit[e].push(m.stream(""))),this.selectedGroup=e,CONFIG.store("tracking.BullBoard.selgroup",this.groups[e]),this.getMessages(),this.canSend()&&this.getMyMessages()}canSend(){return this.server.isAuth()&&null!=this.server.auth.callsign&&""!=this.server.auth.callsign}updateScreen(){m.redraw(),setTimeout(()=>{var e=$("#map").height()-this.winpos[1]-80;$("#bullboard .content").parent().is("#bullboard .scroll")&&$("#bullboard .content").unwrap(),$("#bullboard .content").height()<e?e=$("#bullboard .content").height()+20:($("#bullboard .content").wrap('<div class="scroll"></div>'),$("#bullboard .scroll").height(Math.round(e)))},100)}onActivate(){this.getGroups(),this.getMessages(),this.psclient=this.server.pubsub.subscribe("bullboard",e=>{this.getGroups(),this.getMessages()})}onclose(){null!=this.psclient&&this.server.pubsub.unsubscribe("bullboard",this.psclient),this.psclient=null,super.onclose()}},pol.widget.setFactory("tracking.BullBoard",{create:()=>new pol.tracking.BullBoard})})(),(()=>{var pol=window.pol;pol.tracking.db=pol.tracking.db||{},pol.tracking.db.History=class extends pol.core.Widget{constructor(e){super();var t=this;t.classname="tracking.db.History",t.item=null,t.srch=null,t.list=[],t.searchmode=!1;var s=null,i={view:function(){var e=0;return m("div.histt",m("table",t.list.map(t=>m("tr",m("td",[m(pol.ui.removeEdit,{remove:pol.ui.apply(n,e),edit:pol.ui.apply(o,e)}),pol.ui.nbsp,m("span.removeEdit",m("img",{src:"images/time.png",title:"Set time (from form)",onclick:pol.ui.apply(l,e)}))]),m("td",{onclick:pol.ui.apply(a,e++)},t.call()),m("td",t.from.tdate+" / "+t.from.ttime()),m("td",t.to.tdate+" / "+t.to.ttime())))))}};function n(e){t.list.splice(e,1),G()}function r(e,t){return"-"==e||"-"==t?"-/-":new Date(e+" "+t).toISOString()}function o(e){let s=Object.assign({},t.list[e]);t.item=s,$("#hist_start_date").val(s.from.tdate).trigger("change"),s.open?$("#hist_end_date").val(formatDate(new Date)).trigger("change"):$("#hist_end_date").val(s.to.tdate).trigger("change"),$("#hist_end_date, #hist_end_time").prop("disabled",s.open),m.redraw(),n(e)}function a(e){CONFIG.tracks.clear(),g(t.list[e])}function l(e){let s=t.list[e];s.to.ttime(t.item.to.ttime()),s.from.ttime(t.item.from.ttime()),s.from.tdate=$("#hist_start_date").val(),t.item.open?(s.to.ttime("-"),s.to.tdate="-"):s.to.tdate=$("#hist_end_date").val(),G(),m.redraw()}function c(){y(),CONFIG.tracks.clear(),g(t.srch)}function u(){y();var e=w();WIDGET("tracking.AprsPackets",[50,70],!1,t=>t.getPackets(e.call(),500,r(e.to.tdate,e.to.ttime()),r(e.from.tdate,e.from.ttime())))}function d(){let e={};CONFIG.tracks.clear();for(const s of t.list)e[s.ident]=0;for(const s of t.list){const t=e[s.ident];setTimeout(()=>g(s,t),100),e[s.ident]++}}function p(){t.searchmode&&($("#hist_back").removeClass("searchMode"),t.searchmode=!0,CONFIG.tracks.searchMode(!1))}function h(){t.item.open?($("#hist_end_date, #hist_end_time").prop("disabled",!1),t.item.to.setNow()):$("#hist_end_date, #hist_end_time").prop("disabled",!0),t.item.open=!t.item.open,$("#hist_open").prop("checked",t.item.open)}function g(e,s){var i="?tfrom="+r(e.from.tdate,e.from.ttime())+"&tto="+r(e.to.tdate,e.to.ttime());CONFIG.server.GET("hist/"+e.call()+"/trail"+i,"",e=>{$("#hist_back").addClass("searchMode"),t.searchmode=!0,CONFIG.tracks.searchMode(!0),CONFIG.tracks.update(GETJSON(e),!0,s)})}function b(){let e=[],s='<gpx creator="Polaric Webapp2" version="1.7.3" \n  xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" \n  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.topografix.com/GPX/1/1" > \n<metadata> \n   <name>Polaric Server Tracks</name> \n   <time>'+(new Date).toISOString()+"</time> \n</metadata> \n";for(const i of t.list)e.push(f(i).then(e=>{s+=e}));Promise.allSettled(e).then(()=>{s+="\n</gpx>";const e=window.URL.createObjectURL(new Blob([s])),t=document.createElement("a");t.style.display="none",t.href=e,t.download="trails.gpx",document.body.appendChild(t),t.click(),window.URL.revokeObjectURL(e)})}function f(e){return new Promise((t,s)=>{var i="?tfrom="+r(e.from.tdate,e.from.ttime())+"&tto="+r(e.to.tdate,e.to.ttime());CONFIG.server.GET("/hist/"+e.call()+"/trail"+i,"",e=>{const s=GETJSON(e).points[0];if(null==s.trail)return void t("");let i="<trk>";i+="<name>"+s.ident+"</name>\n",i+="<trkseg>\n",i+=s.trail.linestring.reduce((e,t)=>{let s='<trkpt lat="'+v(t.pos[1])+'" lon="'+v(t.pos[0])+'">';return s+="<time>"+t.time+"</time>",s+="</trkpt>\n",e+s},""),i+="</trkseg></trk>\n",t(i)},()=>{s()})})}function v(e){return Math.round(1e5*e)/1e5}function y(){return t.item.call(t.item.call().toUpperCase()),t.item.from.tdate=$("#hist_start_date").val(),t.item.to.tdate=$("#hist_end_date").val(),t.srch=w(),t.srch.open&&(t.srch.to.ttime("-"),t.srch.to.tdate="-"),t.saveItem(),t.srch}function w(){let e=Object.assign({},t.item);return e.call=m.stream(t.item.call()),e.from=Object.assign({},t.item.from),e.to=Object.assign({},t.item.to),e.from.ttime=m.stream(t.item.from.ttime()),e.to.ttime=m.stream(t.item.to.ttime()),e}function k(){const e=y();t.list.push(e),G()}function I(){const e=CONFIG.server.auth.userid;console.assert(e&&null!=e,"userid="+e),null!=e&&CONFIG.server.GET("trackers","",e=>{let s=GETJSON(e);for(var i of s){let e={call:m.stream(i.id),from:t.item.from,to:t.item.to};t.list.push(e)}G(),m.redraw()})}function O(){t.item.call(""),t.item.from.setNow(),t.item.to.setNow(),t.list=[],t.saveItem(),G()}function G(){const e=[];for(s of t.list)e.push(t._saveItem(s));CONFIG.store("tracking.db.hist",JSON.stringify(e))}t.widget={view:function(){return m("div",[m("h1","Historical data search"),m(i),m("form.hist",[m("div.field",m("span.sleftlab","Callsign: "),m(pol.ui.textInput,{id:"hist_call",value:t.item.call,size:10,maxLength:20,regex:/^.+$/i})),m("div.field",m("span.sleftlab","Start: "),m(pol.ui.dateTime,{id:"hist_start",tval:t.item.from}),m(pol.ui.timeButt,{tval:t.item.from})),m("div.field",m("span.sleftlab","End: "),m(pol.ui.dateTime,{id:"hist_end",tval:t.item.to}),m(pol.ui.timeButt,{tval:t.item.to}),m(pol.ui.checkBox,{id:"hist_open",onclick:h,checked:t.item.open,title:"If checked, end-time is now"},"Open end")),m("div.histbutt",[m("button#hist_b1",{type:"button",title:"Show trail - search",onclick:c},"Trail"),m("button#hist_pkts",{type:"button",title:"Raw APRS packets - search",onclick:u},"Pkts"),m("button#hist_b2",{type:"button",title:"Clear all",onclick:O},"Clear"),m("button#hist_b3",{type:"button",title:"Add search to list",onclick:k},"Add"),m("button#hist_b4",{type:"button",title:"Get from My Trackers",onclick:I},"Get MT"),m("button#hist_b5",{type:"button",title:"Show all trails in list",onclick:d},"Show all"),m("button#hist_b6",{type:"button",title:"Export trails to GPX file",onclick:b},"Export"),m("button#hist_back",{type:"button",title:"Return to realtime tracking",onclick:p},"Back")])]),m("iframe#downloadframe",{style:"display:none"})])}},async function(){let e=JSON.parse(await CONFIG.get("tracking.db.hist"));for(s of(0==Array.isArray(e)&&(e=[]),null!=e&&e!=[]||(t.list=[]),e))t.list.push(t._restoreItem(s))}(),t.setItem(e),setTimeout(()=>$("#hist_end_date, #hist_end_time").prop("disabled",t.item.open),300)}_saveItem(e){return{call:e.call(),todate:e.to.tdate,totime:e.to.ttime(),fromdate:e.from.tdate,fromtime:e.from.ttime(),open:e.open}}_handler(e){e.item.from.tdate=$("#hist_start_date").val(),e.item.to.tdate=$("#hist_end_date").val()}_restoreItem(e){const t=new pol.core.Time(()=>{this._handler(this)}),s=new pol.core.Time(()=>{this._handler(this)});return null==e?{call:m.stream(""),to:t,from:s,open:!1}:(t.tdate=e.todate,t.ttime(e.totime),s.tdate=e.fromdate,s.ttime(e.fromtime),{call:m.stream(e.call),to:t,from:s,open:e.open})}saveItem(){CONFIG.storeSes("tracking.db.hist.item",JSON.stringify(this._saveItem(this.item)))}async restoreItem(){const e=JSON.parse(await CONFIG.get("tracking.db.hist.item"));this.item=this._restoreItem(e)}onclose(){CONFIG.tracks.searchMode(!1)}setCall(e){this.item.call(e),m.redraw()}newItem(e){return{call:m.stream(e||""),from:new pol.core.Time(()=>{this._handler(this)}),to:new pol.core.Time(()=>{this._handler(this)})}}setItem(e){const t=this;return null!=e?(t.item=t.newItem(e),t.saveItem(),m.redraw()):t.restoreItem(),null==t.item&&(t.item=t.newItem()),null==t.item.from&&(t.item.from=new pol.core.Time),null==t.item.to&&(t.item.to=new pol.core.Time),t.item.to.timeIsSet()||t.item.to.setNow(),t.item.from.timeIsSet()||t.item.from.setNow(),t}},pol.widget.setFactory("tracking.db.History",{create:()=>new pol.tracking.db.History})})(),(()=>{var pol=window.pol;pol.tracking.db=pol.tracking.db||{},pol.tracking.db.Timemachine=class extends pol.core.Widget{constructor(e){super();var t=this;function s(){i(!0)}function i(e){!function(e){t.time.tdate=$("#dtinput_date").val();var s=!1,i=CONFIG.mb.getScale(),n=CONFIG.tracks.filter,r="?tto="+function(e,t){const s=new Date(e+" "+t);return s.toISOString()}(t.time.tdate,t.time.ttime())+"&scale="+o(i)+"&filter="+n;1==e&&(r+="&reset");var a=CONFIG.mb.getExtent();setTimeout(()=>{s||(t.message="Searching, please wait..."),m.redraw()},200),CONFIG.tracks.clear(),CONFIG.server.GET("hist/snapshot/"+o(a[0])+"/"+o(a[1])+"/"+o(a[2])+"/"+o(a[3])+r,"",e=>{$("#tm_back").addClass("searchMode"),t.searchmode=!0,CONFIG.tracks.searchMode(!0),CONFIG.tracks.update(GETJSON(e),!0),t.message=null,s=!0,m.redraw()})}(e)}t.classname="tracking.db.Timemachine",t.time=new pol.core.Time(function(){t.time.tdate=$("#dtinput_date").val(),null!=n&&window.clearTimeout(n),n=setTimeout(()=>{n=null,i(!1)},700)}),t.searchmode=!1,t.message=null,t.widget={view:function(){return m("div",[m("h1","Time machine"),m("form.tm",[m("span.tm",m(pol.ui.dateTime,{id:"dtinput",tval:t.time})),m("div.statusmsg",t.message),m("div.tmbutt",[m("button#tm_b1",{type:"button",title:"Show trail - search",onclick:s},"Go to.."),m(pol.ui.timeButt,{tval:t.time,hour:!0}),m("button#tm_back",{type:"button",title:"Return to realtime tracking",onclick:r},"Back")])]),m("iframe#downloadframe",{style:"display:none"})])}},CONFIG.mb.map.on("change:view",e=>{s()});let n=null;function r(){t.searchmode&&($("#tm_back").removeClass("searchMode"),t.searchmode=!1,CONFIG.tracks.searchMode(!1),t.message=null,m.redraw())}function o(e){return Math.round(1e5*e)/1e5}}onclose(){CONFIG.tracks.searchMode(!1)}},pol.widget.setFactory("tracking.db.Timemachine",{create:()=>new pol.tracking.db.Timemachine})})(),(()=>{var pol=window.pol;function e(e){return e.getFullYear()+"-"+(e.getMonth()<9?"0":"")+(e.getMonth()+1)+"-"+(e.getDate()<10?"0":"")+e.getDate()}pol.tracking.db=pol.tracking.db||{},pol.tracking.db.HeardVia=class extends pol.core.Widget{constructor(t){super();var s=this;s.classname="tracking.db.HeardVia",s.item={call:m.stream(t),fromdate:null,todate:null},s.list=[],s.colors=["c008","00c8","a0a8","0a08","0008"],s.color=0,s.searchmode=!1;var i={view:function(){var e=0;return m("div.hrdvia",m("table",s.list.map(t=>m("tr",m("td",m(pol.ui.removeEdit,{remove:pol.ui.apply(r,e),edit:pol.ui.apply(o,e)})),m("td",{onclick:pol.ui.apply(l,e++)},t.call),m("td",t.fromdate),m("td",t.todate),m("td",{style:"background: #"+t.color})))))}};function n(e,t){return new Date(e+" "+t).toISOString()}function r(e){s.list.splice(e,1),v()}function o(t){let i=Object.assign({},s.list[t]);i.call=m.stream(i.call),s.item=i,$("#hrd_start").val(i.fromdate).trigger("change"),i.open?$("#hrd_end").val(e(new Date)).trigger("change"):$("#hrd_end").val(i.todate).trigger("change"),$("#hrd_open").prop("checked",i.open).trigger("change"),$("#hrd_end").prop("disabled",i.open),m.redraw(),r(t)}function a(){h(),CONFIG.tracks.clear(),p(b(s.item))}function l(e){CONFIG.tracks.clear(),p(s.list[e])}function c(){CONFIG.tracks.clear();for(const e of s.list)setTimeout(()=>p(e,e.color),100)}function u(){s.searchmode&&(s.searchmode=!1,$("#hrd_back").removeClass("searchMode"),CONFIG.tracks.searchMode(!1))}function d(){s.item.open?$("#hrd_end").prop("disabled",!1):$("#hrd_end").prop("disabled",!0),s.item.open=!s.item.open,$("#hrd_open").prop("checked",s.item.open)}function p(e,t){var i=CONFIG.mb.getExtent(),r="?tfrom="+n(e.fromdate,"00:00")+"&tto="+("-"==e.todate?"-/-":n(e.todate,"23:59"));CONFIG.server.GET("/hist/"+e.call+"/hrdvia/"+g(i[0])+"/"+g(i[1])+"/"+g(i[2])+"/"+g(i[3])+r,"",i=>{$("#hrd_back").addClass("searchMode"),s.searchmode=!0,CONFIG.tracks.searchMode(!0);const n=GETJSON(i);n.ident=e.call,n.color=t||s.colors[0],CONFIG.tracks.update(n,!0)})}function h(){s.item.call(s.item.call().toUpperCase()),s.item.fromdate=$("#hrd_start").val(),s.item.open=$("#hrd_open").prop("checked"),s.item.open?s.item.todate="-":s.item.todate=$("#hrd_end").val(),CONFIG.storeSes("tracking.db.hrd.item",JSON.stringify(s.item))}function g(e){return Math.round(1e5*e)/1e5}function b(){let e=Object.assign({},s.item);return e.call=s.item.call(),e}function f(){h();let e=b();e.color=s.colors[s.color],s.color=(s.color+1)%5,s.list.push(e),v()}function v(){CONFIG.store("tracking.db.hrd",JSON.stringify(s.list)),CONFIG.store("tracking.db.hrd.color",JSON.stringify(s.color))}s.color=0,s.widget={view:function(){return m("div",[m("h1","Heard points via"),m(i),m("form.hrd",[m("div.field",m("span.sleftlab","Callsign: "),m(pol.ui.textInput,{id:"hrd_call",value:s.item.call,size:10,maxLength:20,regex:/^.+$/i})),m("div.field",m("span.sleftlab","Start: "),m(pol.ui.Datepick,{id:"hrd_start",value:s.item.fromdate})),m("div.field",m("span.sleftlab","End: "),m(pol.ui.Datepick,{id:"hrd_end",value:s.item.todate}),m(pol.ui.checkBox,{id:"hrd_open",onclick:d,checked:s.item.open,title:"If checked, end-date is today"},"Open end")),m("div.hrdbutt",[m("button#hrd_b1",{type:"button",onclick:a},"Search"),m("button#hrd_b2",{type:"button",title:"Add search to list",onclick:f},"Add"),m("button#hrd_b3",{type:"button",title:"Show coverage for all stns in list",onclick:c},"Show all"),m("button#hrd_back",{type:"button",title:"Return to realtime tracking",onclick:u},"Back")])])])}},CONFIG.get("tracking.db.hrd").then(e=>{s.list=JSON.parse(e),null==s.list&&(s.list=[])}),CONFIG.get("tracking.db.hrd.color").then(e=>{s.color=JSON.parse(e),s.color&&null!=s.color||(s.color=0)}),s.setItem(t),setTimeout(()=>$("#hrd_end").prop("disabled",s.item.open),300),s.color=0}onclose(){this.searchmode&&CONFIG.tracks.searchMode(!1)}setCall(e){this.item.call(e),m.redraw()}async setItem(t){const s=this;return t?(s.item={call:m.stream(t),fromdate:null,todate:null},CONFIG.storeSes("tracking.db.hrd.item",JSON.stringify(s.item)),m.redraw()):(s.item=JSON.parse(await CONFIG.get("tracking.db.hrd.item")),null!=s.item&&(s.item.call=m.stream(t))),null==s.item&&(s.item={call:m.stream(""),fromdate:null,todate:null}),null==s.item.fromdate&&(s.item.fromdate=e(new Date)),null!=s.item.todate&&"-"!=s.item.todate||(s.item.todate=e(new Date)),s}},pol.widget.setFactory("tracking.db.HeardVia",{create:()=>new pol.tracking.db.HeardVia})})(),pol.tracking.LabelStyle=class{constructor(){this.currentIndex=0,this.start=5,this.styles=["50%","60%","70%","80%","90%","100%","110%","120%","130%","140%","150%"],this.scales=[.8,.9,1,1,1,1,1.1,1.2,1.3,1.4,1.4],CONFIG.get("tracking.labelStyle").then(e=>{const t=parseInt(e);t&&(this.currentIndex=t)})}setFontForClass(e,t){const s=document.getElementsByClassName(t);for(const t of s)t.style.fontSize=this.styles[e]}setFont(){CONFIG.storeSes("tracking.labelStyle",""+this.currentIndex);var e=this.currentIndex+this.start;this.setFontForClass(e,"lstill"),this.setFontForClass(e,"lobject"),this.setFontForClass(e,"lmoving")}next(){this.currentIndex<this.styles.length-this.start-1&&(this.currentIndex++,this.setFont(),CONFIG.tracks.updateIconStyle())}previous(){this.currentIndex>0-this.start&&(this.currentIndex--,this.setFont(),CONFIG.tracks.updateIconStyle())}getFontSize(){return this.styles[this.currentIndex+this.start]}getIconScale(){return this.scales[this.currentIndex+this.start]}},(()=>{var pol=window.pol;pol.tracking.db=pol.tracking.db||{},pol.tracking.TrackerAlias=class extends pol.core.Widget{constructor(){super();var e=this;function t(){e.edit.auto=!e.edit.auto,e.iconGrey()}e.server=CONFIG.server,e.edit={id:m.stream(""),alias:m.stream(""),icon:"",auto:!0},e.icons=[],e.iconpath="",CONFIG.get("iconpath").then(t=>{e.iconpath=t}),e.dfl="",CONFIG.get("default_icon").then(t=>{e.dfl=t}),this.aliasWidget={view:function(){return m("form.trackerAlias",[m("div.field",m("span.xsleftlab","Ident:"),m(pol.ui.textInput,{id:"trackerId",value:e.edit.id,size:16,maxLength:25,onchange:e.onIdEdit(),regex:/^[^\<\>\'\"]+$/i})),m("div.field",m("span.xsleftlab","Alias:"),m(pol.ui.textInput,{id:"alias",value:e.edit.alias,size:16,maxLength:32,regex:/.*/i})),m("div.field",m("span.xsleftlab","Icon:"),m(pol.ui.iconPick,{value:e.edit.icon,icons:e.icons,default:e.dfl,id:"iconpick"}),m("span#auto",m(pol.ui.checkBox,{id:"symbol-auto",onclick:t,checked:e.edit.auto,title:"If checked, icon is automatically selected (from aprs symbol)"},"Automatic")))])}},e.server.GET("system/icons/default","",t=>{e.icons=GETJSON(t);for(const t in e.icons)e.icons[t]=e.iconpath+e.icons[t];m.redraw()}),setTimeout(()=>e.iconGrey(),1e3),setTimeout(()=>e.iconGrey(),3e3)}clear(){this.edit.auto=!0,this.edit.id(""),this.edit.alias(""),$("#iconpick>img").attr("src",this.icons[this.dfl]).trigger("change"),setTimeout(()=>this.iconGrey(),1e3)}iconGrey(){this.edit.auto?($("#iconpick>img").css("background","grey"),$("#iconpick>img").css("opacity","0.5")):($("#iconpick>img").css("background",""),$("#iconpick>img").css("opacity",""))}onActivate(){setTimeout(()=>this.iconGrey(),600)}onIdEdit(){}setIdent(e){this.edit.id(e),this.iconGrey(),m.redraw()}setIcon(e,t){null==t?(e.auto=!0,e.icon=this.icons[this.dfl]):e.icon=this.iconpath+"/icons/"+t}}})(),(()=>{var pol=window.pol;pol.tracking.GlobalSettings=class extends pol.tracking.TrackerAlias{constructor(){super();var e=this;function t(){let t=$("#iconpick").get(0).value;t||console.warn("Icon picker didn't work");let s=t.substr(t.lastIndexOf("/")+1),i=$("#trackerId").val();if(i.match(/^.+\@.+$/g)||(i=i.toUpperCase()),""==i)return;const n={alias:$("#alias").val(),icon:e.edit.auto?null:s};""==n.alias&&(n.alias=null),e.server.PUT("item/"+i+"/alias",JSON.stringify(n),e=>{console.log("Updated global settings: "+i),$("#confirm").text("Updated"),setTimeout(()=>$("#confirm").text(""),5e3)},e=>{console.log("Update glob. settings -> "+e.status+": "+e.statusText+" ("+e.responseText+")"),alert('Cannot update global settings.\n"'+e.responseText+'"')})}e.classname="tracking.GlobalSettings",this.widget={view:function(){return m("div#globalSettings",[m("h1","Global Settings"),m(e.aliasWidget),m("div.butt",[m("button",{type:"button",onclick:t},"Update"),m("button",{type:"button",onclick:()=>{e.clear()}},"Clear"),m("span#confirm")])])}},e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()})}setIdent(e){super.setIdent(e),this.server.GET("item/"+e+"/alias","",e=>{const t=GETJSON(e);null!=t.alias&&this.edit.alias(t.alias),this.setIcon(this.edit,t.icon),m.redraw()})}},pol.widget.setFactory("tracking.GlobalSettings",{create:()=>new pol.tracking.GlobalSettings})})(),(()=>{var pol=window.pol;pol.tracking.db=pol.tracking.db||{},pol.tracking.db.MyTrackers=class extends pol.tracking.TrackerAlias{constructor(){super();var e=this;function t(){let t=$("#iconpick").get(0).value;!function(t,s,i,o,a){if(null==t||""==t)return;let l=n(t,s,i,o,a);e.server.POST("trackers",JSON.stringify(l),e=>{console.log("Added tracker: "+l.id),r(l,o,a,e)},e=>{console.log("Add tracker -> "+e.status+": "+e.statusText+" ("+e.responseText+")"),alert("Cannot add tracker: "+l.id+'\n"'+e.responseText+'"')})}(e.edit.id().toUpperCase(),e.user(),e.edit.alias(),e.edit.auto,t)}function s(){let t=$("#iconpick").get(0).value;i(e.edit.id().toUpperCase(),e.user(),e.edit.alias(),e.edit.auto,t)}function i(t,s,i,o,a){if(null==t||""==t)return;let l=n(t,s,i,o,a);""!=s&&s!=e.server.auth.userid&&0==confirm("Transfer '"+t+"' to user '"+s+"' - are you sure?")||e.server.PUT("trackers/"+t,JSON.stringify(l),e=>{console.log("Updated tracker: "+t),r(l,o,a,e)},e=>{console.log("Update tracker -> "+e.status+": "+e.statusText+" ("+e.responseText+")"),alert("Cannot update tracker: "+t+'\n"'+e.responseText+'"')})}function n(t,s,i,n,r){const o=r.substr(r.lastIndexOf("/")+1);return{id:t,user:null!=s?s:e.server.auth.userid,alias:""==i?null:i,icon:n?null:o}}function r(t,s,i,n){!function(t){for(const s in e.myTrackers)t==e.myTrackers[s].id&&e.myTrackers.splice(s,1)}(t.id),t.auto=s,t.icon=s?e.icons[e.dfl]:i,"OK-ACTIVE"==n&&(t.active=!0),e.myTrackers.push(t),e.myTrackers.sort((e,t)=>e.id<t.id?-1:1),m.redraw()}function o(t){const s=e.myTrackers[t];e.server.DELETE("trackers/"+s.id,i=>{console.log("Removed tracker: "+s.id),e.myTrackers.splice(t,1),m.redraw()})}function a(t){const s=e.myTrackers[t];e.edit.id(s.id),e.edit.alias(s.alias),e.edit.icon=s.icon,e.edit.user=s.user,e.editMode=!0,e.iconGrey(),$("#iconpick>img").attr("src",s.auto?e.icons[e.dfl]:s.icon).trigger("change"),m.redraw()}function l(e){CONFIG.tracks&&CONFIG.tracks.goto_Point(e)}e.classname="tracking.db.MyTrackers",e.myTrackers=[],e.editMode=!1,e.psclient=null,e.userList=[],e.user=m.stream(""),this.widget={view:function(){var n=0;return m("div#trackerEdit",[m("h1","My trackers"),m("table.mytrackers",m("tbody",e.myTrackers.map(e=>m("tr",[m("td",m(pol.ui.removeEdit,{remove:pol.ui.apply(o,n),edit:pol.ui.apply(a,n++)})),m("td",{onclick:pol.ui.apply(l,e.id)},e.id),m("td",e.alias),m("td",null==e.icon||e.auto?"":m("img.icon",{src:e.icon})),m("td",e.active?m("img",{src:"images/16px/ok.png"}):"")])))),m("div.field#owner",m("span.xsleftlab",{title:"Optional: Move tracker to another user"},"Owner:"),m(pol.ui.textInput,{list:"userList",value:e.user}),m("datalist#userList",e.userList.map(e=>m("option",e)))),m(e.aliasWidget),m("div.butt",[m("button",{type:"button",disabled:!(null!=e.edit.id()&&""!=e.edit.id()&&!e.editMode),onclick:t},"Add"),m("button",{type:"button",disabled:!(null!=e.edit.id()&&""!=e.edit.id()&&e.editMode),onclick:s},"Update"),m("button",{type:"button",onclick:()=>{e.clear()}},"Clear"),m("button",{type:"button",onclick:()=>{!function(){for(const t of e.myTrackers)i(t.id,e.user(),"",!0,"")}()}},"Reset All"),m("button",{type:"button",onclick:()=>{WIDGET("tracking.Tags",[150,150],!1,e=>e.setIdent("mytrackers"))}},"Tags")])])}},e.server.hasDb&&(e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()}),function t(){const s=e.server.auth.userid;console.assert(s&&null!=s,"userid="+s),null!=s&&e.server.GET("trackers","",i=>{for(var n of(null==e.psclient&&(e.psclient=e.server.pubsub.subscribe("trackers:"+s,e=>{t()})),e.myTrackers=GETJSON(i),e.myTrackers))e.setIcon(n,n.icon);m.redraw()})}(),setInterval(()=>{e.isActive()&&e.getTrackers()},12e4),e.server.GET("usernames",null,t=>{e.userList=GETJSON(t),e.userList.sort((e,t)=>e>t),m.redraw()},()=>{console.warn("Couldn't get user list")}))}onIdEdit(){for(const e of this.myTrackers)if(this.edit.id()==e.id)return void(this.editMode=!0);this.editMode=!1}onclose(){const e=this.server.auth.userid;null!=e&&null!=this.psclient&&this.server.pubsub.unsubscribe("telemetry:"+e,this.psclient),this.psclient=null,super.onclose()}clear(){super.clear(),this.user("")}},pol.widget.setFactory("tracking.db.MyTrackers",{create:()=>new pol.tracking.db.MyTrackers})})(),(()=>{var pol=window.pol;pol.tracking.OwnObjects=class extends pol.core.Widget{constructor(){super();const e=this,t=CONFIG.server;let s="";function i(){const t=$("#symSelect").val();e.obj.symtab(t[0]),e.obj.sym(t[1]),m.redraw()}function n(){e.obj.perm=!e.obj.perm}function r(){0!=e.obj.pos[0]||0!=e.obj.pos[1]?t.POST("aprs/objects",JSON.stringify(e.obj),()=>{e.getObjects()},e=>{o(e.responseText),console.warn("Server: "+s)}):o("Invalid position")}function o(e){s=e,setTimeout(()=>{s="",m.redraw()},6e3),m.redraw()}function a(e){CONFIG.tracks.goto_Point(e+"@"+t.auth.servercall)}e.obj={ident:m.stream(""),pos:[0,0],sym:m.stream("c"),symtab:m.stream("/"),comment:m.stream(""),perm:!1},e.olist=[],e.classname="tracking.OwnObjects",this.widget={view:function(){return m("div#aprsObject",[m("h1","Add APRS object"),m("div.itemList",e.olist.map(t=>[m("span",[m("img",{src:"images/edit-delete.png",onclick:pol.ui.apply(t=>e.remove(t),t)}),m("span",{onclick:pol.ui.apply(a,t)},t),nbsp])," "])),m("div.errmsg",s),m("div.field",m("span.sleftlab","Object ID: "),m(pol.ui.textInput,{id:"objid",value:e.obj.ident,size:10,maxLength:9,regex:/^[a-zA-Z0-9\_\-\.\#]{1,9}$/i})),m("div.field",m("span.sleftlab","Symbol: "),m(pol.ui.textInput,{id:"symtab",size:1,maxLength:1,value:e.obj.symtab,regex:/[\/\\a-zA-Z]/i}),m(pol.ui.textInput,{id:"symbol",size:1,maxLength:1,value:e.obj.sym,regex:/[a-zA-Z]/i}),m(pol.ui.select,{id:"symSelect",onchange:i,list:[{label:"Post",val:"/c"},{label:"Sign",val:"\\m"},{label:"Cross",val:"\\."},{label:"Triangle",val:"\\n"},{label:"Red Cross",val:"/+"},{label:"OPS/EOS",val:"/o"},{label:"Radio Station",val:"/r"}]})),m("div.field",m("span.sleftlab","Description: "),m(pol.ui.textInput,{id:"descr",value:e.obj.comment,size:32,maxLength:64,regex:/^.+$/i})),m("div.field",m("span.sleftlab","Pos (UTM): "),m(pol.ui.utmInput,{value:e.obj.pos})),m("div.field",m("span.sleftlab","Settings:"),m(pol.ui.checkBox,{id:"perm",onclick:n,checked:e.obj.perm},"Timeless (permanent)")),m("div.butt",[m("button",{type:"button",onclick:r},"Update"),m("button",{type:"button",onclick:()=>{e.clear()}},"Clear"),m("span#confirm")])])}},e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()})}onActivate(){this.getObjects()}clear(){this.obj.ident(""),this.obj.comment(""),this.obj.pos=[0,0],this.obj.sym("c"),this.obj.symtab("/"),this.obj.perm=!1,m.redraw()}setPosPix(e){const t=CONFIG.mb.pix2LonLat(e);this.obj.pos=t,m.redraw()}getObjects(){CONFIG.server.GET("aprs/objects",null,e=>{this.olist=GETJSON(e),m.redraw()},()=>{console.warn("Couldn't get object-list")})}remove(e){e&&null!=e&&srv.DELETE("aprs/objects/"+e,()=>{this.getObjects()},()=>{console.warn("Couldn't delete object: "+e)})}},pol.widget.setFactory("tracking.OwnObjects",{create:()=>new pol.tracking.OwnObjects})})(),(()=>{var pol=window.pol;pol.tracking.db=pol.tracking.db||{},pol.tracking.db.Signs=class extends pol.core.Widget{constructor(){super();let e="";const t=this;function s(){t.clearFields()}function i(t){e=t,setTimeout(()=>{e="",m.redraw()},6e3),console.log(e),m.redraw()}function n(){const e=$("#typeSelect").val();t.type=e;for(const e of t.myTypes)e.val==t.type&&(t.icon=e.icon);t.typeSel&&t.getSigns()}function r(){t.typeSel=!t.typeSel,t.getSigns()}function o(){t.userSel=!t.userSel,t.getSigns()}function a(){return{id:-1,url:t.url(),descr:t.descr(),scale:parseInt(t.scale(),10),pos:t.pos,icon:null,type:parseInt(t.type,10),tname:""}}function l(){""!=t.ident&&(0!=t.pos[0]||0!=t.pos[1]?t.server.PUT("signs/"+t.ident,JSON.stringify(a()),()=>{setTimeout(()=>t.getSigns(),500)},e=>{i("Cannot update on server: "+e.responseText)}):i("Invalid position"))}function c(){0!=t.pos[0]||0!=t.pos[1]?t.server.POST("signs",JSON.stringify(a()),()=>{},e=>{i("Cannot add to server: "+e.responseText)}):i("Invalid position")}function u(e){const s=t.mySigns[e];t._edit(s),t.setEditMode(!0)}function d(e){t._remove(e,!0)}function p(e){null!=e.pos&&CONFIG.mb.goto_Pos(e.pos,!1)}t.server=CONFIG.server,t.classname="tracking.db.Signs",t.mySigns=[],t.myTypes=[],t.descr=m.stream(""),t.url=m.stream(""),t.scale=m.stream(""),t.pos=[0,0],t.ident="",t.type=0,t.icon="",t.typeSel=!1,t.userSel=!0,t.inProgr=!1,this.signsList={view:function(){var e=0;return m("table",m("tbody",t.mySigns.map(t=>m("tr",[m(pol.ui.removeEdit,{remove:pol.ui.apply(d,e),edit:pol.ui.apply(u,e++)}),m("td",{onclick:pol.ui.apply(p,t)},t.descr),m("td",t.tname),m("td",t.scale)]))))}},this.widget={view:function(){return m("div#signsEdit",[m("h1","Signs (simple points)"),m("div.errmsg",e),m("div.field",m("span.sleftlab",{title:"Description of item"},"Description:"),m(pol.ui.textInput,{id:"name",value:t.descr,size:36,maxLength:40,regex:/.*/i})),m("div.field",m("span.sleftlab",{title:"URL for webpage or picture to link to"},"URL:"),m(pol.ui.textInput,{id:"url",value:t.url,size:36,maxLength:40,regex:/.*/i})),m("div.field",m("span.sleftlab","Pos (UTM): "),m(pol.ui.utmInput,{value:t.pos})),m("div.field",m("span.sleftlab",{title:"Max scale in which item is shown on map"},"Scale:"),m(pol.ui.textInput,{id:"scale",value:t.scale,size:12,maxLength:16,regex:/^[1-9][0-9]{4,16}$/i})),m("div.field",m("span.sleftlab",{title:"Type or category of item"},"Type:"),m(pol.ui.select,{id:"typeSelect",onchange:n,list:t.myTypes}),pol.ui.nbsp,m("img",{src:"aprsd/icons/"+t.icon})),m("div.field",m("span.sleftlab",{title:"What objects to show in list"},"Search:"),m(pol.ui.checkBox,{id:"srch_type",checked:t.typeSel,onclick:r,title:"Limit list to selected type"},"Type selection"),m(pol.ui.checkBox,{id:"srch_user",checked:t.userSel,onclick:o,title:"Limit list to my own objects"},"My objects only")),m("div.butt",[m("button",{id:"ubutt",type:"button",onclick:l},"Update"),m("button",{id:"abutt",type:"button",onclick:c},"Add"),m("button",{type:"button",onclick:s},"Clear")]),m("div#signsList")])}},t.server.hasDb&&t.server.isAuth()?(t.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||t.closePopup()}),this.setEditMode(!1)):t.allowPopup(!1)}remove(e,t){if(t||1==t||0!=confirm("Remove - are you sure?")){var s=this.getIdent(e);if(this.isActive())for(const e in this.mySigns)this.mySigns[e].id==s&&this._remove(e,!0);else this._remove(s,!1)}}_remove(e,t){if(null==e)return;const s=t?this.mySigns[e].id:""+e;this.server.DELETE("signs/"+s,i=>{console.log("Removed sign: "+s),t&&(this.mySigns.splice(e,1),m.redraw())})}getIdent(e){let t;return/__db/.test(e)?(t=e.substring(5),t):null}_edit(e){this.ident=e.id,this.descr(e.descr),this.url(e.url),this.scale(e.scale),this.pos=e.pos,this.type=e.type,this.icon=e.icon,$("#typeSelect").val(e.type),this.setEditMode(!0),m.redraw()}edit(e){var t=this.getIdent(e);null!=t&&this.server.GET("signs/"+t,"",e=>{var t=GETJSON(e);this._edit(t)})}setEditMode(e){setTimeout(()=>{$("#ubutt").prop("disabled",!e),$("#abutt").prop("disabled",e)},200)}getTypes(){this.server.GET("signs/types","",e=>{this.myTypes=[];var t=GETJSON(e);for(e of t)this.myTypes.push({label:e.name,val:e.id,icon:e.icon});this.myTypes.length>0?(this.type=this.myTypes[0].val,this.icon=this.myTypes[0].icon):console.warn("No sign types found in database"),m.redraw()})}getSigns(){if(this.inProgr)return;this.inProgr=!0;const e=this.server.auth.userid;if(console.assert(e&&null!=e,"userid="+e),null!=e){var t=this.typeSel?"?type="+$("#typeSelect").val():"";this.userSel&&(t+=(this.typeSel?"&":"?")+"user=true"),this.server.GET("signs"+t,"",e=>{this.mySigns=GETJSON(e),this.sortList(),setTimeout(()=>this.mountList(),1e3),this.inProgr=!1})}}setPosPix(e){const t=CONFIG.mb.pix2LonLat(e);this.clearFields(),this.scale(""+CONFIG.mb.getScaleRounded()),this.pos=t,m.redraw()}clearFields(){this.pos=[0,0],this.ident="",this.descr(""),this.url(""),this.scale(""),null!=this.mTypes&&0==this.mTypes.length&&(this.type=this.myTypes[0].val,this.icon=this.myTypes[0].icon),$("#typeSelect").val(this.type),this.setEditMode(!1)}mountList(){this.isActive()&&(m.mount($("div#signsList").get(0),this.signsList),this.setScrollTable("#signsEdit","div#signsList"))}sortList(){this.mySigns=this.mySigns.sort((e,t)=>e.tname==t.tname?e.descr<t.descr?-1:1:e.tname<t.tname?-1:1)}onActivate(){this.getTypes(),this.getSigns()}},pol.widget.setFactory("tracking.db.Signs",{create:()=>new pol.tracking.db.Signs})})(),(()=>{var pol=window.pol;pol.tracking.OwnPos=class extends pol.core.Widget{constructor(){super();const e=this,t=CONFIG.server;let s="";function i(){if(0==e.posx[0]&&0==e.posx[1])return void n("Invalid position");const i={symtab:e.symtab(),sym:e.sym,pos:e.posx};t.PUT("system/ownpos",JSON.stringify(i),()=>{console.log("Own position updated ok"),$("#confirm").text("Updated"),setTimeout(()=>$("#confirm").text(""),5e3)},e=>{n(e.responseText),console.warn("Server: "+s)})}function n(e){s=e,setTimeout(()=>{s="",m.redraw()},1e4),m.redraw()}e.classname="tracking.OwnPos",e.symtab=m.stream("/"),e.sym=m.stream("c"),e.posx=[0,0],this.widget={view:function(){return m("div#ownPos",[m("h1","Position of this server"),m("div.errmsg",s),m("span.sleftlab","Symbol: "),m(pol.ui.textInput,{id:"symtab",size:1,maxLength:1,value:e.symtab,regex:/[\/\\a-zA-Z]/i}),m(pol.ui.textInput,{id:"symbol",size:1,maxLength:1,value:e.sym,regex:/./i}),pol.ui.br,m("span.sleftlab","Pos (UTM): "),m(pol.ui.utmInput,{value:e.posx}),pol.ui.br,m("div.butt",[m("button",{type:"button",onclick:i},"Update"),m("button",{type:"button",onclick:()=>{e.clear()}},"Clear"),m("span#confirm")])])}},e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()})}clear(){this.posx=[0,0],this.sym("c"),this.symtab("/"),m.redraw()}setPosPix(e){const t=CONFIG.mb.pix2LonLat(e);this.posx=t,m.redraw()}},pol.widget.setFactory("tracking.OwnPos",{create:()=>new pol.tracking.OwnPos})})(),(()=>{var pol=window.pol;pol.tracking.TrailInfo=class extends pol.core.Widget{constructor(){super();const e=this;function t(e){return e>1e3?Math.round(e/100)/10+" km":e+" m"}function s(e){return e<0?"-":e<22.5?"N":e<67.5?"NE":e<112.5?"E":e<157.5?"SE":e<202.5?"S":e<247.5?"SW":e<292.5?"W":e<337.5?"NW":"N"}function i(e){const t=new Date(e);return(t.getHours()<10?"0":"")+t.getHours()+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()}CONFIG.server,e.classname="tracking.TrailInfo",e.tlist=[],e.callsign="",this.showList={view:function(){return m("table",m("thead",m("tr",[m("th","Time"),m("th","Km/h"),m("th","Dir"),m("th","Dist"),m("th","Path")])),m("tbody",e.tlist.map(e=>m("tr",[m("td",i(e.time)),m("td",e.speed),m("td",s(e.course)),m("td",t(e.dist)),m("td",e.path)]))))}},this.widget={view:function(){return m("div#trail",[m("h1","Last movements"),m("span",e.callsign),br,m("div#trailresult")])}}}getTrail(e){console.assert(e&&null!=e,"Assertion failed"),this.callsign=e,m.redraw(),e&&null!=e&&CONFIG.server.GET("item/"+e+"/trail",null,e=>{this.tlist=GETJSON(e),m.mount($("div#trailresult").get(0),this.showList),this.setScrollTable("div#trail","div#trailresult")},()=>{console.warn("Couldn't get object-list")})}},pol.widget.setFactory("tracking.TrailInfo",{create:()=>new pol.tracking.TrailInfo,onRestore:NaN})})(),(()=>{var pol=window.pol;pol.tracking.Tags=class extends pol.core.Widget{constructor(){super();const e=this;function t(){let t=[e.tag];e.server.POST(e.url,JSON.stringify(t),()=>{e.getTags()},e=>{console.warn("Couldn't add tag: "+e)})}CONFIG.server,e.server=CONFIG.server,e.ident=m.stream(""),e.tag=m.stream(""),e.tagsOn=[],e.usedTags=[],e.negTags=new Set,e.classname="tracking.Tags",e.url="",this.widget={view:function(){return m("div#itemtags",[m("h1","Tags for "+e.ident()),m("div.tagList",e.tagsOn.map(t=>e.negTags.has(t)?m("span.disabled",t):[m("span.box",[m("img",{src:"images/edit-delete.png",onclick:pol.ui.apply(t=>e.remove(t),t)}),"-"==t.charAt(0)?m("span.negtag",t):"+"==t.charAt(0)?m("span.usertag",t.substring(1)):m("span.systag",t)])])),m(pol.ui.textInput,{list:"usedTags",value:e.tag}),m("datalist#usedTags",e.usedTags.map(e=>m("option",e))),m("button",{type:"button",onclick:t},"Add")])}},e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()})}remove(e){e=encodeURIComponent(e),this.server.DELETE(this.url+"/"+e,()=>{this.getTags(),m.redraw()},e=>{console.warn("Couldn't delete object: "+e)})}onActivate(){setTimeout(()=>{this.getTags()},1e3)}setIdent(e){this.ident(e),this.url="mytrackers"==e?"trackers/tags":"item/"+e+"/tags",m.redraw()}getTags(){this.server.GET("system/tags",null,e=>{this.usedTags=GETJSON(e),this.usedTags.sort((e,t)=>e>t),m.redraw()},()=>{console.warn("Couldn't get tag list")}),this.server.GET(this.url,null,e=>{this.negTags.clear(),this.tagsOn=GETJSON(e),this.tagsOn.sort((e,t)=>e>t);for(const e of this.tagsOn)e.charAt("-")&&this.negTags.add(e.substring(1));m.redraw()},()=>{console.warn("Couldn't get tag-list for item")})}},pol.widget.setFactory("tracking.Tags",{create:()=>new pol.tracking.Tags})})(),(()=>{var pol=window.pol;pol.tracking.BikeWheel=class extends pol.core.Widget{constructor(){super();const e=this,t=CONFIG.server;let s="";e.ident=m.stream("IPP"),e.descr=m.stream(""),e.pos=[0,0],e.p25=m.stream(""),e.p50=m.stream(""),e.p75=m.stream(""),e.p95=m.stream(""),e.olist=[],e.classname="tracking.BikeWheel",CONFIG.get("iconpath").then(t=>{e.iconpath=t,null==e.iconpath&&(e.iconpath="")}),this.widget={view:function(){var t=0;return m("div#bikeWheel",[m("h1","Add LKP/IPP with distance rings"),m("div.itemList",e.olist.map(e=>[m("span",[m("img",{src:"images/edit-delete.png",onclick:pol.ui.apply(p,t)}),m("img",{src:"images/edit.png",onclick:pol.ui.apply(d,t++)}),pol.ui.nbsp,m("span",{onclick:pol.ui.apply(c,e)},e.ident),nbsp])," "])),m("div.errmsg",s),m("div.field",m("span.sleftlab","Ident: "),m(pol.ui.textInput,{id:"label",value:e.ident,size:10,maxLength:15,regex:/^[a-zA-Z0-9\_\-\.\#\/]+$/i})),m("div.field",m("span.sleftlab","Description: "),m(pol.ui.textInput,{id:"descr",value:e.descr,size:32,maxLength:64,regex:/^.+$/i})),m("div.field",m("span.sleftlab","Pos (UTM): "),m(pol.ui.utmInput,{value:e.pos})),m("div.field",m("span.sleftlab","Rings: "),m("div#rings",[m(pol.ui.textInput,{id:"p25",value:e.p25,size:5,maxlength:6,regex:/^[0-9]+(\.[0-9]+)?$/i}),m("span.km"," km")," - 25%",pol.ui.br,m(pol.ui.textInput,{id:"p50",value:e.p50,size:5,maxlength:6,regex:/^[0-9]+(\.[0-9]+)?$/i}),m("span.km"," km")," - 50%",pol.ui.br,m(pol.ui.textInput,{id:"p75",value:e.p75,size:5,maxlength:6,regex:/^[0-9]+(\.[0-9]+)?$/i}),m("span.km"," km")," - 75%",pol.ui.br,m(pol.ui.textInput,{id:"p95",value:e.p95,size:5,maxlength:6,regex:/^[0-9]+(\.[0-9]+)?$/i}),m("span.km"," km")," - 95%"]),m("div#alternatives",[m("span","To find suitable distances for a subject, see ISRID Database / Lost Person Behavior by Koester")])),m("div.butt",[m("button",{type:"button",onclick:a},"Add"),m("button",{type:"button",onclick:l},"Update"),m("button",{type:"button",onclick:()=>{e.clear()}},"Clear"),m("span#confirm")])])}},e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()}),e.src=new ol.source.Vector;const i=new ol.layer.Vector({name:"BIKEWHEEL",source:e.src});function n(t,s,i){let n=new ol.geom.Circle(t),r=new ol.Feature,o=CONFIG.mb.view.getProjection();return n.transform("EPSG:4326",CONFIG.mb.view.getProjection()),n.setRadius(s/o.getMetersPerUnit()),r.setGeometry(n),r.hide=!0,r.setStyle(()=>{let e=s/CONFIG.mb.getResolution(),t=i.clone();return e<10&&t.setStroke(null),e<35?t.setText(null):t.getText().setOffsetY(e),t}),e.src.addFeature(r),r}function r(t){t.features=[],t.p25>0&&t.features.push(n(t.pos,1e3*t.p25,getStyle("bike25"))),t.p50>0&&t.features.push(n(t.pos,1e3*t.p50,getStyle("bike50"))),t.p75>0&&t.features.push(n(t.pos,1e3*t.p75,getStyle("bike75"))),t.p95>0&&t.features.push(n(t.pos,1e3*t.p95,getStyle("bike95"))),t.features.push(function(t,s,i){const n=ll2proj(t);let r=new ol.Feature(new ol.geom.Point(n));r.setId(s),r.getGeometry().setCoordinates(n);const o=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],src:e.iconpath+"/icons/sym06.png"})});return r.setStyle(o),r.description=i,e.src.addFeature(r),r}(t.pos,t.ident,t.descr))}function o(){return{pos:e.pos,ident:e.ident(),descr:e.descr(),p25:""==e.p25()?0:parseFloat(e.p25()),p50:""==e.p50()?0:parseFloat(e.p50()),p75:""==e.p75()?0:parseFloat(e.p75()),p95:""==e.p95()?0:parseFloat(e.p95())}}function a(){if(0==e.pos[0]&&0==e.pos[1])return void u("Invalid position");for(const t of e.olist)if(t.ident==e.ident())return void u("Cannot add '"+t.ident+"'. Already added");const s=o();null!=t&&t.isAuth()&&t.POST("sar/ipp",JSON.stringify(s),()=>{console.log("Posted IPP/LKP: "+s.ident)},e=>{u("Cannot post IPP/LKP: "+e)}),e.olist.push(s),r(s),setTimeout(()=>CONFIG.mb.setCenter(s.pos,100),200)}function l(){if(0==e.pos[0]&&0==e.pos[1])return void u("Invalid position");let s=0;for(s in e.olist)if(e.olist[s].ident==e.ident()){for(const t of e.olist[s].features)e.src.removeFeature(t);break}const i=o();null!=t&&t.isAuth()&&t.PUT("sar/ipp/"+i.ident,JSON.stringify(i),()=>{console.log("Updated IPP/LKP: "+i.ident)},e=>{u("Cannot update IPP/LKP: "+e)}),e.olist[s]=i,r(i)}function c(e){CONFIG.mb.setCenter(e.pos,60)}function u(e){console.log(e),s=e,setTimeout(()=>{s="",m.redraw()},6e3),m.redraw()}function d(t){const s=e.olist[t];e.ident(s.ident),e.descr(s.descr),e.pos=s.pos,e.p25(s.p25),e.p50(s.p50),e.p75(s.p75),e.p95(s.p95)}function p(t){e.remove(t)}CONFIG.mb.addLayer(i),CONFIG.mb.featureInfo.register(i,e=>[{val:e.getId()},{val:e.description}]),null!=t&&t.isAuth()&&t.GET("/sar/ipp",null,t=>{const s=GETJSON(t);for(const t of s)null!=t&&(e.olist.push(t),r(t))},e=>{console.log("Cannot get features: "+e)})}clear(){this.ident("IPP"),this.descr(""),this.p25(""),this.p50(""),this.p75(""),this.p95(""),this.pos=[0,0],m.redraw()}setPosPix(e){const t=CONFIG.mb.pix2LonLat(e);this.pos=t,m.redraw()}remove(e){const t=this.olist[e],s=CONFIG.server;null!=s&&s.isAuth()&&s.DELETE("sar/ipp/"+t.ident,()=>{console.log("Deleted IPP/LKP: "+t.ident)},e=>{console.error("Cannot delete IPP/LKP: "+e)});for(const t of this.olist[e].features)this.src.removeFeature(t);this.olist.splice(e,1),m.redraw()}},pol.widget.setFactory("tracking.BikeWheel",{create:()=>new pol.tracking.BikeWheel})})(),(()=>{var pol=window.pol;pol.tracking.Mailbox=class extends pol.core.Widget{constructor(){super(),this.classname="tracking.Maibox",this.notifier=CONFIG.notifier;var e=this;function t(){null!=e.server.auth.userid&&e.server.GET("loginusers","",t=>{e.users=GETJSON(t),m.redraw(),setTimeout(()=>e.addScroll(!0),200)})}function s(){const t={to:e.recipient(),text:e.msg()};e.server.POST("mailbox",JSON.stringify(t),s=>{console.log("Sent message to: "+t.to),e.msg(""),m.redraw(),e.addScroll(!0)},e=>{console.log("Send message -> "+e.status+": "+e.statusText+" ("+e.responseText+")"),alert('Cannot send message:\n"'+e.responseText+'"')})}e.server=CONFIG.server,e.recipient=m.stream(""),e.msg=m.stream(""),e.msglist=[],e.users=[],e.uvisible=!1,e.showUsers={view:function(){return m("div#recipients",e.users.map(t=>m("span",{onclick:()=>{e.recipient(t)}},t," ")))}},e.sendMsg={view:function(){return m("div#sendMsg",[m("div.field",m("span.xxsleftlab","To:"),m(pol.ui.textInput,{id:"recipient",value:e.recipient,maxLength:40,regex:/.*/i}),m("img#ulist",{src:"images/participant.png",title:"Show logged on users (on/off)",onclick:()=>{e.uvisible?(e.uvisible=!1,$("div#recipients").css("display","none"),setTimeout(()=>e.addScroll(!0),200)):(t(),e.uvisible=!0,$("div#recipients").css("display","block"))}})),m("div.field",m("span.xxsleftlab","Text:"),m(pol.ui.textInput,{id:"msg",value:e.msg,maxLength:66,regex:/.*/i}),m("img#sendmsg",{src:"images/sendmsg.png",title:"Send message",onclick:s}))])}},e.widget={view:function(){return m("div#mailbox",[m("h1","My Short Messages"),m("div#msglist",m("table",m("tbody",e.msglist.map(t=>m("tr",[m("td",m("img",{class:t.outgoing?"ticon":"icon",src:t.outgoing?"images/32px/chatt.png":"images/32px/chatf.png"})),m("td"+(t.outgoing?".out":""),m("div",[m("span",{class:"header"},[pol.ui.formatDTG(t.time)+": ",t.outgoing?t.from:m("span.fromaddr",{onclick:()=>{e.recipient(t.from)}},t.from),nbsp,m("img",{src:"images/16px/dE.png"}),pol.ui.nbsp,t.outgoing?m("span.fromaddr",{onclick:()=>{e.recipient(t.to)}},t.to):t.to]),m("img",{class:"status",src:"images/16px/close.png",onclick:()=>e.remove(t.msgId)}),0!=t.status&&t.outgoing?m("img",{class:"status",title:t.stinfo,src:1==t.status?"images/16px/ok.png":2==t.status?"images/16px/maybe.png":"images/16px/warn.png"}):"",br,m("span.txt",t.text)]))]))))),m(e.showUsers),CONFIG.server.isAuth()?m(e.sendMsg):""])}},e.getMsgs(),e.resizeObserve(()=>e.addScroll(!0)),setInterval(()=>t(),12e4),e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()})}remove(e){this.server.DELETE("mailbox/"+e,t=>{console.log("Remove message: "+e)},e=>{console.log("Remove message -> "+e.status+": "+e.statusText+" ("+e.responseText+")")})}getMsgs(){const e=this.server.auth.userid;console.assert(e&&null!=e,"userid is undefined"),null!=e&&this.server.GET("mailbox","",e=>{this.msglist=GETJSON(e),m.redraw(),this.addScroll(!0)})}reply(e){e.outgoing?this.recipient(e.to):this.recipient(e.from),m.redraw()}addScroll(e){this.setScroll("div#mailbox","div#msglist tbody",e)}setStatus(e){for(const t in this.msglist)if(this.msglist[t].msgId==e.msgId){this.msglist[t].status=e.status,this.msglist[t].stinfo=e.info;break}}onActivate(){console.assert(this.server.authOk,"Connection to server not established"),this.pscli1=this.server.pubsub.subscribe("messages:"+this.server.auth.userid,e=>{this.msglist.push(e),m.redraw(),setTimeout(()=>this.addScroll(!0),500)}),this.pscli2=this.server.pubsub.subscribe("msgstatus:"+this.server.auth.userid,e=>{this.setStatus(e),m.redraw()}),this.pscli3=this.server.pubsub.subscribe("msgdelete:"+this.server.auth.userid,e=>{this.msglist=[],m.redraw(),this.getMsgs()}),this.getMsgs()}onclose(){null!=this.pscli1&&this.server.pubsub.unsubscribe("messages:"+this.server.auth.userid,this.pscli1),null!=this.pscli2&&this.server.pubsub.unsubscribe("msgstatus:"+this.server.auth.userid,this.pscli2),null!=this.pscli3&&this.server.pubsub.unsubscribe("msgdelete:"+this.server.auth.userid,this.pscli3),this.pscli1=this.pscli2=this.pscli3=null,super.onclose()}},pol.widget.setFactory("tracking.Mailbox",{create:()=>new pol.tracking.Mailbox})})(),(()=>{var pol=window.pol,e=null;pol.getShareWidget=function(){return null==e&&(e=new pol.tracking.db.Sharing),e.isActive()||e.activatePopup("tracking.db.Sharing",[50,70],!0),e},pol.tracking.db.Sharing=class extends pol.core.Widget{constructor(){super();const e=this,t=CONFIG.server;function s(){e.readonly=!e.readonly}function i(){if(!function(t){for(const s of e.userList)if(s==t)return!0;return!1}(e.user()))return void alert("Unknown user: "+e.user());let t={userid:e.user(),readOnly:e.readonly};if(e.server.POST((e.photo?"photos/":"objects/"+e.tag+"/")+e.ident+"/share",JSON.stringify(t),()=>{e.getShares()},e=>{console.warn("Couldn't add user: "+e)}),!e.photo&&"layer"==e.tag&&("drawing"==e.type||"gpx"==e.type)){const s=encodeURIComponent(("gpx"==e.type?"gpx.":"feature.")+e.name);e.server.POST("objects/"+s+"/_ALL_/share",JSON.stringify(t),()=>{},e=>{console.warn("Couldn't add user: "+e)})}}e.server=CONFIG.server,e.ident=0,e.name="",e.tag="TAG",e.user=m.stream(""),e.shareList=[],e.userList=[],e.groupList=[],e.readonly=!0,e.photo=!1,e.classname="tracking.db.Sharing",this.widget={view:function(){return m("div#sharing",[m("h1","User access/sharing"),null!=e.name&&""!=e.name?m("span#objname",e.tag+": "+(e.photo?e.ident:e.name)):"",m("div.tagList",e.shareList.map(t=>[m("span.box",[m("img",{src:"images/edit-delete.png",onclick:pol.ui.apply(t=>e.remove(t),t.userid)}),t.readOnly?m("span.ulistro",t.userid):m("span.ulistitem",t.userid)])])),m(pol.ui.textInput,{list:"userList",value:e.user}),m("datalist#userList",e.userList.map(e=>m("option",e))),m("span#ro",m(pol.ui.checkBox,{id:"full",onclick:s,checked:e.readonly},"Read-only ")),pol.ui.nbsp,m("button",{type:"button",onclick:i},"Add")])}},e.authCb=CONFIG.server.addAuthCb(()=>{CONFIG.server.isAuth()||e.closePopup()}),t.GET("usernames",null,t=>{e.userList=GETJSON(t),e.userList.sort((e,t)=>e>t),e.userList.push("#ALL"),e.server.GET("groups","",t=>{e.groupList=GETJSON(t),e.groupList.sort((e,t)=>e>t);for(const t of e.groupList)e.userList.push("@"+t.ident)},()=>{console.warn("Couldn't get group list")}),m.redraw()},()=>{console.warn("Couldn't get user list")})}remove(e){if(e=encodeURIComponent(e),CONFIG.server.DELETE((this.photo?"photos/":"objects/"+this.tag+"/")+this.ident+"/share/"+e,()=>{this.getShares()},e=>{console.warn("Couldn't delete object: ",e.statusText)}),!this.photo&&"layer"==this.tag&&("drawing"==this.type||"gpx"==this.type)){const t=encodeURIComponent(("gpx"==this.type?"gpx.":"feature.")+this.name);CONFIG.server.DELETE("objects/"+t+"/_ALL_/share/"+e,e=>{e>0&&console.log(e+" features removed")},e=>{console.warn("Couldn't remove user: "+e)})}}setIdent(e,t,s,i){this.ident=e,this.name=t,this.tag=s,this.type=i,"Photo"===s&&(this.photo=!0),console.log("setIdent",this.ident,this.tag,this.type),this.getShares()}getShares(){console.log("this.tag/ident: ",this.tag,this.ident),CONFIG.server.GET(encodeURI((this.photo?"photos/":"objects/"+this.tag+"/")+this.ident+"/share"),null,e=>{this.shareList=GETJSON(e),this.shareList.sort((e,t)=>e.userid>t.userid),m.redraw()},()=>{console.warn("Couldn't get share-list for object")})}onActivate(){}},pol.widget.setFactory("tracking.db.Sharing",{create:()=>new pol.tracking.db.Sharing})})(),(()=>{var pol=window.pol;pol.tracking.AprsPackets=class extends pol.core.Widget{constructor(){super();const e=this;function t(t){const s=new Date(t);return s.getDate()+" "+e.days[s.getMonth()]+" "+(s.getHours()<10?"0":"")+s.getHours()+":"+(s.getMinutes()<10?"0":"")+s.getMinutes()+":"+(s.getSeconds()<10?"0":"")+s.getSeconds()}function s(e){const t=e.split(/qA/),s=t[0].split("*"),i=m("span.ipath",null!=t[1]?"qA"+t[1]:"");return 2==s.length?m("span",[m("span.usedpath",s[0]+"*"),s[1],i]):m("span",[t[0]+" ",i])}CONFIG.server,e.classname="tracking.AprsPackets",e.tlist=[],e.callsign="",e.n=200,this.showList={view:function(){return m("table",m("thead",m("tr",[m("th","Channel"),m("th","Time"),m("th","Dest"),m("th","Path"),m("th","Report")])),m("tbody",e.tlist.map(e=>m("tr",[m("td",e.source),m("td",{title:e.time},t(e.time)),m("td",e.to),m("td",s(e.via)),m("td",e.report)]))))}},this.widget={view:function(){var s="";return e.tfrom&&(s+=" From: "+t(e.tfrom)),e.at&&(s+=" To: "+t(e.at)),e.tfrom||e.at||(s=" Last "+e.n+" packets"),m("div#rawpackets",[m("h1","APRS packets"),m("span",e.callsign+" -"+s),br,m("div#packetresult")])}},e.days=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"]}getPackets(e,t,s,i){console.assert(e&&null!=e,"Assertion failed"),this.callsign=e,this.n=t||500,this.at=s,this.tfrom=i;var n="";this.at&&(n+="&tto="+this.at),this.tfrom&&(n+="&tfrom="+this.tfrom),m.redraw(),e&&null!=e&&CONFIG.server.GET("hist/"+e+"/aprs?n="+this.n+n,null,e=>{this.tlist=GETJSON(e),m.mount($("div#packetresult").get(0),this.showList),this.setScrollTable("div#rawpackets","div#packetresult")},()=>{console.warn("Couldn't get packet-list")})}},pol.widget.setFactory("tracking.AprsPackets",{create:()=>new pol.tracking.AprsPackets,onRestore:null})})(),(()=>{var pol=window.pol;pol.tracking.PointInfo=class extends pol.core.Widget{constructor(){super();var e=this;e.srv=CONFIG.server,e.classname="tracking.PointInfo",e.domclass="infopopup",e.info=null;var t={view:e=>{if(e.attrs.speed<=0||e.attrs.course<0)return null;let t="";e.attrs.speed>0&&(t+=e.attrs.speed+" km/h");const s=e.attrs.course;let i=null;return s>22&&s<=67&&(i=m("span",m("img",{src:"images/16px/dNE.png"})," NE")),s>67&&s<=112&&(i=m("span",m("img",{src:"images/16px/dE.png"})," E")),s>112&&s<=157&&(i=m("span",m("img",{src:"images/16px/dSE.png"})," SE")),s>157&&s<=202&&(i=m("span",m("img",{src:"images/16px/dS.png"})," S")),s>202&&s<=247&&(i=m("span",m("img",{src:"images/16px/dSW.png"})," SW")),s>247&&s<=292&&(i=m("span",m("img",{src:"images/16px/dW.png"})," W")),i=s>292&&s<=337?m("span",m("img",{src:"images/16px/dNW.png"})," W"):m("span",m("img",{src:"images/16px/dN.png"})," N"),m("span",t,nbsp,i)}},s={view:e=>{const t=e.attrs.traf;return m("div.trblock",t.map(e=>m("span.link_id",{onclick:t=>findItem(e)},e+" ")))}},i={view:()=>{const t=e.info;return[m("div.field",m("span.leftlab","Ident: "),m("b",t.ident)),null!=t.alias?m("div.field",m("span.leftlab","Alias: "),m("b",t.alias)):null]}},n={view:()=>{const t=e.info;return[m("div.field",m("nobr",m("span.leftlab","Position (UTM): "),m.trust(pol.mapref.formatUTM(t.pos)))),m("div.field",m("nobr",m("span.leftlab","Position (latlong): "),m.trust(pol.mapref.formatDM(t.pos)))),t.altitude>0?m("div.field",m("span.leftlab","Altitude: "),t.altitude+" m"):null]}},r={view:()=>{const t=e.info;return[null!=t.descr&&""!=t.descr?m("div.field",m("nobr",m("span.leftlab","Description: "),t.descr)):null,m(n),m("div.field",m("span.leftlab","Last reported: "),pol.ui.formatDTG(t.updated))]}},o={view:()=>[m(i),m(r)]},a={view:()=>{const s=e.info;return[m(i),m("div.field",m("span.leftlab","Channel: "),s.source),m("div.field",m("span.leftlab","APRS Symbol: "),s.symtab+" "+s.symbol),m(r),s.speed>0?m("div.field",m("span.leftlab","Movement: "),m(t,{course:s.course,speed:s.speed})):null]}},l={view:()=>{const s=e.info;return[m(i),m("div.field",m("span.leftlab","Callsign: "),s.callsign),m("div.field",m("span.leftlab","Name: "),s.name),m("div.field",m("span.leftlab","Type: "),s.vtype),m("div.field",m("span.leftlab","Navstatus: "),s.navstatus),m(n),s.speed>0?m("div.field",m("span.leftlab","Movement: "),[Math.round(.539956*s.speed)+" knots ",pol.ui.nbsp,m(t,{course:s.course,speed:s.speed})]):null]}},c={view:()=>{const t=e.info;return[m("div.field",m("span.leftlab","Type-Road: "),t.sitType," : ",t.roadNr),m("div.field",m("span.leftlab","Severity: "),t.severity),m("div.field",m("span.leftlab","Valid time span: "),m("span.nobr",pol.ui.formatDTG(t.startTime)),pol.ui.nbsp,"-",pol.ui.nbsp,pol.ui.formatDTG(t.endTime)),m("div.datexcom",t.comments[0]),m("div.datexcom",t.comments[1])]}},u={view:()=>{const t=e.info;return[m(a),null!=t.path?m("div.field",m("span.leftlab","Via: "),(i=t.path,null==i?"":i.replaceAll(/qA.\,?/gi,"").replaceAll(/(WIDE|SAR)[0-9](\-[0-9])?\,?/gi,"").replaceAll("*","").replaceAll(/\,+/gi,",").replaceAll(",",", "))):null,m("div.traffic",[null!=t.trafficTo&&t.trafficTo.length>0?m("div.field",m("span.leftlab","Traffic to: "),m(s,{traf:t.trafficTo})):null,null!=t.trafficTo&&t.trafficFrom.length>0?m("div.field",m("span.leftlab","Traffic from: "),m(s,{traf:t.trafficFrom})):null])];var i}};this.widget={view:function(){return null==e.info?"waiting..":"Station"==e.info.type?m(u):"AprsObject"==e.info.type?m(a):"AisVessel"==e.info.type?m(l):"DatexSitRecord"==e.info.type?m(c):m(o)}}}getItem(e){m.redraw();const t=CONFIG.server.isAuth()?"xinfo":"info";this.srv.GET("item/"+e+"/"+t,null,e=>{this.info=GETJSON(e),m.redraw()},()=>{console.warn("Item not found")})}onActivate(){this.info=null}},pol.widget.setFactory("tracking.PointInfo",{create:()=>new pol.tracking.PointInfo})})(),(()=>{var pol=window.pol;pol.tracking.Telemetry=class extends pol.core.Widget{constructor(){super();var e=this;e.srv=CONFIG.server,e.classname="tracking.Telemetry",e.descr=null,e.meta=null,e.current=null,e.ident="",e.psclient=null;const t={view:function(){var t=0;return m("table.telemetry",e.meta.num.map(s=>{var i=function(t,s){if(-1==t.num[s])return-1;var i=e.meta.num[s].eqns[0]*t.num[s]*t.num[s]+e.meta.num[s].eqns[1]*t.num[s]+e.meta.num[s].eqns[2];return Math.round(1e3*i)/1e3}(e.current,t++);return m("tr",m("td.lbl",(null==s.parm?"Chan-"+t:s.parm)+": "),m("td.val",i),m("td.unit",s.unit))}))}},s={view:function(){var t=0;return m("div.telbin",e.meta.num.map(s=>{var i=function(t,s){return t.bin[s]==e.meta.bin[s].bit}(e.current,t++),n=e.meta.bin[t];return n.use?m("span"+(i?".on":""),{title:i?n.unit:null},null==n.parm?"B"+t:n.parm):null}))}};function i(e){const t=new Date(e);return(t.getHours()<10?"0":"")+t.getHours()+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()}this.widget={view:function(){return m("div#Telemetry",[m("h1",null==e.descr?"Telemetry":e.descr),pol.ui.nbsp,nbsp,m("span",e.ident+(null!=e.current?", at "+i(e.current.time):"")),m("button",{type:"button",onclick:()=>{WIDGET("tracking.TelHist",[50,70],!1,t=>t.getHist(e.ident,e.meta),e.ident)}},"Graph"),null!=e.meta&&null!=e.current&&e.current.num?m(t):null,null!=e.meta&&null!=e.current&&e.current.bin?m(s):null])}}}getItem(e){e!=this.ident&&(""!=this.ident&&null!=this.psclient&&this.srv.pubsub.unsubscribe("telemetry:"+this.ident,this.psclient),this.psclient=this.srv.pubsub.subscribe("telemetry:"+e,t=>{this.getItem(e)})),this.ident=e,this.srv.GET("telemetry/"+e+"/descr",null,e=>{this.descr=GETJSON(e),m.redraw()},e=>{console.warn(e)}),this.srv.GET("telemetry/"+e+"/meta",null,e=>{this.meta=GETJSON(e),m.redraw()},e=>{console.warn(e)}),this.srv.GET("telemetry/"+e+"/current",null,e=>{this.current=GETJSON(e),m.redraw()},e=>{console.warn(e)})}onclose(){""!=this.ident&&null!=this.psclient&&this.srv.pubsub.unsubscribe("telemetry:"+this.ident,this.psclient),this.ident="",super.onclose()}},pol.widget.setFactory("tracking.Telemetry",{create:()=>new pol.tracking.Telemetry})})(),(()=>{var pol=window.pol;pol.tracking.TelHist=class extends pol.core.Widget{constructor(){super();var e=this;function t(){"day"==e.period?e.period="":e.period="day",e.getHist(e.ident,e.meta,!0)}function s(){"week"==e.period?e.period="":e.period="week",e.getHist(e.ident,e.meta,!0)}e.srv=CONFIG.server,e.classname="tracking.TelHist",e.meta=null,e.ident="",e.index=0,e.prevIndex=0,e.chart=null,e.option={color:["#c23531","#2f4554","#61a0a8","#d48265","#91c7ae","#749f83","#ca8622","#bda29a","#6e7074"],tooltip:{trigger:"axis"},legend:{data:[]},xAxis:{type:"time"},yAxis:{},series:[{showSymbol:!1,data:[],type:"line"}]},this.widget={view:function(){return m("div#TelHist",[m("h1","Telemetry graph - "+e.ident),m("div.graph",{id:"graph_"+e.ident}),m("button",{type:"button",onclick:()=>e.getHist(e.ident,e.meta)},"Next"),pol.ui.nbsp,m(pol.ui.checkBox,{onclick:t,checked:"day"==e.period},"Day"),pol.ui.nbsp,m(pol.ui.checkBox,{onclick:s,checked:"week"==e.period},"Week")])}}}getAnalog(e,t){if(-1==e.num[t])return-1;var s=this.meta.num[t].eqns[0]*e.num[t]*e.num[t]+this.meta.num[t].eqns[1]*e.num[t]+this.meta.num[t].eqns[2];return Math.round(1e3*s)/1e3}getHist(e,t,s){e!=this.ident&&(""!=this.ident&&null!=this.psclient&&this.srv.pubsub.unsubscribe("telemetry:"+this.ident,this.psclient),this.psclient=this.srv.pubsub.subscribe("telemetry:"+e,s=>{this.getHist(e,t,!0)})),this.meta=t,this.ident=e;let i="";"day"==this.period?i="?hours=24":"week"==this.period&&(i="?hours=168"),m.redraw(),this.srv.GET("telemetry/"+e+"/history"+i,null,e=>{1==s&&(this.index=this.prevIndex),this.prevIndex=this.index,(null==this.chart||this.index<0)&&(this.index=0),this.resetChart();var i=GETJSON(e),n=Object.assign({},this.option);n.series=[],n.legend.data=[];for(let s=this.index;s<5;s++){var r={type:"line",name:t.num[s].parm,showSymbol:!1,data:[]};for(e of(null!=r.name&&""!=r.name||(r.name="Chan-"+s),n.legend.data.push(r.name),i))r.data.push([e.time,this.getAnalog(e,s)]);if(n.series.push(r),s>=4||t.num[s].unit!=t.num[s+1].unit){this.index=s;break}}this.chart.setOption(n),this.index++,this.index>=5&&(this.index=-1)},e=>{console.warn(e)})}resetChart(){null!=this.chart&&this.chart.dispose();let e=document.getElementById("graph_"+this.ident);this.chart=echarts.init(e,"vintage")}onclose(){this.index=0,null!=this.chart&&this.chart.dispose(),this.chart=null,""!=this.ident&&null!=this.psclient&&this.srv.pubsub.unsubscribe("telemetry:"+this.ident,this.psclient),this.ident="",super.onclose()}},pol.widget.setFactory("tracking.TelHist",{create:()=>new pol.tracking.TelHist})})(),(()=>{var pol=window.pol;pol.tracking.Login=class extends pol.core.Widget{constructor(){super();var e=this;e.classname="tracking.Login",e.username=m.stream(""),e.passwd=m.stream(""),e.errmsg="",e.info={},e.groupList=[],e.group="DEFAULT",e.selGroup="",e.psclient=null;const t={view:function(){return m("div#login",[m("h1","Server Login"),m("img",{src:"images/PolaricServer.png"}),""!=e.errmsg?m("div#errmsg",e.errmsg):null,m("div.field",m("span.sleftlab","Username:"),m(pol.ui.textInput,{id:"username",value:e.username,size:16,maxLength:25,regex:/.*/i})),m("div.field",m("span.sleftlab","Password:"),m(pol.ui.textInput,{id:"passwd",value:e.passwd,size:16,maxLength:25,regex:/.*/i,passwd:!0})),m("div.butt",[m("button",{type:"button",onclick:n},"Login")])])}},s={view:function(){return m("select#group",{onchange:r},e.groupList.map(e=>m("option",{value:e.ident},e.ident)))}},i={view:function(){return m("div#authinfo",[m("h1","Logged in"),m("div.field",m("span.sleftlab","Server:"),m("span",e.info.servercall)),m("div.field",m("span.sleftlab","User id:"),m("span",null!=e.info.userid?e.info.userid:"(not logged in)")),""!=e.lvl?m("div.field",m("span.sleftlab","Auth level:"),m("span",e.lvl)):null,null!=e.info.callsign&&""!=e.info.callsign?m("div.field",m("span.sleftlab","Callsign:"),m("span",e.info.callsign)):null,null!=e.info.userid?m("div.field",m("span.sleftlab","Role:"),m(s),m("span#selGroup",""+e.selGroup),pol.ui.nbsp):null,null!=e.info.userid?m("div.butt",[m("button",{disabled:!(null!=e.groupList&&e.groupList.length>1),type:"button",onclick:o},"Change"),m("button",{type:"button",onclick:()=>{CONFIG.server.clearAuth(),m.redraw()}},"Logout")]):null])}};function n(){const t="username="+e.username()+"&password="+e.passwd();CONFIG.server.POSTFORM("directLogin",t,t=>{CONFIG.server.setCredentials(e.username(),t).then(()=>{CONFIG.server.loginStatus(),e.getAuth(),e.getGroups()})},(t,s,i)=>{var n;console.log("Login failed -> "+s+" ("+i+")"),n="Login failed (check username/password)",e.errmsg=n,setTimeout(()=>{e.errmsg="",m.redraw()},1e4),m.redraw()})}function r(){e.info.groupid=$("select#group").val();for(const t of e.groupList)t.ident==e.info.groupid&&(e.selGroup=t.name);m.redraw()}function o(){const t=e.info.groupid;console.log("Role changed to: ",t),CONFIG.server.temp_role=t,CONFIG.server.loginStatus()}e.widget={view:function(){return CONFIG.server.isAuth()?m(i):m(t)}}}getLevel(){const e=this;e.lvl="",e.info.sar&&(e.lvl="SAR"),e.info.admin&&(""!=e.lvl&&(e.lvl+=", "),e.lvl+="ADMIN")}getGroups(){const e=this;e.groupList=[],CONFIG.server.GET("groups","",t=>{let s=GETJSON(t);for(t of s)t.avail&&e.groupList.push(t);m.redraw(),null==e.psclient&&(e.psclient=CONFIG.server.pubsub.subscribe("auth:"+e.info.userid,e=>{CONFIG.filt.getFilters()}))})}getAuth(){const e=this;CONFIG.server.GET("authStatus","",t=>{e.info=GETJSON(t),e.group=e.info.groupid,null!=CONFIG.server.temp_role&&(e.group=CONFIG.server.temp_role),e.getLevel(),setTimeout(()=>$("select#group").val(e.group).trigger("change"),300),m.redraw()})}reload(){this.isActive()&&this.onActivate()}onActivate(){setTimeout(()=>{this.getAuth(),this.getGroups(),this.group=CONFIG.server.temp_role,setTimeout(()=>$("select#group").val(this.group).trigger("change"),300),m.redraw()},1500)}onclose(){null!=this.psclient&&CONFIG.server.pubsub.unsubscribe("auth:"+this.info.userid,this.psclient),this.psclient=null,super.onclose()}},pol.widget.setFactory("tracking.Login",{create:()=>new pol.tracking.Login,onRestore:null})})(),(()=>{var pol=window.pol;pol.tracking.db=pol.tracking.db||{},pol.tracking.db.PhotoDescr=class extends pol.core.Widget{constructor(){super();var e=this;function t(){const t=e.ident.replace(/^(__db\.)/,"");e.server.PUT("photos/"+t+"/descr",JSON.stringify(e.edit()),()=>{e.successMsg("Title updated",1e4)},t=>{e.errMsg("Cannot update: "+t.responseText,1e4)})}function s(){e.edit("")}e.classname="tracking.db.PhotoDescr",e.server=CONFIG.server,e.edit=m.stream(""),e.ident=null,this.widget={view:function(){const i=null==e.ident?null:e.ident.replace(/^(__db\.)/,"");return m("div",[m("h1","Photo title"),null!=e.errmsg?m("div#errmsg",e.errmsg):null,null!=e.successmsg?m("div#successmsg",e.successmsg):null,m("span#objname","Photo: "+i),m("form.photoDescr",[m(pol.ui.textInput,{id:"photoDescr",value:e.edit,size:22,maxLength:25,regex:/^.*$/i}),m("div.butt",m("button",{type:"button",onclick:t},"Update"),m("button",{type:"button",onclick:s},"Clear"))])])}}}setIdent(e,t){console.log("SET IDENT: ",e,t),this.ident=e,this.edit(t),m.redraw()}},pol.widget.setFactory("tracking.db.PhotoDescr",{create:()=>new pol.tracking.db.PhotoDescr})})();